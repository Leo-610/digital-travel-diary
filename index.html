<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; img-src 'self' data: blob: https: https://webst01.is.autonavi.com https://webst02.is.autonavi.com https://webst03.is.autonavi.com https://webst04.is.autonavi.com https://webrd01.is.autonavi.com https://webrd02.is.autonavi.com https://webrd03.is.autonavi.com https://webrd04.is.autonavi.com https://t0.tianditu.gov.cn https://t1.tianditu.gov.cn https://t2.tianditu.gov.cn https://t3.tianditu.gov.cn https://t4.tianditu.gov.cn https://t5.tianditu.gov.cn https://t6.tianditu.gov.cn https://t7.tianditu.gov.cn https://tile-a.openstreetmap.fr https://tile-b.openstreetmap.fr https://tile-c.openstreetmap.fr https://a.basemaps.cartocdn.com https://b.basemaps.cartocdn.com https://c.basemaps.cartocdn.com https://d.basemaps.cartocdn.com https://*.supabase.co; connect-src 'self' https://restapi.amap.com https://api.map.baidu.com https://nominatim.openstreetmap.org https://geocode.maps.co https://api.opencagedata.com https://places.googleapis.com https://*.supabase.co; frame-ancestors 'none'; object-src 'none'; base-uri 'self';">
    <title>数字旅行记忆馆</title>
    <!-- Leaflet地图库 -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Supabase客户端 -->
    <script src="supabase-client.js"></script>
    <style>
        /* ========== 动画关键帧 ========== */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }
        
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
            }
            50% {
                box-shadow: 0 8px 25px rgba(37, 99, 235, 0.8);
            }
        }
        
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        
        @keyframes gradient {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        
        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @keyframes shimmerTop {
            0%, 100% {
                opacity: 0;
                transform: translateX(-100%);
            }
            50% {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* 夜空专用动画 */
        @keyframes twinkle {
            0%, 100% { 
                opacity: 0.4;
                transform: scale(1) rotate(0deg);
            }
            25% { 
                opacity: 1;
                transform: scale(1.2) rotate(90deg);
            }
            50% { 
                opacity: 0.6;
                transform: scale(0.8) rotate(180deg);
            }
            75% { 
                opacity: 1;
                transform: scale(1.1) rotate(270deg);
            }
        }

        @keyframes titleGlow {
            0%, 100% { 
                text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
                filter: brightness(1);
            }
            50% { 
                text-shadow: 0 0 50px rgba(255, 255, 255, 0.6);
                filter: brightness(1.2);
            }
        }

        @keyframes nightSkyPulse {
            0%, 100% { 
                box-shadow: 
                    0 25px 50px rgba(0, 0, 0, 0.5),
                    0 0 0 1px rgba(255, 255, 255, 0.1),
                    inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }
            50% { 
                box-shadow: 
                    0 25px 50px rgba(0, 0, 0, 0.5),
                    0 0 0 1px rgba(255, 255, 255, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.2),
                    0 0 30px rgba(255, 255, 255, 0.1);
            }
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }
        
        @keyframes slideProgress {
            from { transform: scaleX(0); }
            to { transform: scaleX(1); }
        }
        
        /* ========== 页面加载器 ========== */
        .page-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-size: 400% 400%;
            animation: gradient 3s ease infinite;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
        }
        
        .page-loader.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        
        .loader-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: float 2s ease-in-out infinite;
        }
        
        .loader-text {
            color: white;
            font-size: 1.2rem;
            font-weight: 500;
            margin-bottom: 30px;
            animation: pulse 2s ease-in-out infinite;
        }
        
        .loading-bar {
            width: 200px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }
        
        .loading-progress {
            height: 100%;
            background: linear-gradient(90deg, #fff, #a8e6cf);
            border-radius: 2px;
            width: 100%;
            transform: scaleX(0);
            transform-origin: left;
            animation: slideProgress 2s ease-out forwards;
        }
        
        /* ========== 页面进入动画 ========== */
        .animate-in {
            animation: fadeInUp 0.8s ease-out;
        }
        
        .animate-in-delayed {
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }
        
        .animate-slide-left {
            animation: slideInLeft 0.8s ease-out;
        }
        
        .animate-slide-right {
            animation: slideInRight 0.8s ease-out;
        }
        
        /* ========== 增强的交互效果 ========== */
        .hover-lift {
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }
        
        .hover-lift:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
        }
        
        .shimmer-effect {
            position: relative;
            overflow: hidden;
        }
        
        .shimmer-effect::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            animation: shimmer 2s infinite;
        }
        
        /* ========== 基础样式 ========== */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: radial-gradient(ellipse at bottom, #1e3c72 0%, #2a5298 50%, #0f0f23 100%);
            background-attachment: fixed;
            color: #e2e8f0;
            line-height: 1.6;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* 深邃星空背景 */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #fff, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 160px 30px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 200px 60px, #fff, transparent),
                radial-gradient(2px 2px at 240px 90px, rgba(255,255,255,0.7), transparent),
                radial-gradient(1px 1px at 280px 120px, #fff, transparent),
                radial-gradient(1px 1px at 320px 20px, rgba(255,255,255,0.8), transparent),
                radial-gradient(2px 2px at 50px 140px, #fff, transparent),
                radial-gradient(1px 1px at 100px 160px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 150px 180px, #fff, transparent);
            background-repeat: repeat;
            background-size: 350px 200px;
            animation: starfield 120s linear infinite;
            opacity: 0.9;
            z-index: -3;
            pointer-events: none;
        }

        /* 闪烁星星 */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(1px 1px at 100px 50px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 200px 100px, rgba(255,255,255,0.6), transparent),
                radial-gradient(1px 1px at 300px 150px, rgba(255,255,255,0.9), transparent),
                radial-gradient(1px 1px at 50px 200px, rgba(255,255,255,0.7), transparent);
            background-repeat: repeat;
            background-size: 400px 250px;
            animation: twinkleStars 3s ease-in-out infinite alternate;
            opacity: 0.8;
            z-index: -2;
            pointer-events: none;
        }

        @keyframes starfield {
            from { transform: translateX(0) translateY(0); }
            to { transform: translateX(-350px) translateY(-100px); }
        }

        @keyframes twinkleStars {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.3);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow: 
                0 25px 50px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            animation: nightSkyPulse 8s ease-in-out infinite;
            min-height: 600px; /* 添加最小高度 */
            display: flex; /* 使用 flex 布局 */
            flex-direction: column; /* 垂直排列 */
        }

        /* 容器内的星光效果 */
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.6) 20%, 
                rgba(255, 255, 255, 0.8) 50%, 
                rgba(255, 255, 255, 0.6) 80%, 
                transparent 100%);
            animation: shimmerTop 4s ease-in-out infinite;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px 0;
            border-bottom: 2px solid rgba(100, 116, 139, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, 
                #ffffff 0%, 
                #c7d8ff 25%, 
                #9bb3ff 50%, 
                #6b8cff 75%, 
                #8e9aff 100%);
            background-size: 200% 200%;
            animation: gradient 8s ease infinite;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            position: relative;
            z-index: 1;
            text-shadow: 0 0 30px rgba(255, 255, 255, 0.3);
            letter-spacing: 1px;
        }
        
        /* 标题星光装饰 */
        .header h1::after {
            content: '✦';
            position: absolute;
            right: -30px;
            top: 0;
            color: rgba(255, 255, 255, 0.7);
            font-size: 1.2rem;
            animation: twinkle 4s ease-in-out infinite;
        }
        
        .header p {
            color: #64748b;
            margin: 10px 0 0 0;
            position: relative;
            z-index: 1;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }
        
        /* 导航栏样式 */
        .nav-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            padding: 0;
        }
        
        .nav-tab {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 24px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
            -webkit-backdrop-filter: blur(10px);
            backdrop-filter: blur(10px);
        }

        .nav-tab::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.6s;
        }

        .nav-tab:hover::before {
            left: 100%;
        }

        .nav-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
            color: #ffffff;
            background: rgba(255, 255, 255, 0.08);
        }
        

        
        .nav-tab.active {
            background: linear-gradient(135deg, #ff6b9d, #64ffda, #ffd93d, #6bcf7f);
            background-size: 300% 300%;
            border-color: rgba(100, 255, 218, 0.8);
            color: white;
            box-shadow: 
                0 8px 25px rgba(100, 255, 218, 0.4),
                0 0 20px rgba(255, 107, 157, 0.3);
            animation: rainbow 3s ease infinite, twinkle 2s ease-in-out infinite;
        }
        
        /* 视图容器 */
        .view {
            display: none;
            min-height: 500px;  /* 添加最小高度 */
            padding-bottom: 20px;  /* 添加底部间距 */
        }
        
        .view.active {
            display: block;
        }
        
        /* 地图容器样式 */
        .map-container {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border: 1px solid #e2e8f0;
            margin-top: 20px;
        }
        
        #map {
            height: 500px;
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .map-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .map-control-btn {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            color: #64748b;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .map-control-btn:hover {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .map-control-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .entry-card {
            background: rgba(255, 255, 255, 0.12);
            -webkit-backdrop-filter: blur(15px);
            backdrop-filter: blur(15px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 
                0 8px 32px rgba(0,0,0,0.3),
                0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 0 20px rgba(255, 220, 160, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            transform: translateY(20px);
            opacity: 0;
            animation: fadeInUp 0.6s ease-out forwards;
        }

        /* 温暖的内部光效 */
        .entry-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 20%, 
                rgba(255, 240, 200, 0.08) 0%, 
                rgba(255, 220, 160, 0.05) 30%, 
                transparent 70%);
            pointer-events: none;
            z-index: 1;
        }

        .entry-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                rgba(255, 215, 130, 0.8) 0%, 
                rgba(255, 240, 200, 0.9) 25%, 
                rgba(255, 255, 220, 1) 50%, 
                rgba(255, 240, 200, 0.9) 75%, 
                rgba(255, 215, 130, 0.8) 100%);
            background-size: 200% 100%;
            animation: warmGlow 6s ease-in-out infinite;
            opacity: 0.7;
            transition: opacity 0.3s ease;
        }

        .entry-card:hover::before {
            opacity: 1;
        }

        .entry-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0,0,0,0.4),
                0 0 30px rgba(255, 220, 160, 0.4),
                0 0 60px rgba(255, 240, 200, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 220, 160, 0.6);
            background: rgba(255, 255, 255, 0.15);
        }

        /* 温暖光晕动画 */
        @keyframes warmGlow {
            0%, 100% { 
                background-position: 0% 50%;
                filter: brightness(1);
            }
            50% { 
                background-position: 100% 50%;
                filter: brightness(1.3);
            }
        }
        
        
        .entry-card:nth-child(even) {
            animation-delay: 0.1s;
        }
        
        .entry-card:nth-child(3n) {
            animation-delay: 0.2s;
        }
        
        .entry-card h3 {
            margin: 0 0 12px 0;
            color: #ffffff;
            font-size: 1.25rem;
            font-weight: 600;
            position: relative;
            z-index: 2;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .entry-meta {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.875rem;
            margin-bottom: 12px;
            font-weight: 500;
            position: relative;
            z-index: 2;
        }
        
        .entry-content {
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
            margin-bottom: 16px;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .entry-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            position: relative;
            z-index: 2;
        }
        
        .tag {
            background: rgba(255, 240, 200, 0.2);
            color: #fff3cd;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
            border: 1px solid rgba(255, 220, 160, 0.3);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(255, 220, 160, 0.1);
        }

        /* 操作按钮容器 */
        .entry-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 3;
            opacity: 0;
            transform: translateY(-8px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* 卡片悬停时显示操作按钮 */
        .entry-card:hover .entry-actions {
            opacity: 1;
            transform: translateY(0);
        }

        /* 作者信息样式 */
        .entry-author {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .author-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .author-name {
            font-weight: 500;
        }

        /* 按钮基础样式 */
        .action-btn {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.25s cubic-bezier(0.25, 0.8, 0.25, 1);
            backdrop-filter: blur(12px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            /* 确保所有按钮垂直对齐 */
            vertical-align: top;
            flex-shrink: 0;
        }

        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s;
        }

        .action-btn:hover::before {
            left: 100%;
        }

        /* 收藏按钮样式 */
        .favorite-btn {
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.2);
        }

        .favorite-btn:hover {
            background: rgba(245, 158, 11, 0.1);
            border-color: rgba(245, 158, 11, 0.4);
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }

        .favorite-btn.favorited {
            background: rgba(245, 158, 11, 0.15);
            border-color: rgba(245, 158, 11, 0.5);
            color: #d97706;
        }

        .favorite-btn.favorited:hover {
            background: rgba(245, 158, 11, 0.2);
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        /* 编辑按钮样式 */
        .edit-btn {
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.2);
        }

        .edit-btn:hover {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.4);
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        /* 删除按钮样式 */
        .delete-btn {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.2);
        }

        .delete-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.4);
            transform: scale(1.05) translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
        }

        .delete-btn:active {
            transform: scale(0.95);
        }

        /* 按钮分组样式 */
        .entry-actions .action-btn:first-child {
            border-top-right-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        .entry-actions .action-btn:last-child {
            border-top-left-radius: 4px;
            border-bottom-left-radius: 4px;
            margin-left: 4px;
            position: relative;
        }

        .entry-actions .action-btn:last-child::after {
            content: '';
            position: absolute;
            left: -2px;
            top: 20%;
            height: 60%;
            width: 1px;
            background: rgba(0, 0, 0, 0.1);
        }

        /* 删除确认对话框样式 */
        .delete-confirmation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            z-index: 10001;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.25),
                0 0 0 1px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            text-align: center;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .delete-confirmation h3 {
            margin: 0 0 16px 0;
            color: #dc2626;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .delete-confirmation p {
            margin: 0 0 24px 0;
            color: #374151;
            line-height: 1.5;
        }

        .delete-confirmation .buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .delete-confirmation .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 100px;
        }

        .delete-confirmation .btn-cancel {
            background: #f3f4f6;
            color: #374151;
        }

        .delete-confirmation .btn-cancel:hover {
            background: #e5e7eb;
        }

        .delete-confirmation .btn-delete {
            background: #dc2626;
            color: white;
        }

        .delete-confirmation .btn-delete:hover {
            background: #b91c1c;
        }
          .add-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 64px;
            height: 64px;
            background: linear-gradient(135deg, 
                rgba(255, 215, 130, 0.9) 0%, 
                rgba(255, 240, 200, 0.8) 50%, 
                rgba(255, 255, 220, 0.9) 100%);
            background-size: 300% 300%;
            animation: warmGlow 4s ease infinite;
            color: #8b4513;
            border: 2px solid rgba(255, 220, 160, 0.6);
            border-radius: 50%;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 
                0 8px 32px rgba(255, 220, 160, 0.4),
                0 0 20px rgba(255, 240, 200, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .add-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255,255,255,0.4), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .add-btn:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 
                0 15px 50px rgba(255, 220, 160, 0.6),
                0 0 40px rgba(255, 240, 200, 0.5),
                0 0 80px rgba(255, 255, 220, 0.3),
                inset 0 2px 0 rgba(255, 255, 255, 0.5);
            animation: warmGlow 2s ease infinite;
            border-color: rgba(255, 220, 160, 0.8);
        }

        .add-btn:hover::before {
            opacity: 1;
        }

        .add-btn:active {
            transform: scale(0.95);
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255, 255, 255, 0.8);
            background: rgba(255, 240, 200, 0.05);
            border-radius: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 220, 160, 0.1);
            box-shadow: 0 8px 32px rgba(255, 220, 160, 0.1);
        }
        
        .empty-state h3 {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
            font-size: 1.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        /* 模态框样式 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 9999;
            display: none;
        }
        
        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.95);
            -webkit-backdrop-filter: blur(20px);
            backdrop-filter: blur(20px);
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
            display: none;
            box-shadow: 
                0 25px 50px rgba(0,0,0,0.25),
                0 0 0 1px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .modal h2 {
            margin: 0 0 24px 0;
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 600;
        }
        
        .close-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.875rem;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }
        
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .form-group textarea {
            height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* 图片上传样式 */
        .image-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f9fafb;
            margin-bottom: 16px;
        }

        .image-upload-area:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #374151;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .upload-hint {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .image-preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .image-preview-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            background: #f3f4f6;
            aspect-ratio: 1;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .image-preview-item:hover {
            border-color: #3b82f6;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .image-remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .image-remove-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }

        /* 日记卡片中的图片样式 */
        .entry-images {
            margin: 16px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 8px;
            border-radius: 12px;
            overflow: hidden;
        }

        .entry-images.single {
            grid-template-columns: 1fr;
            max-height: 300px;
        }

        .entry-images.double {
            grid-template-columns: 1fr 1fr;
            max-height: 200px;
        }

        .entry-images.multiple {
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            max-height: 150px;
        }

        .entry-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 8px;
        }

        .entry-image:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        /* 图片查看器 */
        .image-viewer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10001;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .image-viewer img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            border-radius: 8px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }

        .image-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .image-viewer-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
          .save-btn {
            background: linear-gradient(135deg, #ff6b9d, #64ffda);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            width: 100%;
            margin-top: 16px;
            box-shadow: 
                0 8px 32px rgba(255, 107, 157, 0.3),
                0 0 20px rgba(100, 255, 218, 0.2);
            position: relative;
            overflow: hidden;
            align-self: stretch;
            flex-shrink: 0;
        }

        .save-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .save-btn:hover::before {
            left: 100%;
        }

        .save-btn:hover {
            background: linear-gradient(135deg, #64ffda, #ffd93d);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(255, 107, 157, 0.4),
                0 0 30px rgba(100, 255, 218, 0.3);
        }

        .save-btn:active {
            transform: translateY(0) scale(0.98);
        }
        
        /* GitHub 登录按钮样式 */
        .github-login-btn {
            background: #24292e;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 2px 8px rgba(36, 41, 46, 0.2);
        }
        
        .github-login-btn:hover {
            background: #1c2025;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(36, 41, 46, 0.3);
        }
        
        .github-login-btn:active {
            transform: translateY(0);
            background: #0d1117;
        }
        
        .github-login-btn svg {
            flex-shrink: 0;
        }
        
        .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.06);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.05), transparent);
            animation: shimmer 4s infinite;
        }
        
        .stat-item {
            text-align: center;
            position: relative;
            z-index: 1;
            transition: transform 0.3s ease;
        }
        
        .stat-item:hover {
            transform: scale(1.1);
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1e293b;
            display: block;
            animation: pulse 3s ease-in-out infinite;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .stat-label {
            font-size: 0.875rem;
            color: #374151;
            margin-top: 4px;
            font-weight: 500;
        }

        /* 页面切换特效 */
        .page-transition {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .page-transition.active {
            opacity: 1;
            visibility: visible;
        }

        .transition-content {
            text-align: center;
            color: white;
            transform: scale(0.8);
            transition: transform 0.6s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .page-transition.active .transition-content {
            transform: scale(1);
        }

        .transition-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        /* 星空粒子漂浮效果 */
        @keyframes starlight-float {
            0% {
                transform: translateY(0) translateX(0) scale(0.5);
                opacity: 0;
            }
            20% {
                opacity: 1;
                transform: translateY(-20px) translateX(10px) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translateY(-60px) translateX(-15px) scale(1.2);
            }
            80% {
                opacity: 0.6;
                transform: translateY(-120px) translateX(25px) scale(0.8);
            }
            100% {
                transform: translateY(-200px) translateX(-10px) scale(0.3);
                opacity: 0;
            }
        }

        /* 高级按钮动画 */
        .btn-enhanced {
            position: relative;
            overflow: hidden;
        }

        .btn-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s;
        }

        .btn-enhanced:hover::before {
            left: 100%;
        }

        .btn-enhanced:active {
            transform: scale(0.95);
        }

        /* 响应式设计 */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .entry-card {
                margin: 10px 0;
            }
            
            /* 移动端按钮优化 */
            .entry-actions {
                opacity: 1;
                transform: translateY(0);
                top: 8px;
                right: 8px;
                gap: 4px;
            }
            
            .action-btn {
                width: 32px;
                height: 32px;
                font-size: 12px;
            }
            
            /* 移动端总是显示操作按钮 */
            .entry-card .entry-actions {
                opacity: 1;
                transform: translateY(0);
            }
            
            .modal-content {
                width: 95%;
                margin: 20px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .nav-tab {
                padding: 8px 16px;
                font-size: 14px;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
                gap: 10px;
            }
            
            .stat-item {
                padding: 12px;
            }
        }

        /* 超小屏幕优化 */
        @media (max-width: 480px) {
            .entry-actions {
                top: 6px;
                right: 6px;
                gap: 2px;
            }
            
            .action-btn {
                width: 28px;
                height: 28px;
                font-size: 11px;
                border-radius: 6px;
            }
            
            .entry-actions .action-btn:first-child,
            .entry-actions .action-btn:last-child {
                border-radius: 6px;
            }
        }

        /* ========== 用户系统样式 ========== */
        .user-system {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            color: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .mode-toggle {
            display: flex;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 4px;
            margin-bottom: 15px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.7);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .mode-btn.active {
            background: rgba(255,255,255,0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .login-options {
            display: flex;
            gap: 10px;
        }

        .login-option-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .login-option-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 3px solid rgba(255,255,255,0.3);
            object-fit: cover;
        }

        .user-avatar-small {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            object-fit: cover;
        }

        .user-details {
            flex: 1;
        }

        .user-nickname {
            font-size: 1.2rem;
            font-weight: 600;
            display: block;
            margin-bottom: 5px;
        }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-action-btn {
            padding: 6px 12px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .user-action-btn:hover {
            background: rgba(255,255,255,0.25);
        }

        .cloud-features {
            display: flex;
            gap: 10px;
        }

        .cloud-feature-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .cloud-feature-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-2px);
        }

        /* 共享日记样式 */
        .shared-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .shared-header h2 {
            margin: 0 0 10px 0;
            color: #2563eb;
        }

        .shared-header p {
            color: #6b7280;
            margin: 0 0 20px 0;
        }

        .shared-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }

        .shared-control-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: white;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .shared-control-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .shared-sort {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            color: #374151;
        }

        .shared-diaries {
            max-height: 70vh !important;
            min-height: 200px !important;
            height: auto !important;
            overflow-y: auto !important;
            padding: 0 !important;
            box-sizing: border-box !important;
        }
        
        /* 强制修复：确保共享视图容器有高度 */
        #shared-view {
            min-height: 600px !important;
        }
        
        #shared-diaries-container {
            min-height: 300px !important;
            height: auto !important;
            display: block !important;
        }
        
        /* 修复main容器高度问题 */
        main {
            min-height: 500px !important;
            height: auto !important;
            flex: 1 !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        main .view {
            flex: 1 !important;
            min-height: 400px !important;
        }

        .user-diary-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .user-header h3 {
            margin: 0;
            flex: 1;
        }

        .diary-count {
            background: rgba(255,255,255,0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .user-entries {
            padding: 20px;
        }

        .shared-diary-entry {
            background: #f8fafc;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #3b82f6;
        }

        .entry-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 10px;
        }

        .entry-header h4 {
            margin: 0;
            color: #1f2937;
            flex: 1;
        }

        .entry-date {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
        }

        .entry-content p {
            margin: 10px 0;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
        }

        .entry-images {
            display: flex;
            gap: 10px;
            margin: 10px 0;
            flex-wrap: wrap;
        }

        .entry-image-thumb {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .entry-image-thumb:hover {
            transform: scale(1.1);
        }

        .entry-location {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #6b7280;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .loading-placeholder {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        /* 认证表单样式 */
        .auth-switch {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }

        .auth-switch a {
            color: #3b82f6;
            text-decoration: none;
            font-weight: 500;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        /* 头像上传样式 */
        .avatar-upload {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .avatar-preview {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #e5e7eb;
        }

        .upload-btn {
            padding: 8px 16px;
            border: 1px solid #e5e7eb;
            background: #f8fafc;
            color: #374151;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            background: #f1f5f9;
            border-color: #d1d5db;
        }
    </style>
</head>
<body>
    <!-- 页面加载器 -->
    <div id="page-loader" class="page-loader">
        <div class="loader-icon">🗺️</div>
        <div class="loader-text">数字旅行记忆馆正在启动...</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
    </div>

    <div class="container animate-in">
        <div class="header animate-in">
            <h1>🗺️ 数字旅行记忆馆</h1>
            <p>记录我的足迹，珍藏美好回忆</p>
        </div>

        <div id="stats" class="stats animate-in-delayed">
            <div class="stat-item">
                <span id="total-entries" class="stat-number">0</span>
                <div class="stat-label">总日记数</div>
            </div>
            <div class="stat-item">
                <span id="total-favorites" class="stat-number">0</span>
                <div class="stat-label">收藏数量</div>
            </div>
            <div class="stat-item">
                <span id="total-places" class="stat-number">0</span>
                <div class="stat-label">足迹地点</div>
            </div>
            <div class="stat-item">
                <span id="total-tags" class="stat-number">0</span>
                <div class="stat-label">标签数量</div>
            </div>
            <div class="stat-item" onclick="showStorageManagement()" style="cursor: pointer;" title="点击查看存储详情">
                <span id="storage-usage" class="stat-number">0KB</span>
                <div class="stat-label">存储使用</div>
            </div>
        </div>

        <!-- 用户系统界面 -->
        <div class="user-system animate-in-delayed">
            <!-- 未登录状态 -->
            <div id="login-section" class="login-section">
                <div class="mode-toggle">
                    <button class="mode-btn active" data-mode="local">📱 本地模式</button>
                    <button class="mode-btn" data-mode="cloud">☁️ 云端模式</button>
                </div>
                <div id="cloud-login" class="cloud-login" style="display: none;">
                    <div class="login-options">
                        <button id="show-login-btn" class="login-option-btn">🔑 登录</button>
                        <button id="show-register-btn" class="login-option-btn">📝 注册</button>
                    </div>
                </div>
            </div>

            <!-- 已登录状态 -->
            <div id="user-section" class="user-section" style="display: none;">
                <div class="user-info">
                    <img id="user-avatar" src="./default-avatar.svg" alt="头像" class="user-avatar">
                    <div class="user-details">
                        <span id="user-nickname" class="user-nickname">用户昵称</span>
                        <div class="user-actions">
                            <button id="edit-profile-btn" class="user-action-btn">✏️ 编辑资料</button>
                            <button id="logout-btn" class="user-action-btn">🚪 登出</button>
                        </div>
                    </div>
                </div>
                <div class="cloud-features">
                    <button id="sync-data-btn" class="cloud-feature-btn">🔄 同步数据</button>
                    <button id="view-shared-btn" class="cloud-feature-btn">👥 查看共享</button>
                </div>
            </div>
        </div>

        <!-- 导航栏 -->
        <nav class="nav-tabs animate-slide-left">
            <button class="nav-tab active" data-view="gallery">
                📚 日记画廊
            </button>
            <button class="nav-tab" data-view="favorites">
                ⭐ 我的收藏
            </button>
            <button class="nav-tab" data-view="map">
                🗺️ 足迹地图
            </button>
            <button class="nav-tab cloud-feature" data-view="shared" style="display: none;">
                👥 共享日记
            </button>
        </nav>

        <main class="animate-slide-right">
            <!-- 日记画廊视图 -->
            <div id="gallery-view" class="view active">
                <div id="gallery" class="gallery">
                    <!-- 日记条目将在这里动态显示 -->
                </div>
                <div id="empty-state" class="empty-state" style="display: none;">
                    <h3>📝 还没有记录呢</h3>
                    <p>点击右下角的 + 按钮，开始记录你的第一段旅程吧！</p>
                </div>
            </div>

            <!-- 收藏视图 -->
            <div id="favorites-view" class="view">
                <div id="favorites-gallery" class="gallery">
                    <!-- 收藏的日记条目将在这里动态显示 -->
                </div>
                <div id="favorites-empty-state" class="empty-state" style="display: none;">
                    <h3>⭐ 还没有收藏呢</h3>
                    <p>在日记画廊中点击心形图标来收藏您喜欢的旅行记忆吧！</p>
                </div>
            </div>

            <!-- 地图视图 -->
            <div id="map-view" class="view">
                <div class="map-container">
                    <div class="map-controls">
                        <button class="map-control-btn active" data-layer="all">🌍 显示全部</button>
                        <button class="map-control-btn" data-layer="recent">⏰ 最近的</button>
                        <button class="map-control-btn" data-layer="favorites">⭐ 收藏的</button>
                        <button class="map-control-btn" id="locate-btn">📍 定位到我</button>
                    </div>
                    <div id="map"></div>
                </div>
            </div>

            <!-- 共享日记视图 -->
            <div id="shared-view" class="view" style="display: none;">
                <div class="shared-header">
                    <h2>👥 共享日记</h2>
                    <p>查看所有用户的旅行记忆</p>
                    <div class="shared-controls">
                        <button id="refresh-shared-btn" class="shared-control-btn">🔄 刷新</button>
                        <select id="shared-sort" class="shared-sort">
                            <option value="newest">最新的</option>
                            <option value="oldest">最早的</option>
                            <option value="user">按用户</option>
                        </select>
                    </div>
                </div>
                <div id="shared-diaries-container" class="shared-diaries">
                    <div class="loading-placeholder">
                        <div class="loading-spinner">🔄</div>
                        <p>正在加载共享日记...</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 新建按钮 -->
    <button id="add-entry-btn" class="add-btn" title="新建日记">+</button>

    <!-- 图片查看器 -->
    <div id="image-viewer" class="image-viewer">
        <button class="image-viewer-close" onclick="closeImageViewer()">&times;</button>
        <img id="viewer-image" src="" alt="查看图片">
    </div>

    <!-- 删除确认对话框 -->
    <div id="delete-backdrop" class="modal-backdrop" style="display: none; opacity: 0; transition: opacity 0.3s ease;"></div>
    <div id="delete-confirmation" class="delete-confirmation" style="display: none;">
        <h3>🗑️ 确认删除</h3>
        <p id="delete-message">您确定要删除这篇日记吗？删除后将无法恢复。</p>
        <div class="buttons">
            <button class="btn btn-cancel" onclick="cancelDeleteEntry()">取消</button>
            <button class="btn btn-delete" onclick="executeDeleteEntry()">确认删除</button>
        </div>
    </div>

    <!-- 模态框 -->
    <div id="modal-backdrop" class="modal-backdrop"></div>
    <div id="modal" class="modal">
        <button id="close-modal-btn" class="close-btn">&times;</button>
        <h2 id="modal-title">✨ 新建旅行日记</h2>
        <form id="entry-form">
            <div class="form-group">
                <label for="title">📝 标题</label>
                <input type="text" id="title" name="title" placeholder="给这次旅行起个好听的名字..." required>
            </div>
            
            <div class="form-group">
                <label for="date">📅 日期</label>
                <input type="date" id="date" name="date" required>
            </div>
            
            <div class="form-group">
                <label for="location">📍 地点</label>
                <input type="text" id="location" name="location" placeholder="城市、景点或建筑名称（如：故宫、东方明珠）" required>
                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px; padding: 4px 8px; background: #f8fafc; border-radius: 4px;">
                    💡 支持搜索：著名建筑（故宫、东方明珠）、景点（西湖、九寨沟）、大学（北大、清华）、机场、高铁站等
                </div>
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button type="button" id="search-location-btn" style="flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">🔍 搜索建筑/景点</button>
                    <button type="button" id="manual-location-btn" style="flex: 1; background: #f8fafc; border: 1px solid #e2e8f0; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.875rem;">� 手动添加</button>
                </div>
                <div id="location-results" style="display: none; margin-top: 8px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; max-height: 200px; overflow-y: auto;"></div>
                <div id="manual-coords" style="display: none; margin-top: 8px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 8px;">手动输入经纬度坐标（可选）：</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="number" id="manual-lat" placeholder="纬度 (如: 39.9042)" step="any" style="flex: 1; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                        <input type="number" id="manual-lon" placeholder="经度 (如: 116.4074)" step="any" style="flex: 1; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.875rem;">
                        <button type="button" id="confirm-manual-coords" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">确认</button>
                    </div>
                    <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">💡 提示：可以使用地图应用获取准确的经纬度坐标</div>
                </div>
            </div>
            
            <div class="form-group" style="display: none;">
                <label for="latitude">纬度</label>
                <input type="number" id="latitude" name="latitude" step="any" readonly>
            </div>
            
            <div class="form-group" style="display: none;">
                <label for="longitude">经度</label>
                <input type="number" id="longitude" name="longitude" step="any" readonly>
            </div>
            
            <div class="form-group">
                <label for="tags">🏷️ 标签</label>
                <input type="text" id="tags" name="tags" placeholder="美食, 风景, 朋友 (用逗号分隔)" required>
            </div>
            
            <div class="form-group">
                <label for="images">📷 图片</label>
                <input type="file" id="images" name="images" multiple accept="image/*" style="display: none;">
                <div class="image-upload-area" onclick="document.getElementById('images').click()">
                    <div class="upload-icon">📷</div>
                    <div class="upload-text">点击选择图片</div>
                    <div class="upload-hint">自动压缩至1200x800，最多8张图片</div>
                </div>
                <div id="image-preview" class="image-preview-container"></div>
            </div>
            
            <div class="form-group">
                <label for="content">📖 内容</label>
                <textarea id="content" name="content" placeholder="分享你的旅行故事..." required oninput="updateCharCount()"></textarea>
                <div id="char-count" style="font-size: 0.75rem; color: #6b7280; margin-top: 4px; text-align: right;">
                    0 / 15000 字 (建议不超过5000字)
                </div>
            </div>
            
            <button type="submit" class="save-btn" id="save-btn">💾 保存日记</button>
        </form>
    </div>

    <!-- 登录模态框 -->
    <div id="login-modal-backdrop" class="modal-backdrop" style="display: none;"></div>
    <div id="login-modal" class="modal" style="display: none;">
        <button id="close-login-modal-btn" class="close-btn">&times;</button>
        <h2>🔑 用户登录</h2>
        <form id="login-form">
            <div class="form-group">
                <label for="login-email">📧 邮箱</label>
                <input type="email" id="login-email" name="email" placeholder="请输入您的邮箱地址" required>
            </div>
            <div class="form-group">
                <label for="login-password">🔒 密码</label>
                <input type="password" id="login-password" name="password" placeholder="请输入密码" required>
            </div>
            <button type="submit" class="save-btn">🔑 登录</button>
            
            <!-- 分隔线 -->
            <div style="margin: 20px 0; text-align: center; position: relative;">
                <div style="height: 1px; background: #e0e0e0; width: 100%;"></div>
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 15px; color: #666; font-size: 14px;">或</span>
            </div>
            
            <!-- GitHub 登录按钮 -->
            <button type="button" id="github-login-btn" class="github-login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                使用 GitHub 登录
            </button>
            
            <div class="auth-switch">
                <p>还没有账号？ <a href="#" id="switch-to-register">立即注册</a></p>
            </div>
        </form>
    </div>

    <!-- 注册模态框 -->
    <div id="register-modal-backdrop" class="modal-backdrop" style="display: none;"></div>
    <div id="register-modal" class="modal" style="display: none;">
        <button id="close-register-modal-btn" class="close-btn">&times;</button>
        <h2>📝 用户注册</h2>
        <form id="register-form">
            <div class="form-group">
                <label for="register-email">📧 邮箱</label>
                <input type="email" id="register-email" name="email" placeholder="请输入您的邮箱地址" required>
            </div>
            <div class="form-group">
                <label for="register-password">🔒 密码</label>
                <input type="password" id="register-password" name="password" placeholder="请输入密码（至少6位）" required minlength="6">
            </div>
            <div class="form-group">
                <label for="register-nickname">👤 昵称</label>
                <input type="text" id="register-nickname" name="nickname" placeholder="请输入您的昵称" required>
            </div>
            <button type="submit" class="save-btn">📝 注册</button>
            
            <!-- 分隔线 -->
            <div style="margin: 20px 0; text-align: center; position: relative;">
                <div style="height: 1px; background: #e0e0e0; width: 100%;"></div>
                <span style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: white; padding: 0 15px; color: #666; font-size: 14px;">或</span>
            </div>
            
            <!-- GitHub 登录按钮 -->
            <button type="button" id="github-register-btn" class="github-login-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                </svg>
                使用 GitHub 注册
            </button>
            
            <div class="auth-switch">
                <p>已有账号？ <a href="#" id="switch-to-login">立即登录</a></p>
            </div>
        </form>
    </div>

    <!-- 编辑资料模态框 -->
    <div id="profile-modal-backdrop" class="modal-backdrop" style="display: none;"></div>
    <div id="profile-modal" class="modal" style="display: none;">
        <button id="close-profile-modal-btn" class="close-btn">&times;</button>
        <h2>✏️ 编辑资料</h2>
        <form id="profile-form">
            <div class="form-group">
                <label for="profile-avatar">📷 头像</label>
                <div class="avatar-upload">
                    <img id="profile-avatar-preview" src="./default-avatar.svg" alt="头像预览" class="avatar-preview">
                    <input type="file" id="profile-avatar-input" accept="image/*" style="display: none;">
                    <button type="button" id="upload-avatar-btn" class="upload-btn">选择头像</button>
                </div>
            </div>
            <div class="form-group">
                <label for="profile-nickname">👤 昵称</label>
                <input type="text" id="profile-nickname" name="nickname" placeholder="请输入您的昵称" required>
            </div>
            <div class="form-group">
                <label for="profile-bio">📝 个人简介</label>
                <textarea id="profile-bio" name="bio" placeholder="介绍一下自己吧..." rows="3"></textarea>
            </div>
            <button type="submit" class="save-btn">💾 保存资料</button>
        </form>
    </div>
    
    <script>
        console.log('🚀 数字旅行记忆馆启动中...');
        
        // 全局变量
        let map = null;
        let markersLayer = null;
        let currentView = 'gallery';
        let currentMode = 'local'; // 'local' 或 'cloud'
        let isLoggedIn = false;
        let db = null; // IndexedDB 数据库连接
        let useIndexedDB = true; // 是否使用 IndexedDB 大容量存储
        
        // 同步认证状态的辅助函数
        function syncAuthState() {
            const wasLoggedIn = isLoggedIn;
            if (window.supabaseClient && window.supabaseClient.isLoggedIn()) {
                isLoggedIn = true;
                if (!wasLoggedIn) {
                    console.log('🔄 同步认证状态: 已登录');
                    // 如果状态发生了变化，重新加载当前视图
                    if (currentView === 'gallery') {
                        loadEntries();
                    }
                }
            } else {
                isLoggedIn = false;
                if (wasLoggedIn) {
                    console.log('🔄 同步认证状态: 未登录');
                }
            }
        }
        
        // 使辅助函数全局可访问
        window.syncAuthState = syncAuthState;
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ 页面加载完成');
            
            // 立即隐藏加载器并初始化应用
            setTimeout(() => {
                initApp();
                hidePageLoader();
            }, 500);
        });
        
        // 通知提示函数
        function showNotification(message, type = 'info') {
            // 移除已存在的通知
            const existingNotifications = document.querySelectorAll('.app-notification');
            existingNotifications.forEach(notification => {
                notification.remove();
            });
            
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `app-notification notification-${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <span class="notification-icon">
                        ${type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : 'ℹ️'}
                    </span>
                    <span class="notification-message">${message}</span>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">×</button>
                </div>
            `;
            
            // 添加样式
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    .app-notification {
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        min-width: 300px;
                        max-width: 500px;
                        padding: 0;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                        animation: slideInRight 0.3s ease-out;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    }
                    .notification-content {
                        display: flex;
                        align-items: center;
                        gap: 12px;
                        padding: 16px;
                        border-radius: 8px;
                    }
                    .notification-success .notification-content {
                        background: linear-gradient(135deg, #10b981, #059669);
                        color: white;
                    }
                    .notification-error .notification-content {
                        background: linear-gradient(135deg, #ef4444, #dc2626);
                        color: white;
                    }
                    .notification-warning .notification-content {
                        background: linear-gradient(135deg, #f59e0b, #d97706);
                        color: white;
                    }
                    .notification-info .notification-content {
                        background: linear-gradient(135deg, #3b82f6, #2563eb);
                        color: white;
                    }
                    .notification-icon {
                        font-size: 18px;
                        flex-shrink: 0;
                    }
                    .notification-message {
                        flex: 1;
                        font-weight: 500;
                    }
                    .notification-close {
                        background: none;
                        border: none;
                        color: white;
                        font-size: 20px;
                        cursor: pointer;
                        padding: 0;
                        width: 24px;
                        height: 24px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        border-radius: 50%;
                        transition: background-color 0.2s;
                        flex-shrink: 0;
                    }
                    .notification-close:hover {
                        background-color: rgba(255, 255, 255, 0.2);
                    }
                    @keyframes slideInRight {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                    @media (max-width: 640px) {
                        .app-notification {
                            top: 10px;
                            left: 10px;
                            right: 10px;
                            min-width: auto;
                            max-width: none;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 添加到页面
            document.body.appendChild(notification);
            
            // 自动消失
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideInRight 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }
            }, 4000);
        }
        
        function hidePageLoader() {
            console.log('🔄 正在隐藏页面加载器...');
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.classList.add('fade-out');
                console.log('✅ 页面加载器隐藏动画已启动');
                setTimeout(() => {
                    loader.remove();
                    console.log('✅ 页面加载器已移除');
                }, 800);
            } else {
                console.log('⚠️ 找不到页面加载器元素');
            }
        }

        // 清理localStorage中的旧数据
        function cleanLocalStorageData() {
            try {
                const entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                const cleanedEntries = entries.map(entry => {
                    // 保留有效字段，移除无效字段
                    return {
                        id: entry.id,
                        created_at: entry.created_at || entry.created, // 统一使用created_at
                        date: entry.date || (entry.created_at || entry.created)?.split('T')[0], // 保留或推导用户日期
                        title: entry.title,
                        location: entry.location,
                        content: entry.content,
                        tags: entry.tags,
                        latitude: entry.latitude,
                        longitude: entry.longitude,
                        images: entry.images,
                        weather: entry.weather,
                        mood: entry.mood,
                        updated_at: entry.updated_at
                        // 移除 created, favorited 等字段
                    };
                });
                
                localStorage.setItem('travelDiary', JSON.stringify(cleanedEntries));
                console.log('✅ 已清理localStorage数据');
            } catch (error) {
                console.error('❌ 清理localStorage数据失败:', error);
            }
        }

        // 在应用启动时清理数据
        function initApp() {
            console.log('🔧 初始化应用...');
            
            // 初始化大容量存储
            initLargeStorage();
            
            // 清理旧数据
            cleanLocalStorageData();            // 初始化用户系统
            initUserSystem();
            
            // 绑定事件
            bindEvents();
            
            // 初始化地图
            initMap();
            
            // 加载数据
            loadEntries();
            
            // 更新统计
            updateStats();
            
            console.log('✅ 应用初始化完成');
        }

        // ========== IndexedDB 大容量存储系统 ==========
        
        // 初始化大容量存储
        async function initLargeStorage() {
            console.log('🗄️ 初始化大容量存储系统...');
            
            // 检查 IndexedDB 支持
            if (!window.indexedDB) {
                console.warn('⚠️ 浏览器不支持 IndexedDB，将使用 localStorage（存储空间有限）');
                useIndexedDB = false;
                return;
            }
            
            try {
                db = await openIndexedDB();
                console.log('✅ IndexedDB 初始化成功，支持大容量存储（~100MB）');
                
                // 尝试从 localStorage 迁移数据到 IndexedDB
                await migrateFromLocalStorage();
                
            } catch (error) {
                console.error('❌ IndexedDB 初始化失败，回退到 localStorage:', error);
                useIndexedDB = false;
            }
        }
        
        // 打开 IndexedDB 数据库
        function openIndexedDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TravelDiaryDB', 1);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => resolve(request.result);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    
                    // 创建日记存储仓库
                    if (!db.objectStoreNames.contains('diaries')) {
                        const diaryStore = db.createObjectStore('diaries', { keyPath: 'id' });
                        diaryStore.createIndex('created_at', 'created_at', { unique: false });
                        diaryStore.createIndex('location', 'location', { unique: false });
                    }
                    
                    // 创建设置存储仓库
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'key' });
                    }
                };
            });
        }
        
        // 从 localStorage 迁移数据到 IndexedDB
        async function migrateFromLocalStorage() {
            try {
                const localData = localStorage.getItem('travelDiary');
                if (!localData) return;
                
                const entries = JSON.parse(localData);
                if (entries.length === 0) return;
                
                console.log(`🔄 开始迁移 ${entries.length} 条数据到大容量存储...`);
                
                // 保存到 IndexedDB
                await saveToIndexedDB('diaries', entries);
                
                // 迁移成功后，清理 localStorage（可选）
                const confirmMigration = confirm(`✅ 已成功迁移 ${entries.length} 条日记到大容量存储系统！\n\n现在支持存储更多照片和内容。\n\n是否清理旧的存储数据以释放空间？`);
                if (confirmMigration) {
                    localStorage.removeItem('travelDiary');
                    console.log('🗑️ 已清理旧存储数据');
                }
                
            } catch (error) {
                console.error('❌ 数据迁移失败:', error);
            }
        }
        
        // 保存数据到 IndexedDB
        function saveToIndexedDB(storeName, data) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB 未初始化'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                
                transaction.oncomplete = () => resolve();
                transaction.onerror = () => reject(transaction.error);
                
                if (Array.isArray(data)) {
                    // 批量保存
                    data.forEach(item => store.put(item));
                } else {
                    // 单个保存
                    store.put(data);
                }
            });
        }
        
        // 从 IndexedDB 读取数据
        function getFromIndexedDB(storeName, key = null) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB 未初始化'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                
                if (key) {
                    // 获取单个数据
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                } else {
                    // 获取所有数据
                    const request = store.getAll();
                    request.onsuccess = () => resolve(request.result || []);
                    request.onerror = () => reject(request.error);
                }
            });
        }
        
        // 从 IndexedDB 删除数据
        function deleteFromIndexedDB(storeName, key) {
            return new Promise((resolve, reject) => {
                if (!db) {
                    reject(new Error('IndexedDB 未初始化'));
                    return;
                }
                
                const transaction = db.transaction([storeName], 'readwrite');
                const store = transaction.objectStore(storeName);
                const request = store.delete(key);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        // 获取 IndexedDB 存储使用情况
        async function getIndexedDBStorageSize() {
            if (!useIndexedDB || !db) return 0;
            
            try {
                const entries = await getFromIndexedDB('diaries');
                return JSON.stringify(entries).length * 2; // 估算字节数
            } catch (error) {
                console.error('获取存储大小失败:', error);
                return 0;
            }
        }
        
        function bindEvents() {
            console.log('🔗 绑定事件...');
            
            const addBtn = document.getElementById('add-entry-btn');
            const modal = document.getElementById('modal');
            const backdrop = document.getElementById('modal-backdrop');
            const form = document.getElementById('entry-form');
            const closeBtn = document.getElementById('close-modal-btn');
            
            // 导航切换
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    switchView(this.dataset.view);
                });
            });
            
            // 地图控制按钮
            document.querySelectorAll('.map-control-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (this.id === 'locate-btn') {
                        locateUser();
                    } else {
                        filterMapMarkers(this.dataset.layer);
                        document.querySelectorAll('.map-control-btn').forEach(b => b.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });
            
            // 位置搜索
            const searchBtn = document.getElementById('search-location-btn');
            const manualBtn = document.getElementById('manual-location-btn');
            const confirmCoordsBtn = document.getElementById('confirm-manual-coords');
            const locationInput = document.getElementById('location');
            
            if (searchBtn) {
                searchBtn.addEventListener('click', function() {
                    if (locationInput.value.trim()) {
                        searchLocation();
                    } else {
                        alert('请先输入地点名称');
                        locationInput.focus();
                    }
                });
            }
            
            if (manualBtn) {
                manualBtn.addEventListener('click', function() {
                    toggleManualCoords();
                });
            }
            
            if (confirmCoordsBtn) {
                confirmCoordsBtn.addEventListener('click', function() {
                    confirmManualCoords();
                });
            }
            
            if (locationInput) {
                locationInput.addEventListener('input', function() {
                    if (this.value.length > 2) {
                        // 自动搜索本地数据库
                        const localResults = searchLocalDatabase(this.value);
                        if (localResults.length > 0) {
                            displayLocationResults(localResults);
                        }
                    } else {
                        document.getElementById('location-results').style.display = 'none';
                    }
                });
            }
            
            // 图片上传处理
            const imageInput = document.getElementById('images');
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    if (e.target.files.length > 0) {
                        handleImageUpload(e.target.files);
                        // 清空input，允许重复选择相同文件
                        e.target.value = '';
                    }
                });
            }
            
            // 新建按钮
            addBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('🆕 点击新建按钮');
                showModal();
            });
            
            // 关闭按钮
            closeBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('❌ 点击关闭按钮');
                hideModal();
            });
            
            // 背景点击关闭
            backdrop.addEventListener('click', function(e) {
                if (e.target === backdrop) {
                    console.log('🔙 点击背景关闭');
                    hideModal();
                }
            });
            
            // 表单提交
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('💾 提交表单');
                saveEntry();
            });
            
            // ESC键关闭
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display === 'block') {
                    console.log('⌨️ ESC键关闭');
                    hideModal();
                }
            });
            
            console.log('✅ 事件绑定完成');
        }
        
        function showModal(skipReset = false) {
            console.log('📋 显示模态框');
            
            const modal = document.getElementById('modal');
            const form = document.getElementById('entry-form');
            
            // 只有在非跳过重置模式下才重置表单
            if (!skipReset) {
                // 清除编辑模式标记
                form.removeAttribute('data-edit-id');
                form.removeAttribute('data-edit-type');
                
                // 设置新建模式的界面
                document.getElementById('modal-title').textContent = '✨ 新建旅行日记';
                document.getElementById('save-btn').innerHTML = '💾 保存日记';
                
                // 重置表单
                form.reset();
                const dateInput = document.getElementById('date');
                dateInput.value = new Date().toISOString().split('T')[0];
            }
            
            // 重置字数统计
            setTimeout(() => {
                updateCharCount();
            }, 100);
            
            // 重置图片预览
            const imagePreview = document.getElementById('image-preview');
            if (imagePreview) {
                imagePreview.innerHTML = ''; // 清空所有预览图片
                imagePreview.style.display = 'none';
            }
            
            // 重置位置
            window.currentPosition = null;
            
            // 显示模态框
            modal.style.display = 'block';
            
            // 聚焦标题
            setTimeout(() => {
                document.getElementById('title').focus();
            }, 100);
            
            console.log('✅ 模态框已显示');
        }
        
        function hideModal() {
            console.log('🙈 隐藏模态框');
            
            const modal = document.getElementById('modal');
            const backdrop = document.getElementById('modal-backdrop');
            
            backdrop.style.display = 'none';
            modal.style.display = 'none';
            
            console.log('✅ 模态框已隐藏');
        }
        
        // 编辑云端日记
        async function editCloudEntry(entryId) {
            if (!window.supabaseClient) {
                alert('❌ 云端服务未连接');
                return;
            }
            
            try {
                // 获取云端日记详情
                const result = await window.supabaseClient.getDiary(entryId);
                
                if (!result.success) {
                    alert('❌ 获取日记详情失败: ' + result.error);
                    return;
                }
                
                const entry = result.data;
                
                // 检查是否是当前用户的日记
                const currentUser = window.supabaseClient.getCurrentUser();
                if (!currentUser || currentUser.id !== entry.user_id) {
                    alert('❌ 您只能编辑自己的日记');
                    return;
                }
                
                // 设置编辑模式
                document.getElementById('entry-form').setAttribute('data-edit-id', entryId);
                document.getElementById('entry-form').setAttribute('data-edit-type', 'cloud');
                document.getElementById('modal-title').textContent = '✏️ 编辑云端日记';
                document.getElementById('save-btn').innerHTML = '💾 更新到云端';
                
                // 填充表单数据
                document.getElementById('title').value = entry.title || '';
                document.getElementById('content').value = entry.content || '';
                document.getElementById('date').value = entry.date || entry.created_at?.split('T')[0] || '';
                document.getElementById('location').value = entry.location || '';
                document.getElementById('tags').value = entry.tags ? 
                    (Array.isArray(entry.tags) ? entry.tags.join(', ') : entry.tags) : '';
                document.getElementById('latitude').value = entry.latitude || '';
                document.getElementById('longitude').value = entry.longitude || '';
                
                // 显示模态框 (跳过重置)
                showModal(true);
                
            } catch (error) {
                console.error('❌ 编辑云端日记失败:', error);
                alert('❌ 编辑云端日记失败: ' + error.message);
            }
        }

        async function editEntry(entryId) {
            // 从适当的存储系统获取数据
            let entries = [];
            if (useIndexedDB && db) {
                try {
                    entries = await getFromIndexedDB('diaries');
                    console.log('📖 从大容量存储加载数据进行编辑');
                } catch (error) {
                    console.error('从IndexedDB获取数据失败:', error);
                    // 回退到localStorage
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 回退到传统存储加载数据');
                }
            } else {
                entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                console.log('📖 从传统存储加载数据进行编辑');
            }
            
            const entry = entries.find(e => e.id === entryId);
            
            if (!entry) {
                alert('❌ 找不到该日记条目\n\n可能原因：\n• 数据正在迁移中\n• 存储系统切换导致的临时问题\n\n建议：刷新页面后重试');
                console.error('找不到条目ID:', entryId, '可用条目:', entries.map(e => e.id));
                return;
            }
            
            console.log('✏️ 编辑条目:', entry.title);
            
            // 设置编辑模式
            document.getElementById('entry-form').setAttribute('data-edit-id', entryId);
            document.getElementById('modal-title').textContent = '✏️ 编辑日记';
            document.getElementById('save-btn').innerHTML = '💾 更新日记';
            
            // 填充表单数据 - 兼容新旧数据格式
            document.getElementById('title').value = entry.title || '';
            document.getElementById('content').value = entry.content || '';
            document.getElementById('date').value = entry.date || entry.created_at?.split('T')[0] || '';
            document.getElementById('location').value = entry.location || '';
            document.getElementById('tags').value = entry.tags ? 
                (Array.isArray(entry.tags) ? entry.tags.join(', ') : entry.tags) : '';
            
            // 更新字数统计
            setTimeout(() => {
                updateCharCount();
            }, 100);
            
            // 如果有坐标，设置位置
            if (entry.coordinates) {
                window.currentPosition = {
                    lat: entry.coordinates.lat,
                    lng: entry.coordinates.lng
                };
            } else if (entry.latitude && entry.longitude) {
                window.currentPosition = {
                    lat: entry.latitude,
                    lng: entry.longitude
                };
            }
            
            // 如果有图片，显示预览
            if (entry.images && entry.images.length > 0) {
                const imagePreview = document.getElementById('image-preview');
                imagePreview.innerHTML = ''; // 清空现有预览
                
                entry.images.forEach((imageSrc, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${imageSrc}" alt="预览图片 ${index + 1}">
                        <button class="image-remove-btn" onclick="removeImagePreview(this)" title="删除图片">&times;</button>
                    `;
                    imagePreview.appendChild(previewItem);
                    
                    // 添加入场动画
                    setTimeout(() => {
                        previewItem.style.opacity = '1';
                        previewItem.style.transform = 'scale(1)';
                    }, index * 100);
                });
                
                imagePreview.style.display = 'grid';
            } else if (entry.imageData) {
                // 兼容旧版本的单张图片格式
                const imagePreview = document.getElementById('image-preview');
                imagePreview.innerHTML = '';
                
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                previewItem.innerHTML = `
                    <img src="${entry.imageData}" alt="预览图片">
                    <button class="image-remove-btn" onclick="removeImagePreview(this)" title="删除图片">&times;</button>
                `;
                imagePreview.appendChild(previewItem);
                
                setTimeout(() => {
                    previewItem.style.opacity = '1';
                    previewItem.style.transform = 'scale(1)';
                }, 50);
                
                imagePreview.style.display = 'grid';
            }
            
            // 显示模态框
            document.getElementById('modal').style.display = 'block';
        }

        // 存储配额检查和管理函数
        function checkStorageQuota() {
            try {
                const testKey = 'storage-test';
                const testData = new Array(1024).join('x'); // 1KB 测试数据
                localStorage.setItem(testKey, testData);
                localStorage.removeItem(testKey);
                return true;
            } catch (e) {
                return false;
            }
        }

        function getStorageSize() {
            if (useIndexedDB) {
                // 异步获取 IndexedDB 大小，这里返回一个 Promise
                return getIndexedDBStorageSize();
            } else {
                // 同步获取 localStorage 大小
                let total = 0;
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        total += localStorage[key].length + key.length;
                    }
                }
                return total;
            }
        }
        
        // 兼容性函数：确保始终返回数值
        async function getStorageSizeSync() {
            const size = getStorageSize();
            return size instanceof Promise ? await size : size;
        }

        // 预估条目大小
        function estimateEntrySize(entry) {
            return JSON.stringify(entry).length * 2; // 乘以2考虑UTF-16编码
        }

        // 检查存储空间是否足够
        function checkStorageSpace(newEntry) {
            const currentSize = getStorageSize();
            const entrySize = estimateEntrySize(newEntry);
            const maxStorage = 100 * 1024 * 1024; // 100MB限制（使用IndexedDB时）
            const safeThreshold = maxStorage * 0.9; // 90%安全阈值
            
            const projectedSize = currentSize + entrySize;
            
            console.log(`📊 存储空间检查:
                当前使用: ${formatStorageSize(currentSize)}
                新条目大小: ${formatStorageSize(entrySize)}
                预计总大小: ${formatStorageSize(projectedSize)}
                安全阈值: ${formatStorageSize(safeThreshold)}`);
                
            if (projectedSize > maxStorage) {
                return {
                    canStore: false,
                    message: `存储空间不足！预计需要 ${formatStorageSize(projectedSize)}，但最大容量只有 ${formatStorageSize(maxStorage)}`
                };
            }
            
            if (projectedSize > safeThreshold) {
                return {
                    canStore: true,
                    warning: `存储空间即将不足！当前将使用 ${((projectedSize/maxStorage)*100).toFixed(1)}% 的容量`
                };
            }
            
            return { canStore: true };
        }

        function formatStorageSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        function validateContentLength(content, images = []) {
            const errors = [];
            const warnings = [];
            
            // 检查内容字数（硬限制：15000字，软限制：5000字）
            if (content.length > 15000) {
                errors.push(`❌ 内容超出限制：${content.length}/15000 字`);
            } else if (content.length > 5000) {
                warnings.push(`⚠️ 内容较长：${content.length}/15000 字，可能影响性能`);
            }
            
            // 检查总存储大小
            const currentSize = getStorageSize();
            const maxSize = 8 * 1024 * 1024; // 8MB 限制（适用于现代浏览器）
            const displaySize = formatStorageSize(maxSize);
            
            if (currentSize > maxSize) {
                errors.push(`❌ 存储空间已满：${formatStorageSize(currentSize)}/${displaySize}`);
            } else if (currentSize > maxSize * 0.8) {
                warnings.push(`⚠️ 存储空间不足：已使用 ${formatStorageSize(currentSize)}/${displaySize}`);
            }
            
            // 检查图片数量
            if (images.length > 8) {
                errors.push(`❌ 图片数量超限：${images.length}/8 张`);
            } else if (images.length > 3) {
                warnings.push(`⚠️ 图片较多：${images.length}/8 张，建议减少以节省空间`);
            }
            
            // 估算新数据大小
            const sampleEntry = {
                title: 'sample',
                content: content,
                images: images,
                tags: ['sample'],
                location: 'sample',
                date: '2024-01-01'
            };
            const newDataSize = JSON.stringify(sampleEntry).length;
            
            if (currentSize + newDataSize > maxSize) {
                errors.push(`❌ 保存后将超出存储限制，需要 ${formatStorageSize(newDataSize)} 额外空间`);
            }
            
            return { errors, warnings };
        }

        // 字数统计函数
        function updateCharCount() {
            const content = document.getElementById('content').value;
            const charCountElement = document.getElementById('char-count');
            const length = content.length;
            
            if (charCountElement) {
                let text = `${length} / 15000 字`;
                let color = '#6b7280'; // 默认灰色
                
                if (length > 15000) {
                    text += ' (超出限制)';
                    color = '#ef4444'; // 红色
                } else if (length > 10000) {
                    text += ' (过长，可能影响性能)';
                    color = '#f59e0b'; // 橙色
                } else if (length > 5000) {
                    text += ' (较长)';
                    color = '#10b981'; // 绿色
                } else {
                    text += ' (建议不超过5000字)';
                }
                
                charCountElement.textContent = text;
                charCountElement.style.color = color;
                
                // 添加警告样式
                const textarea = document.getElementById('content');
                if (length > 15000) {
                    textarea.style.borderColor = '#ef4444';
                    textarea.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                } else if (length > 10000) {
                    textarea.style.borderColor = '#f59e0b';
                    textarea.style.boxShadow = '0 0 0 3px rgba(245, 158, 11, 0.1)';
                } else {
                    textarea.style.borderColor = '';
                    textarea.style.boxShadow = '';
                }
            }
        }

        // 智能图片压缩功能 - 多级压缩策略
        function compressImage(file, maxWidth = 1200, maxHeight = 800, quality = 0.85) {
            return new Promise(async (resolve) => {
                try {
                    // 第一级：基础压缩
                    let compressed = await performCompression(file, maxWidth, maxHeight, quality);
                    
                    // 检查压缩后的大小，如果仍然太大则进行更激进的压缩
                    const targetSize = 200 * 1024; // 目标200KB
                    
                    if (compressed.size > targetSize) {
                        console.log(`🔄 图片仍然过大 (${formatFileSize(compressed.size)})，进行二级压缩...`);
                        
                        // 第二级：更激进的尺寸和质量压缩
                        compressed = await performCompression(file, 
                            Math.min(800, maxWidth), 
                            Math.min(600, maxHeight), 
                            0.7
                        );
                        
                        // 如果还是太大，进行第三级压缩
                        if (compressed.size > targetSize) {
                            console.log(`🔄 进行三级压缩...`);
                            compressed = await performCompression(file, 
                                600, 
                                400, 
                                0.5
                            );
                            
                            // 最后一级：极限压缩
                            if (compressed.size > targetSize) {
                                console.log(`🔄 进行极限压缩...`);
                                compressed = await performCompression(file, 
                                    400, 
                                    300, 
                                    0.3
                                );
                            }
                        }
                    }
                    
                    resolve(compressed);
                } catch (error) {
                    console.error('压缩失败:', error);
                    // 如果压缩失败，尝试基础压缩
                    const fallback = await performCompression(file, 800, 600, 0.6);
                    resolve(fallback);
                }
            });
        }

        // 执行实际压缩的函数
        function performCompression(file, maxWidth, maxHeight, quality) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // 计算压缩后的尺寸
                    let { width, height } = calculateResizedDimensions(
                        img.width, 
                        img.height, 
                        maxWidth, 
                        maxHeight
                    );
                    
                    // 设置canvas尺寸
                    canvas.width = width;
                    canvas.height = height;
                    
                    // 启用图像平滑以提高压缩质量
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    // 绘制压缩后的图片
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // 转换为blob
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', quality);
                };
                
                img.onerror = function() {
                    console.error('图片加载失败');
                    resolve(file); // 如果加载失败，返回原文件
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        function calculateResizedDimensions(originalWidth, originalHeight, maxWidth, maxHeight) {
            let width = originalWidth;
            let height = originalHeight;
            
            // 如果图片尺寸小于最大限制，则不需要压缩
            if (width <= maxWidth && height <= maxHeight) {
                return { width, height };
            }
            
            // 计算缩放比例
            const widthRatio = maxWidth / width;
            const heightRatio = maxHeight / height;
            const ratio = Math.min(widthRatio, heightRatio);
            
            return {
                width: Math.round(width * ratio),
                height: Math.round(height * ratio)
            };
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // 处理图片上传和压缩
        async function handleImageUpload(files) {
            const imagePreview = document.getElementById('image-preview');
            const maxImages = 8;
            const currentImages = imagePreview.querySelectorAll('.image-preview-item').length;
            
            if (currentImages + files.length > maxImages) {
                alert(`最多只能上传 ${maxImages} 张图片。当前已有 ${currentImages} 张，无法再添加 ${files.length} 张。`);
                return;
            }
            
            // 显示压缩进度
            const progressDiv = document.createElement('div');
            progressDiv.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 20px 30px;
                border-radius: 12px;
                z-index: 10002;
                text-align: center;
                backdrop-filter: blur(10px);
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            `;
            progressDiv.innerHTML = `
                <div style="margin-bottom: 10px;">📷 正在压缩图片...</div>
                <div id="compress-progress" style="color: #64ffda;">0 / ${files.length}</div>
            `;
            document.body.appendChild(progressDiv);
            
            try {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // 更新进度
                    document.getElementById('compress-progress').textContent = `${i + 1} / ${files.length}`;
                    
                    // 检查文件类型
                    if (!file.type.startsWith('image/')) {
                        alert(`文件 "${file.name}" 不是图片格式，已跳过。`);
                        continue;
                    }
                    
                    const originalSize = file.size;
                    console.log(`📷 压缩图片: ${file.name}, 原始大小: ${formatFileSize(originalSize)}`);
                    
                    // 智能压缩图片 - 根据文件大小自动调整压缩强度
                    let compressionLevel = 'normal';
                    if (originalSize > 2 * 1024 * 1024) { // 大于2MB
                        compressionLevel = 'aggressive';
                    } else if (originalSize > 1 * 1024 * 1024) { // 大于1MB
                        compressionLevel = 'medium';
                    }
                    
                    const compressParams = {
                        normal: { maxWidth: 1200, maxHeight: 800, quality: 0.85 },
                        medium: { maxWidth: 1000, maxHeight: 700, quality: 0.75 },
                        aggressive: { maxWidth: 800, maxHeight: 600, quality: 0.65 }
                    };
                    
                    const params = compressParams[compressionLevel];
                    console.log(`🎯 使用${compressionLevel}压缩模式: ${params.maxWidth}x${params.maxHeight}, 质量${params.quality}`);
                    
                    const compressedBlob = await compressImage(file, params.maxWidth, params.maxHeight, params.quality);
                    const compressedSize = compressedBlob.size;
                    const compressionRatio = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                    
                    console.log(`✅ 压缩完成: ${formatFileSize(compressedSize)}, 压缩率: ${compressionRatio}%`);
                    
                    // 如果压缩后仍然很大，给出警告
                    if (compressedSize > 300 * 1024) { // 大于300KB
                        console.warn(`⚠️ 图片${file.name}压缩后仍然较大(${formatFileSize(compressedSize)})，可能影响存储空间`);
                    }
                    
                    // 转换为data URL
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const previewItem = document.createElement('div');
                        previewItem.className = 'image-preview-item';
                        
                        // 根据压缩效果添加不同的样式提示
                        let sizeIndicator = '';
                        if (compressedSize > 500 * 1024) {
                            sizeIndicator = '🔴'; // 红色表示很大
                        } else if (compressedSize > 200 * 1024) {
                            sizeIndicator = '🟡'; // 黄色表示较大
                        } else {
                            sizeIndicator = '🟢'; // 绿色表示合适
                        }
                        
                        previewItem.innerHTML = `
                            <img src="${e.target.result}" alt="预览图片">
                            <button class="image-remove-btn" onclick="removeImagePreview(this)" title="删除图片">&times;</button>
                            <div style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.7); color: white; font-size: 10px; padding: 2px 4px; text-align: center;">
                                ${sizeIndicator} ${formatFileSize(compressedSize)} (-${compressionRatio}%)
                            </div>
                        `;
                        
                        imagePreview.appendChild(previewItem);
                        
                        // 添加入场动画
                        setTimeout(() => {
                            previewItem.style.opacity = '1';
                            previewItem.style.transform = 'scale(1)';
                        }, 50);
                    };
                    reader.readAsDataURL(compressedBlob);
                }
                
                // 显示预览容器
                imagePreview.style.display = 'grid';
                
            } catch (error) {
                console.error('❌ 图片压缩失败:', error);
                alert('图片压缩失败: ' + error.message);
            } finally {
                // 移除进度提示
                progressDiv.remove();
            }
        }
        
        // 删除图片预览
        function removeImagePreview(button) {
            const previewItem = button.closest('.image-preview-item');
            if (previewItem) {
                // 添加退场动画
                previewItem.style.transition = 'all 0.3s ease';
                previewItem.style.transform = 'scale(0)';
                previewItem.style.opacity = '0';
                
                setTimeout(() => {
                    previewItem.remove();
                    
                    // 如果没有图片了，隐藏预览容器
                    const imagePreview = document.getElementById('image-preview');
                    if (imagePreview.children.length === 0) {
                        imagePreview.style.display = 'none';
                    }
                }, 300);
            }
        }
        
        // 全局函数：删除图片预览
        window.removeImagePreview = function(button) {
            const previewItem = button.closest('.image-preview-item');
            if (previewItem) {
                // 添加退场动画
                previewItem.style.transition = 'all 0.3s ease';
                previewItem.style.transform = 'scale(0)';
                previewItem.style.opacity = '0';
                
                setTimeout(() => {
                    previewItem.remove();
                    
                    // 如果没有图片了，隐藏预览容器
                    const imagePreview = document.getElementById('image-preview');
                    if (imagePreview.children.length === 0) {
                        imagePreview.style.display = 'none';
                    }
                }, 300);
            }
        };

        async function showStorageManagement() {
            const currentSize = await getStorageSizeSync();
            const entries = useIndexedDB && db ? 
                await getFromIndexedDB('diaries') : 
                JSON.parse(localStorage.getItem('travelDiary') || '[]');
            
            // 分析每个条目的存储占用
            const entryAnalysis = entries.map(entry => ({
                id: entry.id,
                title: entry.title,
                size: JSON.stringify(entry).length * 2,
                imageCount: entry.images ? entry.images.length : 0,
                contentLength: entry.content ? entry.content.length : 0
            })).sort((a, b) => b.size - a.size); // 按大小排序
            
            const maxStorage = 100 * 1024 * 1024; // 100MB 大容量存储
            const storageType = useIndexedDB ? '大容量存储系统' : '传统存储系统';
            const storageLimit = useIndexedDB ? '100MB' : '10MB';
            
            let message = `📊 ${storageType}详情\n\n`;
            message += `当前使用：${formatStorageSize(currentSize)}/${storageLimit} (${((currentSize/(useIndexedDB ? maxStorage : 10*1024*1024))*100).toFixed(1)}%)\n`;
            message += `日记数量：${entries.length} 篇\n`;
            message += `存储类型：${useIndexedDB ? '🚀 大容量IndexedDB' : '📦 传统localStorage'}\n\n`;
            
            // 显示占用最大的前5个条目
            message += `📈 存储占用最大的日记：\n`;
            const topEntries = entryAnalysis.slice(0, 5);
            topEntries.forEach((entry, index) => {
                message += `${index + 1}. ${entry.title.slice(0, 20)}${entry.title.length > 20 ? '...' : ''}\n`;
                message += `   大小: ${formatStorageSize(entry.size)} | 图片: ${entry.imageCount}张 | 文字: ${entry.contentLength}字\n`;
            });
            
            message += `\n💡 优化建议：\n`;
            
            // 智能建议
            const largeEntries = entryAnalysis.filter(e => e.size > 50000); // 50KB以上
            const imageHeavyEntries = entryAnalysis.filter(e => e.imageCount > 3);
            const textHeavyEntries = entryAnalysis.filter(e => e.contentLength > 3000);
            
            // 检查缺少坐标的日记数量
            const entriesWithoutCoords = entries.filter(e => !e.latitude || !e.longitude).length;
            
            if (useIndexedDB) {
                message += `🔸 已启用大容量存储，支持更多图片和内容\n`;
            } else {
                message += `🔸 建议升级到大容量存储系统以获得更多空间\n`;
            }
            
            if (entriesWithoutCoords > 0) {
                message += `🗺️ ${entriesWithoutCoords}篇日记缺少地图坐标，可批量添加以完善地图功能\n`;
            } else {
                message += `✅ 所有日记都已有地图坐标，地图功能完整\n`;
            }
            
            if (largeEntries.length > 0) {
                message += `🔸 ${largeEntries.length}篇日记占用较大空间，考虑精简内容或图片\n`;
            }
            if (imageHeavyEntries.length > 0) {
                message += `🔸 ${imageHeavyEntries.length}篇日记图片较多，可删除不必要的图片\n`;
            }
            if (textHeavyEntries.length > 0) {
                message += `🔸 ${textHeavyEntries.length}篇日记文字较长，可适当精简\n`;
            }
            
            // 估算可释放的空间
            const potentialSavings = largeEntries.reduce((sum, entry) => sum + entry.size * 0.3, 0);
            if (potentialSavings > 10000) {
                message += `🔸 通过优化可能释放约 ${formatStorageSize(potentialSavings)} 空间\n`;
            }
            
            message += `\n要查看详细的管理选项吗？`;
            
            if (confirm(message)) {
                showDetailedStorageManagement(entryAnalysis, entriesWithoutCoords);
            } else if (!useIndexedDB && window.indexedDB) {
                // 如果用户取消，提供升级选项
                setTimeout(() => {
                    showStorageUpgradeOption();
                }, 500);
            }
        }

        function showDetailedStorageManagement(entryAnalysis, entriesWithoutCoords) {
            // 创建一个简单的管理界面
            let managementMessage = `🛠️ 存储管理助手\n\n`;
            managementMessage += `选择要执行的操作：\n\n`;
            
            // 地图坐标相关选项
            if (entriesWithoutCoords > 0) {
                managementMessage += `🗺️ 1. 为 ${entriesWithoutCoords} 篇日记批量添加地图坐标\n`;
                managementMessage += `🧹 2. 存储清理选项\n`;
                managementMessage += `📊 3. 查看详细统计\n`;
                managementMessage += `❌ 4. 取消\n\n`;
                
                const choice = prompt(managementMessage + `请输入选项数字 (1-4):`);
                
                if (choice === '1') {
                    // 批量添加坐标
                    addCoordinatesToExistingEntries().then(result => {
                        alert(`🗺️ 地图坐标添加完成！\n\n${result}\n\n刷新地图查看效果。`);
                        // 刷新当前视图
                        if (currentView === 'gallery') {
                            loadEntries();
                        } else if (currentView === 'map') {
                            updateMapMarkers();
                        }
                    }).catch(error => {
                        alert(`❌ 添加坐标失败：${error.message}`);
                    });
                    return;
                } else if (choice === '2') {
                    showStorageCleanupOptions(entryAnalysis);
                    return;
                } else if (choice === '3') {
                    showDetailedStats(entryAnalysis);
                    return;
                }
            } else {
                managementMessage += `🧹 1. 存储清理选项\n`;
                managementMessage += `📊 2. 查看详细统计\n`;
                managementMessage += `❌ 3. 取消\n\n`;
                
                const choice = prompt(managementMessage + `请输入选项数字 (1-3):`);
                
                if (choice === '1') {
                    showStorageCleanupOptions(entryAnalysis);
                    return;
                } else if (choice === '2') {
                    showDetailedStats(entryAnalysis);
                    return;
                }
            }
        }
        
        function showStorageCleanupOptions(entryAnalysis) {
            // 创建一个简单的清理界面
            let cleanupMessage = `🧹 存储清理助手\n\n`;
            cleanupMessage += `选择要清理的内容类型：\n\n`;
            cleanupMessage += `1. 删除最大的3篇日记 (释放约${formatStorageSize(entryAnalysis.slice(0,3).reduce((sum,e) => sum + e.size, 0))})\n`;
            cleanupMessage += `2. 清理所有图片超过5张的日记\n`;
            cleanupMessage += `3. 删除超过6个月的旧日记\n`;
            cleanupMessage += `4. 手动删除特定日记\n`;
            cleanupMessage += `5. 取消\n\n`;
            cleanupMessage += `请输入选项编号 (1-5):`;
            
            const choice = prompt(cleanupMessage);
            
            switch(choice) {
                case '1':
                    if (confirm(`确定要删除最大的3篇日记吗？这将释放约${formatStorageSize(entryAnalysis.slice(0,3).reduce((sum,e) => sum + e.size, 0))}空间。`)) {
                        const idsToDelete = entryAnalysis.slice(0,3).map(e => e.id);
                        cleanupEntries(idsToDelete);
                    }
                    break;
                case '2':
                    const imageHeavyIds = entryAnalysis.filter(e => e.imageCount > 5).map(e => e.id);
                    if (imageHeavyIds.length > 0 && confirm(`找到${imageHeavyIds.length}篇图片较多的日记，确定清理吗？`)) {
                        cleanupEntries(imageHeavyIds);
                    } else {
                        alert('没有找到图片超过5张的日记。');
                    }
                    break;
                case '3':
                    const sixMonthsAgo = new Date();
                    sixMonthsAgo.setMonth(sixMonthsAgo.getMonth() - 6);
                    const oldIds = entryAnalysis.filter(e => {
                        const entry = JSON.parse(localStorage.getItem('travelDiary') || '[]').find(item => item.id === e.id);
                        return new Date(entry.created) < sixMonthsAgo;
                    }).map(e => e.id);
                    
                    if (oldIds.length > 0 && confirm(`找到${oldIds.length}篇超过6个月的旧日记，确定删除吗？`)) {
                        cleanupEntries(oldIds);
                    } else {
                        alert('没有找到超过6个月的旧日记。');
                    }
                    break;
                case '4':
                    alert('请在主界面手动删除特定的日记。');
                    break;
                default:
                    break;
            }
        }

        // 手动升级到大容量存储
        async function upgradeToLargeStorage() {
            if (useIndexedDB) {
                alert('✅ 您已经在使用大容量存储系统！');
                return;
            }
            
            if (!window.indexedDB) {
                alert('❌ 您的浏览器不支持大容量存储系统。');
                return;
            }
            
            const confirmUpgrade = confirm(`🚀 升级到大容量存储系统\n\n将获得以下优势：\n• 存储容量从 10MB 扩展到 100MB\n• 支持更多高质量照片\n• 更快的数据访问速度\n• 更好的数据管理\n\n是否立即升级？`);
            
            if (!confirmUpgrade) return;
            
            try {
                // 初始化 IndexedDB
                db = await openIndexedDB();
                useIndexedDB = true;
                
                // 迁移现有数据
                await migrateFromLocalStorage();
                
                // 显示成功消息
                alert('🎉 升级成功！\n\n现在您可以：\n• 存储更多照片和内容\n• 享受 100MB 的大容量空间\n• 体验更快的数据处理\n\n页面将刷新以应用更改。');
                
                // 刷新页面
                location.reload();
                
            } catch (error) {
                console.error('升级失败:', error);
                alert('❌ 升级失败: ' + error.message);
                useIndexedDB = false;
                db = null;
            }
        }
        
        // 添加升级按钮到存储管理界面
        function showStorageUpgradeOption() {
            if (!useIndexedDB && window.indexedDB) {
                const upgradeMessage = `🚀 存储升级可用！\n\n当前：传统存储 (最大 10MB)\n可升级到：大容量存储 (最大 100MB)\n\n立即升级可获得：\n• 10倍存储容量\n• 更多照片支持\n• 更快访问速度\n\n是否立即升级？`;
                
                if (confirm(upgradeMessage)) {
                    upgradeToLargeStorage();
                }
            }
        }

        async function saveEntry() {
            console.log('💾 保存日记');
            
            // 检查是否为编辑模式
            const form = document.getElementById('entry-form');
            const editId = form.getAttribute('data-edit-id');
            const editType = form.getAttribute('data-edit-type'); // 'cloud' or null (local)
            const isEditMode = editId !== null;
            const isCloudEdit = editType === 'cloud';
            
            console.log('编辑模式:', isEditMode, '编辑ID:', editId, '编辑类型:', editType);
            
            // 获取表单数据
            const title = document.getElementById('title').value.trim();
            const date = document.getElementById('date').value;
            const location = document.getElementById('location').value.trim();
            const tags = document.getElementById('tags').value.trim();
            const content = document.getElementById('content').value.trim();
            const latitude = document.getElementById('latitude').value;
            const longitude = document.getElementById('longitude').value;
            
            console.log('📝 表单数据:', { title, date, location, tags, content });
            
            // 验证
            if (!title) {
                alert('📝 请输入标题');
                document.getElementById('title').focus();
                return;
            }
            if (!date) {
                alert('📅 请选择日期');
                document.getElementById('date').focus();
                return;
            }
            if (!location) {
                alert('📍 请输入地点');
                document.getElementById('location').focus();
                return;
            }
            if (!tags) {
                alert('🏷️ 请输入标签');
                document.getElementById('tags').focus();
                return;
            }
            if (!content) {
                alert('📖 请输入内容');
                document.getElementById('content').focus();
                return;
            }
            
            // 获取图片数据
            const imagePreview = document.getElementById('image-preview');
            const images = [];
            if (imagePreview) {
                const imageElements = imagePreview.querySelectorAll('img');
                imageElements.forEach(img => {
                    images.push(img.src);
                });
            }

            // 验证内容长度和存储空间
            const validation = validateContentLength(content, images);
            
            // 处理错误（阻止保存）
            if (validation.errors.length > 0) {
                let errorMessage = '无法保存日记，发现以下问题：\n\n';
                errorMessage += validation.errors.join('\n\n');
                errorMessage += '\n\n💡 建议：\n';
                errorMessage += '- 缩短日记内容（当前：' + content.length + ' 字）\n';
                errorMessage += '- 减少图片数量（当前：' + images.length + ' 张）\n';
                errorMessage += '- 删除一些旧日记释放空间';
                
                alert(errorMessage);
                
                // 如果是存储空间问题，提供管理选项
                if (validation.errors.some(e => e.includes('存储空间') || e.includes('超出限制'))) {
                    if (confirm('\n要打开存储空间管理吗？')) {
                        showStorageManagement();
                    }
                }
                return;
            }
            
            // 处理警告（允许保存但提醒用户）
            if (validation.warnings.length > 0) {
                let warningMessage = '发现以下提醒：\n\n';
                warningMessage += validation.warnings.join('\n\n');
                warningMessage += '\n\n仍要继续保存吗？';
                
                if (!confirm(warningMessage)) {
                    return;
                }
            }
            
            try {
                // 从适当的存储系统获取现有数据
                let entries = [];
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储加载现有数据');
                    } catch (error) {
                        console.error('从IndexedDB获取数据失败:', error);
                        // 回退到localStorage
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储加载现有数据');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 从传统存储加载现有数据');
                }
                
                if (isEditMode && isCloudEdit) {
                    // 云端日记编辑模式
                    if (!window.supabaseClient) {
                        alert('❌ 云端服务未连接');
                        return;
                    }
                    
                    const updatedData = {
                        title: title,
                        date: date,  // 添加用户选择的日期
                        location: location,
                        content: content,
                        tags: tags.split(',').map(tag => tag.trim()).filter(Boolean),
                        latitude: latitude ? parseFloat(latitude) : null,
                        longitude: longitude ? parseFloat(longitude) : null,
                        images: images
                    };
                    
                    console.log('☁️ 更新云端日记:', editId, updatedData);
                    
                    const result = await window.supabaseClient.updateDiary(editId, updatedData);
                    
                    if (!result.success) {
                        alert('❌ 更新云端日记失败: ' + result.error);
                        return;
                    }
                    
                    // 清除编辑模式标记
                    form.removeAttribute('data-edit-id');
                    form.removeAttribute('data-edit-type');
                    document.getElementById('modal-title').textContent = '✍️ 写日记';
                    document.getElementById('save-btn').innerHTML = '💾 保存日记';
                    
                    // 隐藏模态框
                    hideModal();
                    
                    // 显示成功消息
                    showSuccessMessage(`☁️ 云端日记《${title}》已更新！`);
                    
                    // 重新加载共享日记
                    setTimeout(() => {
                        loadSharedDiaries();
                    }, 1000);
                    
                    return;
                    
                } else if (isEditMode) {
                    // 本地日记编辑模式：更新现有条目
                    const entryIndex = entries.findIndex(entry => entry.id === parseInt(editId));
                    if (entryIndex === -1) {
                        alert('❌ 找不到要编辑的日记');
                        return;
                    }
                    
                    // 保留原有的ID和创建时间
                    const originalEntry = entries[entryIndex];
                    const updatedEntry = {
                        ...originalEntry,
                        title: title,
                        date: date,  // 保存用户选择的日期
                        location: location,
                        content: content,
                        tags: tags.split(',').map(tag => tag.trim()).filter(Boolean),
                        latitude: latitude ? parseFloat(latitude) : null,
                        longitude: longitude ? parseFloat(longitude) : null,
                        images: images,
                        updated_at: new Date().toISOString()  // 使用updated_at而不是lastModified
                    };
                    
                    entries[entryIndex] = updatedEntry;
                    console.log('✏️ 更新条目:', updatedEntry);
                    
                } else {
                    // 新建模式：创建新条目
                    const newEntry = {
                        id: Date.now(),
                        created_at: new Date().toISOString(),  // 创建时间
                        date: date,  // 用户选择的日期
                        title: title,
                        location: location,
                        content: content,
                        tags: tags.split(',').map(tag => tag.trim()).filter(Boolean),
                        latitude: latitude ? parseFloat(latitude) : null,
                        longitude: longitude ? parseFloat(longitude) : null,
                        images: images
                    };
                    
                    entries.push(newEntry);
                    console.log('📄 创建条目:', newEntry);
                }
                
                    // 保存到大容量存储系统前进行存储空间检查
                try {
                    // 预检查存储空间
                    const storageCheck = checkStorageSpace(isEditMode ? 
                        entries.find(e => e.id === parseInt(editId)) : 
                        entries[entries.length - 1]
                    );
                    
                    if (!storageCheck.canStore) {
                        throw new Error(storageCheck.message);
                    }
                    
                    if (storageCheck.warning) {
                        console.warn('⚠️ ' + storageCheck.warning);
                        
                        // 提供优化建议
                        const currentUsagePercent = useIndexedDB ? 
                            ((await getStorageSizeSync() / (100 * 1024 * 1024)) * 100).toFixed(1) :
                            ((getStorageSize() / (100 * 1024 * 1024)) * 100).toFixed(1);
                        let optimizationTip = storageCheck.warning + '\n\n';
                        optimizationTip += `💡 存储优化建议：\n`;
                        optimizationTip += `• 当前使用了 ${currentUsagePercent}% 的存储空间\n`;
                        optimizationTip += `• 图片已自动压缩，但可考虑减少图片数量\n`;
                        optimizationTip += `• 可通过"存储管理"功能清理旧日记\n`;
                        optimizationTip += `• ${useIndexedDB ? '大容量存储系统支持更多内容' : '建议升级到大容量存储'}\n\n`;
                        optimizationTip += `是否继续保存？`;
                        
                        if (!confirm(optimizationTip)) {
                            return;
                        }
                    }
                    
                    // 保存到适当的存储系统
                    if (useIndexedDB && db) {
                        // 保存到 IndexedDB（大容量存储）
                        await saveToIndexedDB('diaries', entries);
                        console.log('✅ 保存到大容量存储成功');
                    } else {
                        // 保存到 localStorage（传统存储）
                        localStorage.setItem('travelDiary', JSON.stringify(entries));
                        console.log('✅ 保存到传统存储成功');
                    }
                    
                    // 如果已登录，同时保存到云端
                    if (window.supabaseClient && isLoggedIn && currentMode === 'cloud') {
                        try {
                            const entryToSync = isEditMode ? entries.find(e => e.id === parseInt(editId)) : entries[entries.length - 1];
                            
                            // 准备云端数据，只包含数据库表中存在的字段
                            const cloudData = {
                                title: entryToSync.title,
                                content: entryToSync.content,
                                location: entryToSync.location,
                                latitude: entryToSync.latitude,
                                longitude: entryToSync.longitude,
                                images: entryToSync.images,
                                tags: entryToSync.tags,
                                // 不包含 id, created, date, favorited 等本地字段
                            };
                            
                            const result = await window.supabaseClient.saveDiary(cloudData);
                            if (result.success) {
                                console.log('✅ 云端同步成功');
                                showSuccessMessage(isEditMode ? '🎉 日记更新成功！已同步到云端' : '🎉 日记保存成功！已同步到云端');
                            } else {
                                console.warn('⚠️ 云端同步失败:', result.error);
                                showSuccessMessage(isEditMode ? '🎉 日记更新成功！（云端同步失败）' : '🎉 日记保存成功！（云端同步失败）');
                            }
                        } catch (cloudError) {
                            console.warn('⚠️ 云端同步出错:', cloudError);
                            showSuccessMessage(isEditMode ? '🎉 日记更新成功！（云端同步失败）' : '🎉 日记保存成功！（云端同步失败）');
                        }
                    } else {
                        // 显示成功消息
                        showSuccessMessage(isEditMode ? '🎉 日记更新成功！' : '🎉 日记保存成功！');
                    }
                    
                    // 添加庆祝粒子效果
                    setTimeout(() => {
                        createCelebrationParticles();
                    }, 300);
                    
                    // 清除编辑模式标记
                    form.removeAttribute('data-edit-id');
                    form.removeAttribute('data-edit-type');
                    
                    // 关闭模态框
                    hideModal();
                    
                    // 重新加载
                    loadEntries();
                    updateStats();
                    updateMapMarkers();
                    
                } catch (storageError) {
                    console.error('❌ 存储失败:', storageError);
                    
                    let errorMessage = '';
                    if (storageError.name === 'QuotaExceededError' || 
                        storageError.message.includes('quota') || 
                        storageError.message.includes('exceeded')) {
                        
                        const currentSize = getStorageSize();
                        errorMessage = `💾 存储空间不足！\n\n`;
                        errorMessage += `当前使用：${formatStorageSize(currentSize)}/10MB\n`;
                        errorMessage += `内容长度：${content.length} 字\n`;
                        errorMessage += `图片数量：${images.length} 张\n\n`;
                        errorMessage += `💡 解决方案：\n`;
                        errorMessage += `1. 缩短日记内容（建议<5000字）\n`;
                        errorMessage += `2. 减少或删除图片\n`;
                        errorMessage += `3. 删除一些旧日记释放空间\n\n`;
                        errorMessage += `要打开存储管理吗？`;
                        
                        if (confirm(errorMessage)) {
                            showStorageManagement();
                        }
                    } else {
                        errorMessage = `❌ 保存失败: ${storageError.message}\n\n如果问题持续，请尝试刷新页面或清理浏览器缓存。`;
                        alert(errorMessage);
                    }
                }
                
            } catch (error) {
                console.error('❌ 处理失败:', error);
                alert('❌ 处理失败: ' + error.message);
            }
        }

        // ========== 用户系统功能 ==========
        function initUserSystem() {
            console.log('🔧 初始化用户系统...');
            
            // 绑定模式切换事件
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const mode = btn.dataset.mode;
                    switchMode(mode);
                });
            });
            
            // 绑定登录注册按钮事件
            const showLoginBtn = document.getElementById('show-login-btn');
            const showRegisterBtn = document.getElementById('show-register-btn');
            
            if (showLoginBtn) {
                showLoginBtn.addEventListener('click', () => showLoginModal());
            }
            if (showRegisterBtn) {
                showRegisterBtn.addEventListener('click', () => showRegisterModal());
            }
            
            // 绑定用户操作按钮
            const editProfileBtn = document.getElementById('edit-profile-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const syncDataBtn = document.getElementById('sync-data-btn');
            const viewSharedBtn = document.getElementById('view-shared-btn');
            
            if (editProfileBtn) {
                editProfileBtn.addEventListener('click', () => showProfileModal());
            }
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => handleLogout());
            }
            if (syncDataBtn) {
                syncDataBtn.addEventListener('click', () => syncToCloud());
            }
            if (viewSharedBtn) {
                viewSharedBtn.addEventListener('click', () => switchView('shared'));
            }
            
            // 绑定模态框事件
            bindAuthModals();
            
            // 检查Supabase客户端状态
            if (window.supabaseClient) {
                console.log('✅ Supabase客户端已加载');
                // 如果已经登录，更新UI
                if (window.supabaseClient.isLoggedIn()) {
                    updateUIForLoggedInUser();
                }
            } else {
                console.log('⚠️ Supabase客户端未加载，只能使用本地模式');
            }
        }
        
        function switchMode(mode) {
            console.log(`🔄 切换到${mode}模式`);
            currentMode = mode;
            
            // 更新按钮状态
            const modeBtns = document.querySelectorAll('.mode-btn');
            modeBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            
            // 显示/隐藏云端登录选项
            const cloudLogin = document.getElementById('cloud-login');
            if (cloudLogin) {
                cloudLogin.style.display = mode === 'cloud' ? 'block' : 'none';
            }
            
            // 如果切换到云端模式但未登录，提示登录
            if (mode === 'cloud' && !isLoggedIn) {
                showNotification('请先登录以使用云端功能', 'info');
            }
        }
        
        function bindAuthModals() {
            // 登录模态框
            const loginModal = document.getElementById('login-modal');
            const loginBackdrop = document.getElementById('login-modal-backdrop');
            const loginForm = document.getElementById('login-form');
            const closeLoginBtn = document.getElementById('close-login-modal-btn');
            const switchToRegister = document.getElementById('switch-to-register');
            
            if (closeLoginBtn) {
                closeLoginBtn.addEventListener('click', () => hideLoginModal());
            }
            if (loginBackdrop) {
                loginBackdrop.addEventListener('click', () => hideLoginModal());
            }
            if (switchToRegister) {
                switchToRegister.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideLoginModal();
                    showRegisterModal();
                });
            }
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            // 注册模态框
            const registerModal = document.getElementById('register-modal');
            const registerBackdrop = document.getElementById('register-modal-backdrop');
            const registerForm = document.getElementById('register-form');
            const closeRegisterBtn = document.getElementById('close-register-modal-btn');
            const switchToLogin = document.getElementById('switch-to-login');
            
            if (closeRegisterBtn) {
                closeRegisterBtn.addEventListener('click', () => hideRegisterModal());
            }
            if (registerBackdrop) {
                registerBackdrop.addEventListener('click', () => hideRegisterModal());
            }
            if (switchToLogin) {
                switchToLogin.addEventListener('click', (e) => {
                    e.preventDefault();
                    hideRegisterModal();
                    showLoginModal();
                });
            }
            if (registerForm) {
                registerForm.addEventListener('submit', handleRegister);
            }
            
            // GitHub 登录按钮事件
            const githubLoginBtn = document.getElementById('github-login-btn');
            const githubRegisterBtn = document.getElementById('github-register-btn');
            
            if (githubLoginBtn) {
                githubLoginBtn.addEventListener('click', handleGitHubLogin);
            }
            if (githubRegisterBtn) {
                githubRegisterBtn.addEventListener('click', handleGitHubLogin);
            }
            
            // 编辑资料模态框
            const profileModal = document.getElementById('profile-modal');
            const profileBackdrop = document.getElementById('profile-modal-backdrop');
            const profileForm = document.getElementById('profile-form');
            const closeProfileBtn = document.getElementById('close-profile-modal-btn');
            const uploadAvatarBtn = document.getElementById('upload-avatar-btn');
            const avatarInput = document.getElementById('profile-avatar-input');
            
            if (closeProfileBtn) {
                closeProfileBtn.addEventListener('click', () => hideProfileModal());
            }
            if (profileBackdrop) {
                profileBackdrop.addEventListener('click', () => hideProfileModal());
            }
            if (profileForm) {
                profileForm.addEventListener('submit', handleUpdateProfile);
            }
            if (uploadAvatarBtn && avatarInput) {
                uploadAvatarBtn.addEventListener('click', () => avatarInput.click());
                avatarInput.addEventListener('change', handleAvatarChange);
            }
        }
        
        // 模态框显示/隐藏函数
        function showLoginModal() {
            const modal = document.getElementById('login-modal');
            const backdrop = document.getElementById('login-modal-backdrop');
            if (modal && backdrop) {
                modal.style.display = 'block';
                backdrop.style.display = 'block';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    backdrop.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideLoginModal() {
            const modal = document.getElementById('login-modal');
            const backdrop = document.getElementById('login-modal-backdrop');
            if (modal && backdrop) {
                modal.style.opacity = '0';
                backdrop.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    backdrop.style.display = 'none';
                }, 300);
            }
        }
        
        function showRegisterModal() {
            const modal = document.getElementById('register-modal');
            const backdrop = document.getElementById('register-modal-backdrop');
            if (modal && backdrop) {
                modal.style.display = 'block';
                backdrop.style.display = 'block';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    backdrop.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideRegisterModal() {
            const modal = document.getElementById('register-modal');
            const backdrop = document.getElementById('register-modal-backdrop');
            if (modal && backdrop) {
                modal.style.opacity = '0';
                backdrop.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    backdrop.style.display = 'none';
                }, 300);
            }
        }
        
        function showProfileModal() {
            const modal = document.getElementById('profile-modal');
            const backdrop = document.getElementById('profile-modal-backdrop');
            if (modal && backdrop) {
                // 加载当前用户信息
                loadCurrentUserProfile();
                modal.style.display = 'block';
                backdrop.style.display = 'block';
                setTimeout(() => {
                    modal.style.opacity = '1';
                    backdrop.style.opacity = '1';
                }, 10);
            }
        }
        
        function hideProfileModal() {
            const modal = document.getElementById('profile-modal');
            const backdrop = document.getElementById('profile-modal-backdrop');
            if (modal && backdrop) {
                modal.style.opacity = '0';
                backdrop.style.opacity = '0';
                setTimeout(() => {
                    modal.style.display = 'none';
                    backdrop.style.display = 'none';
                }, 300);
            }
        }
        
        // GitHub OAuth 登录处理函数
        async function handleGitHubLogin() {
            if (!window.supabaseClient) {
                showNotification('云端服务未连接，请检查网络', 'error');
                return;
            }
            
            try {
                showNotification('正在跳转到GitHub登录...', 'info');
                const result = await window.supabaseClient.signInWithGitHub();
                
                if (result.success) {
                    // OAuth 重定向将在另一个页面处理
                    console.log('✅ GitHub登录重定向开始');
                } else {
                    showNotification(result.error || 'GitHub登录失败', 'error');
                }
            } catch (error) {
                console.error('GitHub登录错误:', error);
                showNotification('GitHub登录时发生错误：' + error.message, 'error');
            }
        }
        
        // OAuth 登录成功处理函数
        window.handleOAuthSuccess = function() {
            console.log('🎉 OAuth 登录成功，更新UI...');
            showNotification('GitHub登录成功！', 'success');
            
            // 关闭所有模态框
            hideLoginModal();
            hideRegisterModal();
            
            // 更新登录状态和UI
            isLoggedIn = true;
            updateUIForLoggedInUser();
            switchMode('cloud');
            
            // 加载用户数据
            loadCloudEntries();
        };
        
        // 用户认证处理函数
        async function handleLogin(e) {
            e.preventDefault();
            
            if (!window.supabaseClient) {
                showNotification('云端服务未连接，请检查网络或使用本地模式', 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            
            try {
                showNotification('正在登录...', 'info');
                const result = await window.supabaseClient.signIn(email, password);
                
                if (result.success) {
                    showNotification('登录成功！', 'success');
                    hideLoginModal();
                    isLoggedIn = true;
                    updateUIForLoggedInUser();
                    switchMode('cloud');
                    // 加载用户的云端日记
                    loadCloudEntries();
                } else {
                    showNotification(result.error || '登录失败，请检查邮箱和密码', 'error');
                }
            } catch (error) {
                showNotification('登录时发生错误：' + error.message, 'error');
            }
        }
        
        async function handleRegister(e) {
            e.preventDefault();
            
            if (!window.supabaseClient) {
                showNotification('云端服务未连接，请检查网络或使用本地模式', 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const email = formData.get('email');
            const password = formData.get('password');
            const nickname = formData.get('nickname');
            
            try {
                showNotification('正在注册...', 'info');
                const result = await window.supabaseClient.signUp(email, password, nickname);
                
                if (result.success) {
                    // 检查是否需要邮件验证
                    if (result.data.user && !result.data.session) {
                        showNotification('注册成功！📧 请检查邮箱并点击验证链接完成注册', 'success');
                    } else {
                        showNotification('注册成功！', 'success');
                    }
                    hideRegisterModal();
                    showLoginModal();
                } else {
                    showNotification(result.error || '注册失败，请重试', 'error');
                }
            } catch (error) {
                showNotification('注册时发生错误：' + error.message, 'error');
            }
        }
        
        async function handleLogout() {
            if (!window.supabaseClient) {
                return;
            }
            
            try {
                showNotification('正在退出登录...', 'info');
                
                const result = await window.supabaseClient.signOut();
                
                // 无论 Supabase 是否返回错误，都要清理本地状态
                isLoggedIn = false;
                updateUIForLoggedOutUser();
                switchMode('local');
                
                if (result.success) {
                    showNotification('已成功退出登录', 'success');
                } else {
                    console.warn('Supabase 登出警告:', result.error);
                    showNotification('已退出登录（本地清理完成）', 'success');
                }
                
            } catch (error) {
                console.error('登出处理错误:', error);
                
                // 即使出现异常，也要清理本地状态
                isLoggedIn = false;
                updateUIForLoggedOutUser();
                switchMode('local');
                
                showNotification('已退出登录（强制清理）', 'success');
            }
        }
        
        async function handleUpdateProfile(e) {
            e.preventDefault();
            
            if (!window.supabaseClient || !isLoggedIn) {
                showNotification('请先登录', 'error');
                return;
            }
            
            const formData = new FormData(e.target);
            const nickname = formData.get('nickname');
            const bio = formData.get('bio');
            
            try {
                showNotification('正在更新资料...', 'info');
                const result = await window.supabaseClient.updateProfile({
                    nickname,
                    bio
                });
                
                if (result.success) {
                    showNotification('资料更新成功！', 'success');
                    hideProfileModal();
                    updateUserDisplay();
                } else {
                    showNotification(result.error || '更新失败，请重试', 'error');
                }
            } catch (error) {
                showNotification('更新资料时发生错误：' + error.message, 'error');
            }
        }
        
        async function handleAvatarChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                showNotification('请选择图片文件', 'error');
                return;
            }
            
            // 检查文件大小（限制5MB）
            if (file.size > 5 * 1024 * 1024) {
                showNotification('图片文件不能超过5MB', 'error');
                return;
            }
            
            try {
                // 显示预览
                const reader = new FileReader();
                reader.onload = (e) => {
                    const preview = document.getElementById('profile-avatar-preview');
                    if (preview) {
                        preview.src = e.target.result;
                    }
                };
                reader.readAsDataURL(file);
                
                // 上传到云端
                if (window.supabaseClient && isLoggedIn) {
                    showNotification('正在上传头像...', 'info');
                    const result = await window.supabaseClient.uploadAvatar(file);
                    
                    if (result.success) {
                        console.log('📤 头像上传成功，URL:', result.url);
                        
                        // 更新用户资料中的头像URL
                        const updateResult = await window.supabaseClient.updateProfile({
                            avatar_url: result.url
                        });
                        
                        if (updateResult.success) {
                            console.log('✅ 头像URL保存成功');
                            showNotification('头像上传成功！', 'success');
                            // 延迟一下再更新显示，确保数据库更新完成
                            setTimeout(() => {
                                updateUserDisplay();
                            }, 500);
                        } else {
                            console.error('❌ 保存头像URL失败:', updateResult.error);
                            showNotification('头像保存失败：' + updateResult.error, 'error');
                        }
                    } else {
                        showNotification(result.error || '头像上传失败', 'error');
                    }
                }
            } catch (error) {
                showNotification('头像上传时发生错误：' + error.message, 'error');
            }
        }
        
        function updateUIForLoggedInUser() {
            const loginSection = document.getElementById('login-section');
            const userSection = document.getElementById('user-section');
            const cloudFeatures = document.querySelectorAll('.cloud-feature');
            
            if (loginSection) loginSection.style.display = 'none';
            if (userSection) userSection.style.display = 'block';
            
            cloudFeatures.forEach(feature => {
                feature.style.display = 'inline-block';
            });
            
            // 更新用户显示信息
            updateUserDisplay();
            
            // 切换到云端模式
            switchMode('cloud');
            
            // 更新统计信息（包含云端数据）
            updateStats();
        }
        
        function updateUIForLoggedOutUser() {
            const loginSection = document.getElementById('login-section');
            const userSection = document.getElementById('user-section');
            const cloudFeatures = document.querySelectorAll('.cloud-feature');
            
            if (loginSection) loginSection.style.display = 'block';
            if (userSection) userSection.style.display = 'none';
            
            cloudFeatures.forEach(feature => {
                feature.style.display = 'none';
            });
            
            // 更新统计信息（仅本地数据）
            updateStats();
        }
        
        async function updateUserDisplay() {
            if (!window.supabaseClient || !isLoggedIn) return;
            
            try {
                const user = window.supabaseClient.getCurrentUser();
                if (!user) return;
                
                console.log('📋 获取用户档案中...', user.id);
                const profileResult = await window.supabaseClient.getUserProfile(user.id);
                
                if (profileResult.success && profileResult.data) {
                    const profile = profileResult.data;
                    console.log('✅ 用户档案获取成功:', profile);
                    
                    // 更新头像
                    const avatarImg = document.getElementById('user-avatar');
                    if (avatarImg) {
                        if (profile.avatar_url) {
                            console.log('🖼️ 更新头像:', profile.avatar_url);
                            avatarImg.src = profile.avatar_url;
                            avatarImg.onerror = () => {
                                console.log('❌ 头像加载失败，使用默认头像');
                                avatarImg.src = './default-avatar.svg';
                            };
                        } else {
                            console.log('📷 使用默认头像');
                            avatarImg.src = './default-avatar.svg';
                        }
                    }
                    
                    // 更新昵称
                    const nicknameSpan = document.getElementById('user-nickname');
                    if (nicknameSpan) {
                        nicknameSpan.textContent = profile.nickname || user.email;
                    }
                } else {
                    console.error('❌ 获取用户档案失败:', profileResult.error);
                    // 使用用户基本信息
                    const nicknameSpan = document.getElementById('user-nickname');
                    if (nicknameSpan) {
                        nicknameSpan.textContent = user.email;
                    }
                }
            } catch (error) {
                console.error('❌ 更新用户显示失败:', error);
            }
        }
        
        async function loadCurrentUserProfile() {
            if (!window.supabaseClient || !isLoggedIn) return;
            
            try {
                const user = window.supabaseClient.getCurrentUser();
                if (!user) return;
                
                const profileResult = await window.supabaseClient.getUserProfile(user.id);
                if (profileResult.success) {
                    const profile = profileResult.data;
                    
                    // 填充表单
                    const nicknameInput = document.getElementById('profile-nickname');
                    const bioInput = document.getElementById('profile-bio');
                    const avatarPreview = document.getElementById('profile-avatar-preview');
                    
                    if (nicknameInput) nicknameInput.value = profile.nickname || '';
                    if (bioInput) bioInput.value = profile.bio || '';
                    if (avatarPreview && profile.avatar_url) {
                        avatarPreview.src = profile.avatar_url;
                    }
                }
            } catch (error) {
                console.error('加载用户资料失败:', error);
            }
        }
        
        // 防止重复同步的标志
        let isSyncingToCloud = false;
        
        async function syncToCloud() {
            if (!window.supabaseClient || !isLoggedIn) {
                showNotification('请先登录以同步数据', 'error');
                return;
            }
            
            // 防止重复调用
            if (isSyncingToCloud) {
                console.log('⏸️ 数据同步正在进行中，跳过重复调用');
                showNotification('数据同步正在进行中，请稍候...', 'info');
                return;
            }
            
            isSyncingToCloud = true;
            console.log('🔄 开始同步数据到云端...');
            console.log('📊 当前存储状态:', { useIndexedDB, db: !!db, isLoggedIn });

            try {
                showNotification('正在同步数据到云端...', 'info');                // 从适当的存储系统获取本地数据
                let localEntries = [];
                if (useIndexedDB && db) {
                    try {
                        localEntries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储获取数据进行云端同步，条目数:', localEntries.length);
                    } catch (error) {
                        console.error('从IndexedDB获取数据失败:', error);
                        // 回退到localStorage
                        localEntries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储获取数据，条目数:', localEntries.length);
                    }
                } else {
                    localEntries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 从传统存储获取数据进行云端同步，条目数:', localEntries.length);
                }
                
                if (localEntries.length === 0) {
                    showNotification('没有本地数据需要同步', 'info');
                    return;
                }
                
                // 获取云端已有数据，避免重复创建
                const cloudResult = await window.supabaseClient.getUserDiaries();
                const existingCloudEntries = cloudResult.success ? cloudResult.data : [];
                
                // 同步到云端
                let syncCount = 0;
                let skipCount = 0;
                
                for (const entry of localEntries) {
                    // 检查云端是否已存在相同的日记（通过标题和内容匹配）
                    const isDuplicate = existingCloudEntries.some(cloudEntry => 
                        cloudEntry.title === entry.title && 
                        cloudEntry.content === entry.content &&
                        cloudEntry.location === entry.location
                    );
                    
                    if (isDuplicate) {
                        skipCount++;
                        console.log(`跳过重复日记: ${entry.title}`);
                        continue;
                    }
                    
                    // 清理数据，只包含数据库表中存在的字段
                    const cleanEntry = {
                        title: entry.title,
                        content: entry.content,
                        location: entry.location,
                        latitude: entry.latitude,
                        longitude: entry.longitude,
                        images: entry.images,
                        tags: entry.tags,
                        weather: entry.weather,
                        mood: entry.mood,
                        date: entry.date  // 包含用户选择的日期
                        // 不包含 id, created_at, favorited 等字段
                    };
                    
                    const result = await window.supabaseClient.saveDiary(cleanEntry);
                    if (result.success) {
                        syncCount++;
                        console.log(`同步成功: ${entry.title}`);
                    }
                }
                
                if (syncCount > 0) {
                    showNotification(`成功同步 ${syncCount} 条新记录到云端${skipCount > 0 ? `，跳过 ${skipCount} 条重复记录` : ''}`, 'success');
                } else {
                    showNotification(skipCount > 0 ? `所有 ${skipCount} 条记录都已存在于云端，无需同步` : '没有数据需要同步', 'info');
                }
                
                // 加载云端数据到共享视图
                loadSharedDiaries();
                
                // 如果当前在云端模式，刷新画廊显示
                if (currentMode === 'cloud' && currentView === 'gallery') {
                    loadEntries();
                }
                
            } catch (error) {
                console.error('同步错误:', error);
                showNotification('同步数据时发生错误：' + error.message, 'error');
            } finally {
                // 重置同步标志
                isSyncingToCloud = false;
                console.log('✅ 数据同步流程完成');
            }
        }
        
        // 防止重复加载的标志
        let isLoadingSharedDiaries = false;
        
        async function loadSharedDiaries() {
            // 防止重复调用
            if (isLoadingSharedDiaries) {
                console.log('⏸️ 共享日记正在加载中，跳过重复调用');
                return;
            }
            
            isLoadingSharedDiaries = true;
            console.log('🌐 开始加载共享日记...');
            console.log('🔍 检查 Supabase 客户端:', !!window.supabaseClient);
            
            if (!window.supabaseClient) {
                console.warn('❌ Supabase客户端未初始化，无法加载共享日记');
                const container = document.getElementById('shared-diaries-container');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-placeholder">
                            <p>云端服务未连接，无法加载共享日记</p>
                        </div>
                    `;
                }
                isLoadingSharedDiaries = false;
                return;
            }
            
            if (!window.supabaseClient.isLoggedIn()) {
                console.warn('❌ 用户未登录，无法加载共享日记');
                const container = document.getElementById('shared-diaries-container');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-placeholder">
                            <p>请先登录以查看共享日记</p>
                        </div>
                    `;
                }
                isLoadingSharedDiaries = false;
                return;
            }
            
            try {
                const container = document.getElementById('shared-diaries-container');
                if (!container) return;
                
                container.innerHTML = `
                    <div class="loading-placeholder">
                        <div class="loading-spinner">🔄</div>
                        <p>正在加载共享日记...</p>
                    </div>
                `;
                
                const result = await window.supabaseClient.getAllDiaries();
                
                console.log('📊 获取共享日记结果:', result);
                
                if (result.success) {
                    console.log('📋 共享日记数据:', result.data);
                    // 调用 HTML 中的 displaySharedDiaries 函数而不是 supabase-client.js 中的
                    displaySharedDiaries(result.data);
                } else {
                    console.error('❌ 获取共享日记失败:', result.error);
                    container.innerHTML = `
                        <div class="loading-placeholder">
                            <p>加载失败：${result.error}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载共享日记失败:', error);
                const container = document.getElementById('shared-diaries-container');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-placeholder">
                            <p>加载失败：${error.message}</p>
                        </div>
                    `;
                }
            } finally {
                // 重置加载标志
                isLoadingSharedDiaries = false;
                console.log('✅ 共享日记加载流程完成');
            }
        }
        
        function displaySharedDiaries(groupedDiaries) {
            console.log('🎯 开始显示共享日记，输入数据:', groupedDiaries);
            
            const container = document.getElementById('shared-diaries-container');
            if (!container) {
                console.error('❌ 找不到共享日记容器');
                return;
            }
            
            console.log('📱 显示共享日记，用户数量:', Object.keys(groupedDiaries).length);
            
            if (Object.keys(groupedDiaries).length === 0) {
                container.innerHTML = `
                    <div class="loading-placeholder">
                        <p>暂无共享日记</p>
                    </div>
                `;
                return;
            }
            
            // 临时使用简单的HTML来排除复杂性问题
            let html = '<div style="padding: 20px;">';
            
            Object.entries(groupedDiaries).forEach(([userId, userData]) => {
                console.log(`👤 处理用户 ${userData.user?.nickname || '匿名'} 的 ${userData.entries.length} 篇日记`);
                
                html += `
                    <div style="background: white; margin-bottom: 20px; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3 style="margin: 0 0 15px 0; color: #333;">
                            ${userData.user?.nickname || '匿名用户'} (${userData.entries.length} 篇日记)
                        </h3>
                `;
                
                userData.entries.forEach(entry => {
                    html += `
                        <div style="background: #f8f9fa; margin-bottom: 10px; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; position: relative;" data-entry-id="${entry.id}" data-entry-type="cloud">
                            ${(() => {
                                const currentUser = window.supabaseClient?.getCurrentUser();
                                const isOwner = currentUser && currentUser.id === entry.user_id;
                                return isOwner ? `
                                    <div style="position: absolute; top: 10px; right: 10px; display: flex; gap: 5px;">
                                        <button class="action-btn edit-btn" 
                                                onclick="editCloudEntry('${entry.id}')"
                                                title="编辑日记"
                                                style="background: #28a745; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            ✏️
                                        </button>
                                        <button class="action-btn delete-btn" 
                                                onclick="confirmDeleteCloudEntry('${entry.id}')"
                                                title="删除日记"
                                                style="background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                            🗑️
                                        </button>
                                    </div>
                                ` : '';
                            })()}
                            <h4 style="margin: 0 0 8px 0; color: #333; padding-right: ${(() => {
                                const currentUser = window.supabaseClient?.getCurrentUser();
                                const isOwner = currentUser && currentUser.id === entry.user_id;
                                return isOwner ? '80px' : '0';
                            })()};">${entry.title || '无标题'}</h4>
                            <p style="margin: 0 0 8px 0; color: #666; line-height: 1.4;">${entry.content || '暂无内容'}</p>
                            <small style="color: #999;">📍 ${entry.location || '未知位置'} | 📅 ${formatDate(entry.date || entry.created_at)}</small>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            html += '</div>';
            
            container.innerHTML = html;
            
            // 强制设置容器样式以确保可见性
            container.style.minHeight = '300px';
            container.style.height = 'auto';
            container.style.display = 'block';
            container.style.visibility = 'visible';
            
            // 立即修复父容器链的高度问题
            const sharedView = document.getElementById('shared-view');
            const mainElement = document.querySelector('main');
            
            if (sharedView) {
                sharedView.style.minHeight = '600px';
                sharedView.style.height = 'auto';
                sharedView.style.display = 'block';
                sharedView.style.flex = '1';
            }
            
            if (mainElement) {
                mainElement.style.minHeight = '500px';
                mainElement.style.height = 'auto';
                mainElement.style.display = 'flex';
                mainElement.style.flexDirection = 'column';
                mainElement.style.flex = '1';
            }
            
            // 深度调试：检查父容器链
            let parent = container.parentElement;
            let level = 0;
            while (parent && level < 5) {
                console.log(`📊 父容器 ${level}:`, {
                    tagName: parent.tagName,
                    id: parent.id,
                    className: parent.className,
                    clientHeight: parent.clientHeight,
                    offsetHeight: parent.offsetHeight,
                    display: window.getComputedStyle(parent).display,
                    height: window.getComputedStyle(parent).height,
                    minHeight: window.getComputedStyle(parent).minHeight
                });
                parent = parent.parentElement;
                level++;
            }
            
            // 尝试使用setTimeout来延迟检查高度
            setTimeout(() => {
                console.log(`⏰ 延迟检查 - 容器状态:`, {
                    clientHeight: container.clientHeight,
                    scrollHeight: container.scrollHeight,
                    offsetHeight: container.offsetHeight
                });
                
                // 如果还是0高度，尝试直接设置像素高度
                if (container.offsetHeight === 0) {
                    container.style.height = '400px';
                    container.style.overflow = 'auto';
                    console.log(`🔧 强制设置固定高度 400px`);
                    
                    // 最后的强制手段：移除可能的CSS限制
                    container.style.maxHeight = 'none';
                    container.style.position = 'relative';
                    container.style.zIndex = '1';
                    
                    // 确保父容器也有高度
                    const sharedView = document.getElementById('shared-view');
                    if (sharedView) {
                        sharedView.style.minHeight = '600px';
                        sharedView.style.height = 'auto';
                    }
                    
                    console.log(`💪 执行最终强制修复`);
                }
                
                // 再次检查
                setTimeout(() => {
                    console.log(`🔍 最终检查:`, {
                        clientHeight: container.clientHeight,
                        offsetHeight: container.offsetHeight,
                        scrollHeight: container.scrollHeight,
                        computedHeight: window.getComputedStyle(container).height,
                        computedMinHeight: window.getComputedStyle(container).minHeight
                    });
                }, 200);
            }, 100);
            
            console.log(`✅ HTML 内容已设置，长度: ${html.length}`);
            console.log(`📐 容器最终状态:`, {
                children: container.children.length,
                clientHeight: container.clientHeight,
                scrollHeight: container.scrollHeight,
                offsetHeight: container.offsetHeight,
                display: container.style.display,
                visibility: container.style.visibility
            });
        }
        
        function createSharedDiaryEntryElement(entry) {
            console.log(`🔧 创建共享日记元素，标题: ${entry.title}, 内容长度: ${entry.content?.length || 0}`);
            
            const entryDiv = document.createElement('div');
            entryDiv.className = 'shared-diary-entry';
            
            // 处理图片数据
            let imagesHtml = '';
            if (entry.images) {
                try {
                    const images = window.supabaseClient.parseImages(entry.images);
                    if (Array.isArray(images) && images.length > 0) {
                        console.log(`🖼️ 找到 ${images.length} 张图片`);
                        imagesHtml = `
                            <div class="entry-images ${images.length === 1 ? 'single' : images.length === 2 ? 'double' : 'multiple'}">
                                ${images.map(img => `<img src="${img}" alt="旅行照片" class="entry-image-thumb" onclick="openImageViewer('${img}')" loading="lazy">`).join('')}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.warn('解析图片数据失败:', error);
                }
            }
            
            const htmlContent = `
                <div class="entry-header">
                    <h4>${escapeHtml(entry.title || '无标题')}</h4>
                    <span class="entry-date">${formatDate(entry.date || entry.created_at)}</span>
                </div>
                <div class="entry-content">
                    <p>${escapeHtml(entry.content || '暂无内容').replace(/\n/g, '<br>')}</p>
                    ${imagesHtml}
                    ${entry.tags && Array.isArray(entry.tags) && entry.tags.length > 0 ? `
                        <div class="entry-tags">
                            ${entry.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    ` : ''}
                    ${entry.weather ? `<div class="weather-info">🌤️ ${escapeHtml(entry.weather)}</div>` : ''}
                    ${entry.mood ? `<div class="mood-info">😊 ${escapeHtml(entry.mood)}</div>` : ''}
                </div>
                <div class="entry-location">
                    <i class="location-icon">📍</i>
                    <span>${escapeHtml(entry.location || '未知位置')}</span>
                </div>
            `;
            
            entryDiv.innerHTML = htmlContent;
            console.log(`✨ 日记元素创建完成，HTML长度: ${htmlContent.length}`);
            
            return entryDiv;
        }

        // 云端数据加载函数
        async function loadCloudEntries() {
            console.log('☁️ 加载用户自己的云端日记');
            console.log('🔍 Supabase客户端状态:', !!window.supabaseClient);
            console.log('🔍 用户登录状态:', window.supabaseClient?.isLoggedIn());
            
            const gallery = document.getElementById('gallery');
            const emptyState = document.getElementById('empty-state');
            
            try {
                // 只获取当前用户的日记
                console.log('📡 开始获取用户日记...');
                const result = await window.supabaseClient.getUserDiaries();
                console.log('📡 获取用户日记结果:', result);
                
                if (!result.success) {
                    throw new Error(result.error);
                }
                
                const userEntries = result.data || [];
                console.log('📋 用户日记数量:', userEntries.length);
                
                if (userEntries.length === 0) {
                    gallery.innerHTML = '';
                    emptyState.style.display = 'block';
                    console.log('📭 没有云端日记');
                    return;
                }
                
                emptyState.style.display = 'none';
                
                // 按用户选择的日期排序（如果没有则用创建时间）
                userEntries.sort((a, b) => {
                    const dateA = new Date(a.date || a.created_at);
                    const dateB = new Date(b.date || b.created_at);
                    return dateB - dateA;
                });
                
                // 生成HTML
                const html = userEntries.map(entry => `
                    <div class="entry-card" data-entry-id="${entry.id}">
                        <div class="entry-actions">
                            <button class="action-btn favorite-btn ${entry.favorited ? 'favorited' : ''}" 
                                    onclick="toggleCloudFavorite('${entry.id}')"
                                    title="${entry.favorited ? '取消收藏' : '添加到收藏'}">
                                ${entry.favorited ? '❤️' : '🤍'}
                            </button>
                            <button class="action-btn edit-btn" 
                                    onclick="editCloudEntry('${entry.id}')"
                                    title="编辑云端日记">
                                ✏️
                            </button>
                            <button class="action-btn delete-btn" 
                                    onclick="confirmDeleteCloudEntry('${entry.id}')"
                                    title="删除云端日记">
                                🗑️
                            </button>
                        </div>
                        <h3>${escapeHtml(entry.title || '无标题')}</h3>
                        <div class="entry-meta">
                            📅 ${formatDate(entry.created_at)} | 📍 ${escapeHtml(entry.location || '未知位置')}
                        </div>
                        ${entry.images && entry.images.length > 0 ? `
                            <div class="entry-images ${entry.images.length === 1 ? 'single' : entry.images.length === 2 ? 'double' : 'multiple'}">
                                ${entry.images.map(imageData => `<img src="${imageData}" alt="旅行照片" loading="lazy">`).join('')}
                            </div>
                        ` : ''}
                        <div class="entry-content">
                            <p>${escapeHtml(entry.content).replace(/\n/g, '<br>')}</p>
                            ${entry.tags && entry.tags.length > 0 ? `
                                <div class="entry-tags">
                                    ${entry.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                                </div>
                            ` : ''}
                            ${entry.weather ? `<div class="weather-info">🌤️ ${escapeHtml(entry.weather)}</div>` : ''}
                            ${entry.mood ? `<div class="mood-info">😊 ${escapeHtml(entry.mood)}</div>` : ''}
                        </div>
                        <span class="entry-date">${formatDate(entry.created_at)}</span>
                    </div>
                `).join('');
                
                gallery.innerHTML = html;
                console.log(`✅ 加载了 ${userEntries.length} 条用户云端日记`);
                
            } catch (error) {
                console.error('❌ 加载云端日记失败:', error);
                gallery.innerHTML = '<div class="error-message">加载云端日记失败：' + error.message + '</div>';
            }
        }

        async function loadEntries() {
            console.log('📚 加载日记');
            console.log('🔍 当前模式:', currentMode, '登录状态:', isLoggedIn, 'Supabase客户端:', !!window.supabaseClient);
            
            // 如果是云端模式且已登录，加载云端数据
            if (currentMode === 'cloud' && isLoggedIn && window.supabaseClient) {
                console.log('☁️ 使用云端模式加载日记');
                loadCloudEntries();
                return;
            }
            
            // 本地模式：从大容量存储或localStorage加载
            const gallery = document.getElementById('gallery');
            const emptyState = document.getElementById('empty-state');
            
            try {
                let entries = [];
                
                if (useIndexedDB && db) {
                    // 从 IndexedDB 加载（支持大容量）
                    console.log('📖 从大容量存储加载数据...');
                    entries = await getFromIndexedDB('diaries');
                    console.log(`✅ 从大容量存储加载了 ${entries.length} 条日记`);
                } else {
                    // 从 localStorage 加载（传统方式）
                    console.log('📖 从传统存储加载数据...');
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log(`✅ 从传统存储加载了 ${entries.length} 条日记`);
                }
                
                if (entries.length === 0) {
                    gallery.innerHTML = '';
                    emptyState.style.display = 'block';
                    console.log('📭 没有日记');
                    return;
                }
                
                emptyState.style.display = 'none';
                
                // 按日期排序（兼容新旧字段名）
                entries.sort((a, b) => new Date(b.created_at || b.created) - new Date(a.created_at || a.created));
                
                // 生成HTML
                const html = entries.map(entry => `
                    <div class="entry-card" data-entry-id="${entry.id}">
                        <div class="entry-actions">
                            <button class="action-btn favorite-btn ${entry.favorited ? 'favorited' : ''}" 
                                    onclick="toggleFavorite(${entry.id})"
                                    title="${entry.favorited ? '取消收藏' : '添加到收藏'}">
                                ${entry.favorited ? '❤️' : '🤍'}
                            </button>
                            <button class="action-btn edit-btn" 
                                    onclick="editEntry(${entry.id})"
                                    title="编辑日记">
                                ✏️
                            </button>
                            <button class="action-btn delete-btn" 
                                    onclick="confirmDeleteEntry(${entry.id})"
                                    title="删除日记">
                                🗑️
                            </button>
                        </div>
                        <h3>${escapeHtml(entry.title)}</h3>
                        <div class="entry-meta">
                            📅 ${formatDate(entry.created_at || entry.date)} | 📍 ${escapeHtml(entry.location)}
                        </div>
                        ${entry.images && entry.images.length > 0 ? `
                            <div class="entry-images ${entry.images.length === 1 ? 'single' : entry.images.length === 2 ? 'double' : 'multiple'}">
                                ${entry.images.map((imageSrc, index) => `
                                    <img src="${imageSrc}" 
                                         alt="旅行图片 ${index + 1}" 
                                         class="entry-image" 
                                         onclick="openImageViewer('${imageSrc}')">
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="entry-content">
                            ${escapeHtml(entry.content.length > 120 ? entry.content.substring(0, 120) + '...' : entry.content)}
                        </div>
                        <div class="entry-tags">
                            ${entry.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
                
                gallery.innerHTML = html;
                
                console.log(`✅ 加载了 ${entries.length} 个日记`);
                
                // 更新地图标记
                if (currentView === 'map') {
                    updateMapMarkers();
                }
                
            } catch (error) {
                console.error('❌ 加载失败:', error);
                gallery.innerHTML = '<p style="text-align: center; color: red;">❌ 数据加载失败</p>';
            }
        }
        
        async function updateStats() {
            try {
                let localEntries = [];
                let cloudEntries = [];
                
                // 获取本地数据
                if (useIndexedDB && db) {
                    try {
                        localEntries = await getFromIndexedDB('diaries');
                        console.log('📊 从大容量存储获取本地统计数据');
                    } catch (error) {
                        console.error('从IndexedDB获取统计数据失败:', error);
                        // 回退到localStorage
                        localEntries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📊 回退到传统存储获取本地统计数据');
                    }
                } else {
                    localEntries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📊 从传统存储获取本地统计数据');
                }
                
                // 获取云端数据
                if (window.supabaseClient && window.supabaseClient.currentUser) {
                    try {
                        const result = await window.supabaseClient.getAllDiaries();
                        if (result.success && result.data) {
                            // getAllDiaries 返回的是分组数据，需要提取所有日记
                            const groupedData = result.data;
                            console.log('📊 从云端获取分组数据:', groupedData);
                            
                            // 提取所有用户的日记到一个数组中
                            cloudEntries = [];
                            if (typeof groupedData === 'object' && groupedData !== null) {
                                Object.values(groupedData).forEach(userData => {
                                    if (userData.entries && Array.isArray(userData.entries)) {
                                        cloudEntries.push(...userData.entries);
                                    }
                                });
                            }
                            console.log('📊 从云端获取统计数据:', cloudEntries.length);
                        }
                    } catch (error) {
                        console.error('获取云端统计数据失败:', error);
                        cloudEntries = []; // 确保有默认值
                    }
                } else {
                    cloudEntries = []; // 确保有默认值
                }
                
                // 合并数据进行统计
                const allEntries = [...localEntries, ...cloudEntries];
                
                // 总日记数 (本地 + 云端)
                const totalEntriesEl = document.getElementById('total-entries');
                if (totalEntriesEl) {
                    const localCount = localEntries.length;
                    const cloudCount = cloudEntries.length;
                    if (cloudCount > 0) {
                        totalEntriesEl.innerHTML = `${localCount + cloudCount}<br><small style="font-size: 0.7em; color: #374151; font-weight: 500;">本地: ${localCount} | 云端: ${cloudCount}</small>`;
                    } else {
                        totalEntriesEl.textContent = localCount;
                    }
                }
                
                // 收藏数量 (本地 + 云端)
                const localFavoriteCount = localEntries.filter(entry => entry.favorited).length;
                const cloudFavoriteCount = cloudEntries.filter(entry => entry.liked || entry.favorited).length;
                const totalFavoritesEl = document.getElementById('total-favorites');
                if (totalFavoritesEl) {
                    if (cloudFavoriteCount > 0) {
                        totalFavoritesEl.innerHTML = `${localFavoriteCount + cloudFavoriteCount}<br><small style="font-size: 0.7em; color: #374151; font-weight: 500;">本地: ${localFavoriteCount} | 云端: ${cloudFavoriteCount}</small>`;
                    } else {
                        totalFavoritesEl.textContent = localFavoriteCount;
                    }
                }
                
                // 地点数 (本地 + 云端)
                const places = new Set([
                    ...localEntries.map(entry => entry.location).filter(loc => loc),
                    ...cloudEntries.map(entry => entry.location).filter(loc => loc)
                ]);
                const totalPlacesEl = document.getElementById('total-places');
                if (totalPlacesEl) totalPlacesEl.textContent = places.size;
                
                // 标签数 (本地 + 云端)
                const tags = new Set();
                allEntries.forEach(entry => {
                    if (entry.tags && Array.isArray(entry.tags)) {
                        entry.tags.forEach(tag => tags.add(tag));
                    }
                });
                const totalTagsEl = document.getElementById('total-tags');
                if (totalTagsEl) totalTagsEl.textContent = tags.size;
                
                // 存储使用量
                const storageSize = await getStorageSize();
                const storageElement = document.getElementById('storage-usage');
                if (storageElement) {
                    storageElement.textContent = formatStorageSize(storageSize);
                    
                    // 根据使用量改变颜色
                    const maxSize = useIndexedDB ? (100 * 1024 * 1024) : (8 * 1024 * 1024); // 100MB vs 8MB
                    const percentage = storageSize / maxSize;
                    
                    if (percentage > 0.9) {
                        storageElement.style.color = '#ef4444'; // 红色
                    } else if (percentage > 0.7) {
                        storageElement.style.color = '#f59e0b'; // 橙色
                    } else {
                        storageElement.style.color = ''; // 默认颜色
                    }
                }
                
            } catch (error) {
                console.error('📊 统计更新失败:', error);
            }
        }
        
        // 切换收藏状态
        async function toggleFavorite(entryId) {
            console.log('⭐ 切换收藏状态:', entryId);
            
            try {
                let entries = [];
                let entryIndex = -1;
                
                // 从适当的存储系统获取数据
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储获取数据进行收藏操作');
                    } catch (error) {
                        console.error('从IndexedDB获取数据失败:', error);
                        // 回退到localStorage
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储获取数据');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 从传统存储获取数据进行收藏操作');
                }
                
                entryIndex = entries.findIndex(entry => entry.id === entryId);
                
                if (entryIndex !== -1) {
                    entries[entryIndex].favorited = !entries[entryIndex].favorited;
                    
                    // 保存到适当的存储系统
                    if (useIndexedDB && db) {
                        try {
                            await saveToIndexedDB('diaries', entries);
                            console.log('✅ 收藏状态已保存到大容量存储');
                        } catch (error) {
                            console.error('保存到IndexedDB失败:', error);
                            // 回退到localStorage
                            localStorage.setItem('travelDiary', JSON.stringify(entries));
                            console.log('📖 回退到传统存储保存');
                        }
                    } else {
                        localStorage.setItem('travelDiary', JSON.stringify(entries));
                        console.log('✅ 收藏状态已保存到传统存储');
                    }
                    
                    // 更新UI
                    const button = document.querySelector(`[data-entry-id="${entryId}"] .favorite-btn`);
                    if (button) {
                        const isFavorited = entries[entryIndex].favorited;
                        button.classList.toggle('favorited', isFavorited);
                        button.innerHTML = isFavorited ? '❤️' : '🤍';
                        button.title = isFavorited ? '取消收藏' : '添加到收藏';
                        
                        // 添加点击动画效果
                        button.style.transform = 'scale(1.3)';
                        setTimeout(() => {
                            button.style.transform = '';
                        }, 200);
                    }
                    
                    // 更新统计
                    updateStats();
                    
                    // 如果当前在收藏视图，刷新收藏列表
                    if (currentView === 'favorites') {
                        loadFavorites();
                    }
                    
                    console.log('✅ 收藏状态更新成功');
                } else {
                    console.error('❌ 未找到日记条目:', entryId);
                    alert('❌ 找不到该日记条目');
                }
            } catch (error) {
                console.error('❌ 收藏操作失败:', error);
                alert('❌ 收藏操作失败');
            }
        }
        
        // 切换云端日记收藏状态
        async function toggleCloudFavorite(entryId) {
            console.log('⭐ 切换云端日记收藏状态:', entryId);
            
            if (!window.supabaseClient) {
                alert('❌ 云端服务未连接');
                return;
            }
            
            try {
                const result = await window.supabaseClient.toggleDiaryLike(entryId);
                
                if (result.success) {
                    // 更新按钮显示
                    const button = document.querySelector(`[data-entry-id="${entryId}"] .favorite-btn`);
                    if (button) {
                        if (result.isLiked) {
                            button.innerHTML = '❤️';
                            button.classList.add('favorited');
                            button.title = '取消收藏';
                        } else {
                            button.innerHTML = '🤍';
                            button.classList.remove('favorited');
                            button.title = '添加到收藏';
                        }
                    }
                    
                    console.log('✅ 云端收藏状态更新成功');
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                console.error('❌ 云端收藏操作失败:', error);
                alert('❌ 收藏操作失败: ' + error.message);
            }
        }
        
        // 加载收藏的日记
        async function loadFavorites() {
            console.log('⭐ 加载收藏日记');
            
            const favoritesGallery = document.getElementById('favorites-gallery');
            const favoritesEmptyState = document.getElementById('favorites-empty-state');
            
            try {
                let entries = [];
                
                // 从适当的存储系统获取数据
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储获取收藏数据');
                    } catch (error) {
                        console.error('从IndexedDB获取数据失败:', error);
                        // 回退到localStorage
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储获取收藏数据');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 从传统存储获取收藏数据');
                }
                
                const favoriteEntries = entries.filter(entry => entry.favorited);
                
                if (favoriteEntries.length === 0) {
                    favoritesGallery.innerHTML = '';
                    favoritesEmptyState.style.display = 'block';
                    console.log('⭐ 没有收藏的日记');
                    return;
                }
                
                favoritesEmptyState.style.display = 'none';
                
                // 按日期排序
                favoriteEntries.sort((a, b) => new Date(b.created_at || b.created) - new Date(a.created_at || a.created));
                
                // 生成HTML
                const html = favoriteEntries.map(entry => `
                    <div class="entry-card" data-entry-id="${entry.id}">
                        <div class="entry-actions">
                            <button class="action-btn favorite-btn favorited" 
                                    onclick="toggleFavorite('${entry.id}')"
                                    title="取消收藏">
                                ❤️
                            </button>
                            <button class="action-btn edit-btn" 
                                    onclick="editEntry('${entry.id}')"
                                    title="编辑日记">
                                ✏️
                            </button>
                            <button class="action-btn delete-btn" 
                                    onclick="confirmDeleteEntry(${entry.id})"
                                    title="删除日记">
                                🗑️
                            </button>
                        </div>
                        <h3>${escapeHtml(entry.title)}</h3>
                        <div class="entry-meta">
                            📅 ${formatDate(entry.created_at || entry.date)} | 📍 ${escapeHtml(entry.location)}
                        </div>
                        ${entry.images && entry.images.length > 0 ? `
                            <div class="entry-images ${entry.images.length === 1 ? 'single' : entry.images.length === 2 ? 'double' : 'multiple'}">
                                ${entry.images.map((imageSrc, index) => `
                                    <img src="${imageSrc}" 
                                         alt="旅行图片 ${index + 1}" 
                                         class="entry-image" 
                                         onclick="openImageViewer('${imageSrc}')">
                                `).join('')}
                            </div>
                        ` : ''}
                        <div class="entry-content">
                            ${escapeHtml(entry.content.length > 120 ? entry.content.substring(0, 120) + '...' : entry.content)}
                        </div>
                        <div class="entry-tags">
                            ${entry.tags.map(tag => `<span class="tag">${escapeHtml(tag)}</span>`).join('')}
                        </div>
                    </div>
                `).join('');
                
                favoritesGallery.innerHTML = html;
                
                console.log(`✅ 加载了 ${favoriteEntries.length} 个收藏日记`);
                
            } catch (error) {
                console.error('❌ 收藏加载失败:', error);
                favoritesGallery.innerHTML = '<p style="text-align: center; color: red;">❌ 收藏数据加载失败</p>';
            }
        }
        
        // 创建流星雨效果
        function createMeteorShower() {
            const meteorCount = 5;
            
            for (let i = 0; i < meteorCount; i++) {
                setTimeout(() => {
                    const meteor = document.createElement('div');
                    // 流星从屏幕上方随机位置开始
                    const startX = Math.random() * (window.innerWidth + 200) - 100;
                    const startY = -100;
                    // 流星斜向下方划过，模拟真实流星轨迹
                    const endX = startX + (Math.random() * 300 + 200); // 向右下倾斜
                    const endY = window.innerHeight + 100;
                    // 大幅增加持续时间，让流星更慢更优雅
                    const duration = Math.random() * 3000 + 4000; // 从 1500+2000 改为 3000+4000
                    
                    meteor.style.cssText = `
                        position: fixed;
                        left: ${startX}px;
                        top: ${startY}px;
                        width: 4px;
                        height: 4px;
                        background: radial-gradient(circle, #fff 0%, rgba(255,255,255,0.8) 40%, transparent 100%);
                        border-radius: 50%;
                        box-shadow: 
                            0 0 15px rgba(255,255,255,0.9),
                            0 0 30px rgba(255,255,255,0.6),
                            0 0 45px rgba(255,255,255,0.3);
                        pointer-events: none;
                        z-index: -1;
                    `;
                    
                    // 添加流星尾巴 - 根据运动方向调整
                    const tailAngle = Math.atan2(endY - startY, endX - startX) * 180 / Math.PI;
                    meteor.innerHTML = `
                        <div style="
                            position: absolute;
                            width: 120px;
                            height: 3px;
                            background: linear-gradient(90deg, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0.6) 20%, rgba(255,255,255,0.3) 50%, transparent 100%);
                            top: 50%;
                            right: 100%;
                            transform: translateY(-50%) rotate(${tailAngle}deg);
                            transform-origin: right center;
                            border-radius: 2px;
                            box-shadow: 0 0 10px rgba(255,255,255,0.5);
                        "></div>
                    `;
                    
                    document.body.appendChild(meteor);
                    
                    // 流星动画 - 从上到下的优雅抛物线运动
                    meteor.animate([
                        {
                            left: startX + 'px',
                            top: startY + 'px',
                            opacity: 0,
                            transform: 'scale(0.5)'
                        },
                        {
                            left: (startX + (endX - startX) * 0.15) + 'px',
                            top: (startY + (endY - startY) * 0.15) + 'px',
                            opacity: 1,
                            transform: 'scale(1)'
                        },
                        {
                            left: (startX + (endX - startX) * 0.85) + 'px',
                            top: (startY + (endY - startY) * 0.85) + 'px',
                            opacity: 1,
                            transform: 'scale(1)'
                        },
                        {
                            left: endX + 'px',
                            top: endY + 'px',
                            opacity: 0,
                            transform: 'scale(0.3)'
                        }
                    ], {
                        duration: duration,
                        easing: 'cubic-bezier(0.15, 0.25, 0.35, 0.85)' // 更平滑的缓动函数
                    }).onfinish = () => {
                        meteor.remove();
                    };
                    
                }, i * (Math.random() * 1500 + 1000)); // 增加流星间隔时间
            }
        }

        // 创建星空粒子效果
        function createParticles() {
            const particleCount = 40; // 减少数量，让效果更精致
            const colors = ['#ffffff', '#e6f3ff', '#cce7ff', '#b3dbff', '#99cfff', '#80c3ff'];
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const size = Math.random() * 3 + 1; // 更小的星光粒子
                    
                    particle.style.cssText = `
                        position: fixed;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        border-radius: 50%;
                        left: ${Math.random() * 100}%;
                        bottom: -10px;
                        pointer-events: none;
                        z-index: -1;
                        box-shadow: 
                            0 0 ${size * 3}px ${color},
                            0 0 ${size * 6}px rgba(255,255,255,0.3);
                        animation: starlight-float ${Math.random() * 6 + 8}s ease-out forwards;
                    `;
                    
                    document.body.appendChild(particle);
                    
                    // 粒子完成动画后移除
                    setTimeout(() => {
                        if (particle.parentNode) {
                            particle.remove();
                        }
                    }, 15000);
                }, i * 200); // 增加间隔，让效果更舒缓
            }
        }

        // 页面转换效果
        function showPageTransition(message = '加载中...') {
            const transition = document.createElement('div');
            transition.className = 'page-transition';
            transition.innerHTML = `
                <div class="transition-content">
                    <div class="transition-spinner"></div>
                    <h3>${message}</h3>
                </div>
            `;
            
            document.body.appendChild(transition);
            
            setTimeout(() => {
                transition.classList.add('active');
            }, 10);
            
            return transition;
        }

        function hidePageTransition(transition) {
            transition.classList.remove('active');
            setTimeout(() => {
                transition.remove();
            }, 600);
        }

        // 鼠标炫彩跟随特效
        function createMouseTrail(e) {
            const colors = ['#ff6b9d', '#64ffda', '#ffd93d', '#6bcf7f'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            
            const trail = document.createElement('div');
            trail.style.cssText = `
                position: fixed;
                width: 8px;
                height: 8px;
                background: ${color};
                border-radius: 50%;
                pointer-events: none;
                z-index: 999;
                left: ${e.clientX - 4}px;
                top: ${e.clientY - 4}px;
                box-shadow: 0 0 10px ${color}, 0 0 20px ${color};
                animation: trail-fade 1.2s ease-out forwards;
            `;
            
            document.body.appendChild(trail);
            
            setTimeout(() => {
                trail.remove();
            }, 1200);
        }

        // 添加鼠标轨迹动画
        const trailStyle = document.createElement('style');
        trailStyle.textContent = `
            @keyframes trail-fade {
                0% {
                    transform: scale(1);
                    opacity: 1;
                }
                100% {
                    transform: scale(0);
                    opacity: 0;
                }
            }
        `;
        document.head.appendChild(trailStyle);

        // 创建点击波纹效果
        function createRippleEffect(element, event) {
            const ripple = document.createElement('div');
            const rect = element.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            const x = event.clientX - rect.left - size / 2;
            const y = event.clientY - rect.top - size / 2;
            
            ripple.style.cssText = `
                position: absolute;
                width: ${size}px;
                height: ${size}px;
                border-radius: 50%;
                background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, transparent 70%);
                transform: translate(${x}px, ${y}px) scale(0);
                pointer-events: none;
                z-index: 1000;
            `;
            
            element.appendChild(ripple);
            
            // 创建波纹动画
            ripple.animate([
                { transform: `translate(${x}px, ${y}px) scale(0)`, opacity: 1 },
                { transform: `translate(${x}px, ${y}px) scale(1)`, opacity: 0 }
            ], {
                duration: 600,
                easing: 'ease-out'
            }).onfinish = () => {
                ripple.remove();
            };
        }

        // 创建炫彩庆祝粒子效果
        function createCelebrationParticles() {
            const colors = ['#ff6b9d', '#64ffda', '#ffd93d', '#6bcf7f', '#ff8a65', '#ba68c8', '#4fc3f7', '#ffb74d'];
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                setTimeout(() => {
                    const particle = document.createElement('div');
                    const color = colors[Math.floor(Math.random() * colors.length)];
                    const size = Math.random() * 12 + 6;
                    
                    particle.style.cssText = `
                        position: fixed;
                        width: ${size}px;
                        height: ${size}px;
                        background: ${color};
                        border-radius: 50%;
                        left: 50%;
                        top: 50%;
                        pointer-events: none;
                        z-index: 9999;
                        transform: translate(-50%, -50%);
                        box-shadow: 
                            0 0 10px ${color}, 
                            0 0 20px ${color}, 
                            0 0 30px ${color};
                    `;
                    
                    document.body.appendChild(particle);
                    
                    // 随机方向爆炸效果
                    const angle = (Math.PI * 2 * i) / particleCount;
                    const velocity = Math.random() * 300 + 150;
                    const gravity = 400;
                    
                    const deltaX = Math.cos(angle) * velocity;
                    const deltaY = Math.sin(angle) * velocity;
                    
                    particle.animate([
                        {
                            transform: 'translate(-50%, -50%) scale(1)',
                            opacity: 1
                        },
                        {
                            transform: `translate(calc(-50% + ${deltaX}px), calc(-50% + ${deltaY - gravity}px)) scale(0)`,
                            opacity: 0
                        }
                    ], {
                        duration: 1500,
                        easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                    }).onfinish = () => {
                        particle.remove();
                    };
                }, i * 20);
            }
        }

        // 页面加载完成后创建粒子效果
        let particleIntervalId = null;
        let meteorIntervalId = null;
        
        window.addEventListener('load', () => {
            // 隐藏页面加载器
            hidePageLoader();
            
            createParticles();
            createMeteorShower();
            
            // 清理之前的定时器（防止重复创建）
            if (particleIntervalId) clearInterval(particleIntervalId);
            if (meteorIntervalId) clearInterval(meteorIntervalId);
            
            // 每30秒创建一次星空粒子效果（降低频率）
            particleIntervalId = setInterval(() => {
                // 检查页面是否仍然可见
                if (!document.hidden) {
                    createParticles();
                }
            }, 30000);
            
            // 每60秒创建一次流星雨（大幅降低频率）
            meteorIntervalId = setInterval(() => {
                // 检查页面是否仍然可见
                if (!document.hidden) {
                    createMeteorShower();
                }
            }, 60000);
            
            // 添加鼠标轨迹效果（节流处理）
            let lastTrail = 0;
            document.addEventListener('mousemove', (e) => {
                const now = Date.now();
                if (now - lastTrail > 50) { // 限制频率
                    createMouseTrail(e);
                    lastTrail = now;
                }
            });
            
            // 为所有按钮添加波纹效果
            document.addEventListener('click', (e) => {
                if (e.target.matches('.btn, .add-btn, .nav-tab, .entry-card')) {
                    const element = e.target;
                    
                    // 特殊处理固定定位的按钮（如add-btn）
                    if (element.classList.contains('add-btn')) {
                        // add-btn已经是fixed定位，不需要改变position
                        createRippleEffect(element, e);
                    } else {
                        // 确保其他元素有相对定位
                        const originalPosition = element.style.position;
                        if (!originalPosition || originalPosition === 'static') {
                            element.style.position = 'relative';
                        }
                        element.style.overflow = 'hidden';
                        
                        createRippleEffect(element, e);
                    }
                }
            });
        });

        function showSuccessMessage(message) {
            // 创建成功提示
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 16px 24px;
                border-radius: 16px;
                box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4);
                z-index: 10001;
                font-weight: 600;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                transform: translateX(100%);
                transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            `;
            successDiv.textContent = message;
            
            document.body.appendChild(successDiv);
            
            // 触发入场动画
            setTimeout(() => {
                successDiv.style.transform = 'translateX(0)';
            }, 10);
            
            // 添加浮动效果
            setTimeout(() => {
                successDiv.style.animation = 'float 2s ease-in-out infinite';
            }, 400);
            
            // 退场动画
            setTimeout(() => {
                successDiv.style.transform = 'translateX(100%)';
                successDiv.style.opacity = '0';
                setTimeout(() => {
                    successDiv.remove();
                }, 400);
            }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            // 如果没有传入日期字符串，返回空字符串
            if (!dateString) return '';
            
            try {
                const date = new Date(dateString);
                
                // 检查日期是否有效
                if (isNaN(date.getTime())) {
                    console.log('⚠️ 无效日期格式:', dateString);
                    return dateString; // 返回原始字符串
                }
                
                // 使用手动格式化确保一致性，避免浏览器差异
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                
                return `${year}-${month}-${day}`;
            } catch (error) {
                console.error('❌ 日期格式化错误:', error);
                return dateString; // 发生错误时返回原始字符串
            }
        }
        
        // =========== 地图相关功能 ===========
        
        function initMap() {
            console.log('🗺️ 初始化地图...');
            
            // 创建地图实例
            map = L.map('map').setView([39.9042, 116.4074], 5); // 默认显示中国
            
            // 尝试添加地图图层 - 使用多个备用服务
            let mapLayerAdded = false;
            
            // 地图瓦片服务列表（按优先级排序，优先使用国内服务）
            const tileServices = [
                {
                    name: '高德地图卫星图',
                    url: 'https://webst0{s}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}',
                    attribution: '© 高德地图',
                    timeout: 3000,
                    subdomains: ['1', '2', '3', '4']
                },
                {
                    name: '高德地图标准图',
                    url: 'https://webrd0{s}.is.autonavi.com/appmaptile?lang=zh_cn&size=1&scale=1&style=8&x={x}&y={y}&z={z}',
                    attribution: '© 高德地图',
                    timeout: 3000,
                    subdomains: ['1', '2', '3', '4']
                },
                {
                    name: '天地图矢量',
                    url: 'https://t{s}.tianditu.gov.cn/vec_w/wmts?SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&FORMAT=tiles&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&tk=你的天地图key',
                    attribution: '© 天地图',
                    timeout: 3000,
                    subdomains: ['0', '1', '2', '3', '4', '5', '6', '7']
                },
                {
                    name: 'OpenStreetMap镜像',
                    url: 'https://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png',
                    attribution: '© OpenStreetMap contributors',
                    timeout: 5000,
                    subdomains: ['a', 'b', 'c']
                },
                {
                    name: 'CartoDB Positron',
                    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                    attribution: '© OpenStreetMap contributors © CARTO',
                    timeout: 5000,
                    subdomains: ['a', 'b', 'c', 'd']
                }
            ];
            
            // 尝试加载地图瓦片
            tryLoadMapTiles(tileServices, 0);
            
            // 创建标记图层组
            markersLayer = L.layerGroup().addTo(map);
            
            // 添加地图加载状态监听
            map.on('tileloadstart', function() {
                console.log('🔄 地图瓦片开始加载...');
            });
            
            map.on('tileload', function() {
                if (!mapLayerAdded) {
                    mapLayerAdded = true;
                    console.log('✅ 地图瓦片加载成功');
                }
            });
            
            map.on('tileerror', function(e) {
                console.warn('⚠️ 地图瓦片加载失败:', e);
            });
            
            console.log('✅ 地图初始化完成');
        }
        
        function tryLoadMapTiles(services, index) {
            if (index >= services.length) {
                console.error('❌ 所有地图服务都无法访问');
                showMapError();
                return;
            }
            
            const service = services[index];
            console.log(`🌐 尝试加载地图服务: ${service.name}`);
            
            try {
                const layerOptions = {
                    attribution: service.attribution,
                    maxZoom: 19,
                    timeout: service.timeout,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==' // 1x1透明图片
                };
                
                // 如果服务指定了subdomains，添加到配置中
                if (service.subdomains) {
                    layerOptions.subdomains = service.subdomains;
                }
                
                const layer = L.tileLayer(service.url, layerOptions);
                
                // 测试加载一个瓦片
                const testImg = new Image();
                testImg.onload = function() {
                    console.log(`✅ ${service.name} 可用，应用到地图`);
                    layer.addTo(map);
                };
                
                testImg.onerror = function() {
                    console.warn(`❌ ${service.name} 不可用，尝试下一个服务`);
                    setTimeout(() => tryLoadMapTiles(services, index + 1), 500);
                };
                
                // 构造测试URL
                let testUrl = service.url;
                
                // 处理不同的URL模式
                if (service.subdomains && service.subdomains.length > 0) {
                    testUrl = testUrl.replace('{s}', service.subdomains[0]);
                } else {
                    testUrl = testUrl.replace('{s}', 'a');
                }
                
                testUrl = testUrl
                    .replace('{z}', '1')
                    .replace('{x}', '0')
                    .replace('{y}', '0')
                    .replace('{r}', '');
                
                testImg.src = testUrl;
                
                // 设置超时
                setTimeout(() => {
                    if (!testImg.complete) {
                        console.warn(`⏰ ${service.name} 超时，尝试下一个服务`);
                        tryLoadMapTiles(services, index + 1);
                    }
                }, service.timeout);
                
            } catch (error) {
                console.error(`❌ ${service.name} 初始化失败:`, error);
                tryLoadMapTiles(services, index + 1);
            }
        }
        
        function showMapError() {
            const mapContainer = document.getElementById('map');
            if (mapContainer) {
                mapContainer.innerHTML = `
                    <div style="
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: center;
                        height: 100%;
                        background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                        border-radius: 12px;
                        color: #6b7280;
                        text-align: center;
                        padding: 40px 20px;
                        position: relative;
                    ">
                        <div style="font-size: 48px; margin-bottom: 16px;">🗺️</div>
                        <h3 style="margin: 0 0 8px 0; color: #374151;">地图服务暂时不可用</h3>
                        <p style="margin: 0 0 16px 0; font-size: 0.875rem;">网络连接可能不稳定，显示简化地图</p>
                        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                            <button onclick="location.reload()" style="
                                background: #3b82f6;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.875rem;
                            ">🔄 重新加载</button>
                            <button onclick="showOfflineMap()" style="
                                background: #10b981;
                                color: white;
                                border: none;
                                padding: 8px 16px;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 0.875rem;
                            ">📍 查看位置列表</button>
                        </div>
                        <div id="offline-locations" style="display: none; width: 100%; max-height: 300px; overflow-y: auto;"></div>
                    </div>
                `;
            }
        }
        
        function showOfflineMap() {
            console.log('📍 显示离线位置列表...');
            
            const offlineDiv = document.getElementById('offline-locations');
            if (!offlineDiv) return;
            
            try {
                const entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                
                if (entries.length === 0) {
                    offlineDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #9ca3af;">
                            还没有保存的旅行记录
                        </div>
                    `;
                } else {
                    const html = entries.map(entry => `
                        <div style="
                            background: white;
                            margin: 8px 0;
                            padding: 12px;
                            border-radius: 8px;
                            border: 1px solid #e5e7eb;
                            text-align: left;
                        ">
                            <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                                📍 ${escapeHtml(entry.location)}
                            </div>
                            <div style="font-size: 0.875rem; color: #6b7280; margin-bottom: 6px;">
                                ${escapeHtml(entry.title)} | ${formatDate(entry.created_at || entry.date)}
                            </div>
                            ${entry.latitude && entry.longitude ? `
                                <div style="font-size: 0.75rem; color: #9ca3af;">
                                    坐标: ${entry.latitude.toFixed(4)}, ${entry.longitude.toFixed(4)}
                                    <button onclick="openInExternalMap(${entry.latitude}, ${entry.longitude}, '${encodeURIComponent(entry.location)}')" 
                                            style="margin-left: 8px; background: #3b82f6; color: white; border: none; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; cursor: pointer;">
                                        🌐 外部地图
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `).join('');
                    
                    offlineDiv.innerHTML = html;
                }
                
                offlineDiv.style.display = 'block';
                
            } catch (error) {
                console.error('❌ 加载位置列表失败:', error);
                offlineDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #dc2626;">
                        加载位置列表失败
                    </div>
                `;
                offlineDiv.style.display = 'block';
            }
        }
        
        // 全局函数：在外部地图中打开位置
        window.openInExternalMap = function(lat, lon, name) {
            const urls = [
                `https://www.google.com/maps?q=${lat},${lon}`,
                `https://ditu.amap.com/search?query=${lat},${lon}`,
                `https://map.baidu.com/?l=13&tn=B_NORMAL_MAP&c=13565782,3550688&s=bt%26c%3D1%26wd%3D${lat},${lon}`
            ];
            
            // 尝试打开第一个可用的地图服务
            const newWindow = window.open(urls[0], '_blank');
            if (!newWindow) {
                // 如果弹窗被阻止，显示链接
                const linkDiv = document.createElement('div');
                linkDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: white;
                    padding: 20px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 10001;
                    max-width: 400px;
                `;
                
                linkDiv.innerHTML = `
                    <h3 style="margin: 0 0 12px 0;">在外部地图中查看</h3>
                    <p style="margin: 0 0 12px 0;">位置: ${escapeHtml(decodeURIComponent(name))}</p>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <a href="${urls[0]}" target="_blank" style="padding: 8px 12px; background: #3b82f6; color: white; text-decoration: none; border-radius: 4px; text-align: center;">🌐 Google 地图</a>
                        <a href="${urls[1]}" target="_blank" style="padding: 8px 12px; background: #10b981; color: white; text-decoration: none; border-radius: 4px; text-align: center;">🗺️ 高德地图</a>
                        <a href="${urls[2]}" target="_blank" style="padding: 8px 12px; background: #f59e0b; color: white; text-decoration: none; border-radius: 4px; text-align: center;">📍 百度地图</a>
                        <button onclick="this.parentElement.parentElement.remove()" style="padding: 6px 12px; background: #6b7280; color: white; border: none; border-radius: 4px; cursor: pointer;">关闭</button>
                    </div>
                `;
                
                document.body.appendChild(linkDiv);
                
                // 5秒后自动关闭
                setTimeout(() => {
                    if (linkDiv.parentElement) {
                        linkDiv.remove();
                    }
                }, 5000);
            }
        };
        
        function switchView(viewName) {
            console.log('🔄 切换视图:', viewName);
            
            // 如果是共享视图但未登录，阻止切换
            if (viewName === 'shared' && !isLoggedIn) {
                showNotification('请先登录以查看共享日记', 'error');
                return;
            }
            
            // 更新导航标签
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            const targetTab = document.querySelector(`[data-view="${viewName}"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // 显示对应视图
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.add('active');
            }
            
            currentView = viewName;
            
            // 根据视图执行特定操作
            switch (viewName) {
                case 'gallery':
                    loadEntries();
                    break;
                case 'favorites':
                    loadFavorites();
                    break;
                case 'map':
                    setTimeout(() => {
                        if (map) {
                            map.invalidateSize();
                            updateMapMarkers();
                        }
                    }, 100);
                    break;
                case 'shared':
                    loadSharedDiaries();
                    break;
            }
        }
        
        // 为云端日记批量添加坐标
        async function addCoordinatesToCloudEntries() {
            if (!window.supabaseClient || !isLoggedIn) {
                alert('❌ 请先登录云端账户');
                return;
            }
            
            console.log('🗺️ 开始为云端日记批量添加坐标...');
            
            try {
                // 获取用户的所有日记
                const result = await window.supabaseClient.getUserDiaries();
                if (!result.success) {
                    throw new Error('获取云端日记失败: ' + result.error);
                }
                
                const entries = result.data;
                let updated = 0;
                
                console.log(`📊 检查 ${entries.length} 条云端日记...`);
                
                for (let i = 0; i < entries.length; i++) {
                    const entry = entries[i];
                    
                    // 如果已经有坐标，跳过
                    if (entry.latitude && entry.longitude) {
                        console.log(`✅ 跳过已有坐标的日记: ${entry.title?.substring(0, 20)}...`);
                        continue;
                    }
                    
                    // 尝试从位置名称获取坐标
                    if (entry.location) {
                        console.log(`🔍 为"${entry.location}"查找坐标...`);
                        
                        // 使用本地数据库搜索
                        const searchResults = searchLocalDatabase(entry.location);
                        if (searchResults && searchResults.length > 0) {
                            const bestMatch = searchResults[0];
                            
                            // 更新云端日记
                            const updateResult = await window.supabaseClient.updateDiary(entry.id, {
                                ...entry,
                                latitude: bestMatch.lat,
                                longitude: bestMatch.lon
                            });
                            
                            if (updateResult.success) {
                                updated++;
                                console.log(`✅ 更新云端日记坐标: ${entry.title} -> ${bestMatch.lat}, ${bestMatch.lon}`);
                            } else {
                                console.error(`❌ 更新云端日记坐标失败: ${entry.title}`, updateResult.error);
                            }
                        } else {
                            console.log(`❌ 未找到坐标: ${entry.location}`);
                        }
                    }
                }
                
                if (updated > 0) {
                    console.log(`🎉 成功为 ${updated} 条云端日记添加了坐标`);
                    
                    // 刷新地图标记
                    if (currentView === 'map') {
                        updateMapMarkers();
                    }
                    
                    return `成功为 ${updated} 条云端日记添加了坐标！`;
                } else {
                    console.log('ℹ️ 所有云端日记都已有坐标或无法找到匹配的坐标');
                    return '所有云端日记都已有坐标或无法找到匹配位置';
                }
                
            } catch (error) {
                console.error('❌ 批量添加云端坐标失败:', error);
                return '批量添加云端坐标失败: ' + error.message;
            }
        }
        
        // 暴露云端坐标添加函数
        window.addCoordinatesToCloudEntries = addCoordinatesToCloudEntries;
        
        // 批量为现有日记添加坐标的工具函数
        async function addCoordinatesToExistingEntries() {
            console.log('🗺️ 开始为现有日记批量添加坐标...');
            
            try {
                let entries = [];
                let updated = 0;
                
                // 从适当的存储系统获取数据
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储获取数据');
                    } catch (error) {
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                }
                
                console.log(`📊 检查 ${entries.length} 条日记...`);
                
                // 遍历所有日记，为没有坐标的条目添加坐标
                for (let i = 0; i < entries.length; i++) {
                    const entry = entries[i];
                    
                    // 如果已经有坐标，跳过
                    if (entry.latitude && entry.longitude) {
                        console.log(`✅ 跳过已有坐标的日记: ${entry.title?.substring(0, 20)}...`);
                        continue;
                    }
                    
                    // 尝试从位置名称获取坐标
                    if (entry.location) {
                        console.log(`🔍 为"${entry.location}"查找坐标...`);
                        
                        // 使用已有的本地数据库搜索功能
                        const searchResults = searchLocalDatabase(entry.location);
                        if (searchResults && searchResults.length > 0) {
                            const bestMatch = searchResults[0]; // 取最佳匹配
                            entry.latitude = bestMatch.lat;
                            entry.longitude = bestMatch.lon;
                            updated++;
                            console.log(`✅ 找到坐标: ${entry.location} -> ${bestMatch.lat}, ${bestMatch.lon} (${bestMatch.display_name})`);
                        } else {
                            console.log(`❌ 未找到坐标: ${entry.location}`);
                        }
                    }
                }
                
                if (updated > 0) {
                    // 保存更新后的数据
                    if (useIndexedDB && db) {
                        try {
                            await saveToIndexedDB('diaries', entries);
                            console.log('✅ 坐标已保存到大容量存储');
                        } catch (error) {
                            localStorage.setItem('travelDiary', JSON.stringify(entries));
                            console.log('✅ 坐标已保存到传统存储');
                        }
                    } else {
                        localStorage.setItem('travelDiary', JSON.stringify(entries));
                    }
                    
                    console.log(`🎉 成功为 ${updated} 条日记添加了坐标`);
                    
                    // 更新地图标记
                    if (currentView === 'map') {
                        updateMapMarkers();
                    }
                    
                    // 更新统计
                    updateStats();
                    
                    return `成功为 ${updated} 条日记添加了坐标！`;
                } else {
                    console.log('ℹ️ 所有日记都已有坐标或无法找到匹配的坐标');
                    return '所有日记都已有坐标或无法找到匹配位置';
                }
                
            } catch (error) {
                console.error('❌ 批量添加坐标失败:', error);
                return '批量添加坐标失败: ' + error.message;
            }
        }
        
        // 在控制台中暴露这个函数，方便手动执行
        window.addCoordinatesToExistingEntries = addCoordinatesToExistingEntries;
        
        // 检查缺少坐标的日记数量
        async function countEntriesWithoutCoordinates() {
            try {
                let entries = [];
                
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                    } catch (error) {
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                }
                
                const withoutCoords = entries.filter(e => !e.latitude || !e.longitude);
                console.log(`📊 统计结果: ${entries.length} 条日记中有 ${withoutCoords.length} 条缺少坐标`);
                
                return withoutCoords.length;
            } catch (error) {
                console.error('统计坐标失败:', error);
                return 0;
            }
        }
        
        // 暴露统计函数
        window.countEntriesWithoutCoordinates = countEntriesWithoutCoordinates;

        // 为相同位置的标记添加偏移以避免重叠
        function addMarkerOffset(latitude, longitude, usedPositions, offsetDistance = 0.002) {
            const posKey = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
            
            if (!usedPositions.has(posKey)) {
                usedPositions.set(posKey, 0);
                return { lat: latitude, lng: longitude };
            }
            
            // 增加该位置的使用计数
            const count = usedPositions.get(posKey) + 1;
            usedPositions.set(posKey, count);
            
            // 使用圆形排列算法，每个标记按圆形分布
            const radius = offsetDistance * (1 + Math.floor(count / 8) * 0.5); // 每8个标记增加一个圆圈
            const angle = (count % 8) * (Math.PI / 4); // 每个标记间隔45度
            
            const offsetLat = latitude + (Math.cos(angle) * radius);
            const offsetLng = longitude + (Math.sin(angle) * radius);
            
            console.log(`📍 位置偏移: ${posKey} -> ${offsetLat.toFixed(6)},${offsetLng.toFixed(6)} (第${count}个重叠标记，半径${radius.toFixed(4)})`);
            
            return { lat: offsetLat, lng: offsetLng };
        }

        // 检查同一位置的日记数量
        function getSameLocationCount(latitude, longitude, allEntries) {
            const posKey = `${latitude.toFixed(5)},${longitude.toFixed(5)}`;
            return allEntries.filter(entry => {
                if (!entry.latitude || !entry.longitude) return false;
                const entryPosKey = `${entry.latitude.toFixed(5)},${entry.longitude.toFixed(5)}`;
                return entryPosKey === posKey;
            }).length;
        }

        async function updateMapMarkers() {
            if (!map || !markersLayer) return;
            
            console.log('📍 更新地图标记...');
            
            // 清除现有标记
            markersLayer.clearLayers();
            
            // 用于跟踪已使用的位置
            const usedPositions = new Map();

            try {
                // 从适当的存储系统加载日记数据
                let entries = [];
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储加载地图标记数据');
                    } catch (error) {
                        console.error('从IndexedDB获取数据失败:', error);
                        // 回退到localStorage
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储加载地图标记数据');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 从传统存储加载地图标记数据');
                }
                
                // 添加本地日记标记
                console.log('📍 本地日记总数:', entries.length);
                entries.forEach((entry, index) => {
                    console.log(`📍 本地日记 ${index + 1}: "${entry.title}" - 坐标: ${entry.latitude}, ${entry.longitude}`);
                    
                    if (entry.latitude && entry.longitude) {
                        console.log(`✅ 为本地日记 "${entry.title}" 创建地图标记`);
                        
                        // 获取带偏移的位置
                        const offsetPos = addMarkerOffset(entry.latitude, entry.longitude, usedPositions);
                        const marker = L.marker([offsetPos.lat, offsetPos.lng]);
                        
                        // 创建弹出窗口内容
                        const offsetInfo = (offsetPos.lat !== entry.latitude || offsetPos.lng !== entry.longitude) ? 
                            ` <span style="color: #f59e0b; font-size: 0.75rem;" title="为避免重叠已微调位置">📍*</span>` : '';
                        const sameLocationCount = getSameLocationCount(entry.latitude, entry.longitude, entries);
                        const locationInfo = sameLocationCount > 1 ? 
                            ` <span style="color: #3b82f6; font-size: 0.75rem;" title="此地点共有${sameLocationCount}篇日记">(${sameLocationCount}篇)</span>` : '';
                        
                        const popupContent = `
                            <div style="max-width: 280px; min-width: 250px;">
                                <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 1rem;">${escapeHtml(entry.title)}</h3>
                                <p style="margin: 4px 0; color: #64748b; font-size: 0.875rem;">
                                    📅 ${formatDate(entry.date || entry.created_at)} | 📍 ${escapeHtml(entry.location)}${offsetInfo}${locationInfo} | 💻 ${useIndexedDB ? '大容量存储' : '本地存储'}
                                </p>
                                <p style="margin: 8px 0; color: #374151; line-height: 1.4; font-size: 0.875rem;">
                                    ${escapeHtml(entry.content.substring(0, 100))}${entry.content.length > 100 ? '...' : ''}
                                </p>
                                <div style="margin-top: 8px;">
                                    ${entry.tags && Array.isArray(entry.tags) ? entry.tags.map(tag => `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 4px;">${escapeHtml(tag)}</span>`).join('') : ''}
                                </div>
                                <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-start;">
                                    <button onclick="window.editEntry && window.editEntry('${entry.id}'); console.log('编辑按钮点击:', '${entry.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; flex-shrink: 0;">✏️ 编辑</button>
                                    <button onclick="window.toggleFavorite && window.toggleFavorite('${entry.id}'); console.log('收藏按钮点击:', '${entry.id}')" style="background: ${entry.favorited ? '#ef4444' : '#10b981'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; flex-shrink: 0;">${entry.favorited ? '💔 取消收藏' : '💝 收藏'}</button>
                                </div>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        markersLayer.addLayer(marker);
                    } else {
                        console.log(`❌ 本地日记 "${entry.title}" 缺少坐标信息 - 纬度: ${entry.latitude}, 经度: ${entry.longitude}`);
                    }
                });
                
                // 加载云端共享日记标记
                if (window.supabaseClient && isLoggedIn) {
                    try {
                        // 获取共享日记
                        const result = await window.supabaseClient.getAllDiaries();
                        
                        if (result.success) {
                            console.log('🗺️ 云端日记数据详情:', result.data);
                            
                            // 处理每个用户的共享日记
                            Object.values(result.data).forEach(userData => {
                                console.log(`👤 处理用户 ${userData.user?.nickname || '匿名'} 的日记:`, userData.entries);
                                
                                userData.entries.forEach((entry, index) => {
                                    console.log(`📍 日记 ${index + 1}: "${entry.title}" - 坐标: ${entry.latitude}, ${entry.longitude}`);
                                    
                                    if (entry.latitude && entry.longitude) {
                                        console.log(`✅ 为日记 "${entry.title}" 创建地图标记`);
                                        
                                        // 获取带偏移的位置
                                        const offsetPos = addMarkerOffset(entry.latitude, entry.longitude, usedPositions);
                                        
                                        // 创建不同颜色的标记以区分不同用户
                                        const customIcon = new L.Icon({
                                            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                                            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                                            iconSize: [25, 41],
                                            iconAnchor: [12, 41],
                                            popupAnchor: [1, -34],
                                            shadowSize: [41, 41]
                                        });
                                        
                                        const marker = L.marker([offsetPos.lat, offsetPos.lng], { icon: customIcon });
                                        
                                        // 创建弹出窗口内容
                                        const currentUser = window.supabaseClient?.getCurrentUser();
                                        const isOwner = currentUser && currentUser.id === entry.user_id;
                                        const offsetInfo = (offsetPos.lat !== entry.latitude || offsetPos.lng !== entry.longitude) ? 
                                            ` <span style="color: #f59e0b; font-size: 0.75rem;" title="为避免重叠已微调位置">📍*</span>` : '';
                                        
                                        const popupContent = `
                                            <div style="max-width: 280px; min-width: 250px;">
                                                <h3 style="margin: 0 0 8px 0; color: #1e293b; font-size: 1rem;">${escapeHtml(entry.title || '无标题')}</h3>
                                                <p style="margin: 4px 0; color: #64748b; font-size: 0.875rem;">
                                                    👤 ${escapeHtml(userData.user?.nickname || '匿名用户')} | 
                                                    📅 ${formatDate(entry.date || entry.created_at)} | 
                                                    📍 ${escapeHtml(entry.location || '未知位置')}${offsetInfo}
                                                </p>
                                                <p style="margin: 8px 0; color: #374151; line-height: 1.4; font-size: 0.875rem;">
                                                    ${escapeHtml(entry.content.substring(0, 100))}${entry.content.length > 100 ? '...' : ''}
                                                </p>
                                                <div style="margin-top: 8px;">
                                                    ${entry.tags && Array.isArray(entry.tags) ? entry.tags.map(tag => `<span style="background: #dbeafe; color: #1e40af; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; margin-right: 4px;">${escapeHtml(tag)}</span>`).join('') : ''}
                                                </div>
                                                ${isOwner ? `
                                                    <div style="margin-top: 12px; display: flex; gap: 8px; justify-content: flex-start;">
                                                        <button onclick="window.editCloudEntry && window.editCloudEntry('${entry.id}'); console.log('云端编辑按钮点击:', '${entry.id}')" style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; flex-shrink: 0;">✏️ 编辑</button>
                                                        <button onclick="window.confirmDeleteCloudEntry && window.confirmDeleteCloudEntry('${entry.id}'); console.log('云端删除按钮点击:', '${entry.id}')" style="background: #ef4444; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.75rem; cursor: pointer; flex-shrink: 0;">🗑️ 删除</button>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        `;
                                        
                                        marker.bindPopup(popupContent);
                                        markersLayer.addLayer(marker);
                                    } else {
                                        console.log(`❌ 日记 "${entry.title}" 缺少坐标信息 - 纬度: ${entry.latitude}, 经度: ${entry.longitude}`);
                                    }
                                });
                            });
                            
                            console.log('☁️ 添加了共享日记地图标记');
                        }
                    } catch (err) {
                        console.error('❌ 加载共享日记标记失败:', err);
                    }
                }
                
                // 如果有标记，调整地图视图以显示所有标记
                if (markersLayer.getLayers().length > 0) {
                    const group = new L.featureGroup(markersLayer.getLayers());
                    map.fitBounds(group.getBounds().pad(0.1));
                }
                
                // 统计信息
                const localMarkersCount = entries.filter(e => e.latitude && e.longitude).length;
                const cloudMarkersCount = markersLayer.getLayers().length - localMarkersCount;
                
                console.log(`📊 地图标记统计:`);
                console.log(`  📱 本地日记标记: ${localMarkersCount}`);
                console.log(`  ☁️ 云端日记标记: ${cloudMarkersCount}`);
                console.log(`  🗺️ 总标记数: ${markersLayer.getLayers().length}`);
                
                console.log(`✅ 添加了 ${markersLayer.getLayers().length} 个地图标记`);
                
            } catch (error) {
                console.error('❌ 更新地图标记失败:', error);
            }
        }
        
        function filterMapMarkers(filter) {
            console.log('🔍 过滤地图标记:', filter);
            
            if (!map || !markersLayer) return;
            
            // 清除现有标记
            markersLayer.clearLayers();
            
            // 用于跟踪已使用的位置
            const usedPositions = new Map();
            
            try {
                const entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                let filteredEntries = [];
                
                // 根据过滤条件筛选日记
                switch (filter) {
                    case 'all':
                        filteredEntries = entries;
                        break;
                    case 'recent':
                        // 显示最近30天的日记
                        const thirtyDaysAgo = new Date();
                        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                        filteredEntries = entries.filter(entry => {
                            const entryDate = new Date(entry.created_at || entry.date);
                            return entryDate >= thirtyDaysAgo;
                        });
                        break;
                    case 'favorites':
                        // 只显示收藏的日记
                        filteredEntries = entries.filter(entry => entry.favorited);
                        break;
                    default:
                        filteredEntries = entries;
                }
                
                // 在地图上添加标记
                filteredEntries.forEach(entry => {
                    if (entry.latitude && entry.longitude) {
                        // 获取带偏移的位置
                        const offsetPos = addMarkerOffset(entry.latitude, entry.longitude, usedPositions);
                        
                        const marker = L.marker([offsetPos.lat, offsetPos.lng])
                            .bindPopup(`
                                <div style="min-width: 200px;">
                                    <h4 style="margin: 0 0 8px 0; color: #1e293b;">
                                        ${entry.favorited ? '⭐ ' : ''}${escapeHtml(entry.title)}
                                    </h4>
                                    <p style="margin: 0 0 8px 0; color: #64748b; font-size: 0.875rem;">
                                        📅 ${formatDate(entry.created_at || entry.date)}<br>
                                        📍 ${escapeHtml(entry.location)}
                                    </p>
                                    <p style="margin: 0 0 8px 0; color: #374151; font-size: 0.875rem;">
                                        ${escapeHtml(entry.content.length > 80 ? entry.content.substring(0, 80) + '...' : entry.content)}
                                    </p>
                                    <div style="display: flex; flex-wrap: wrap; gap: 4px;">
                                        ${entry.tags.map(tag => `<span style="background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem;">${escapeHtml(tag)}</span>`).join('')}
                                    </div>
                                </div>
                            `);
                        
                        markersLayer.addLayer(marker);
                    }
                });
                
                console.log(`✅ 显示了 ${filteredEntries.length} 个标记 (过滤条件: ${filter})`);
                
            } catch (error) {
                console.error('❌ 过滤标记失败:', error);
            }
        }
        
        function locateUser() {
            console.log('📍 定位用户位置...');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        map.setView([lat, lng], 15);
                        
                        // 添加用户位置标记
                        const userMarker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup('📍 您的当前位置')
                            .openPopup();
                        
                        // 3秒后移除用户位置标记
                        setTimeout(() => {
                            map.removeLayer(userMarker);
                        }, 3000);
                        
                        console.log('✅ 定位成功');
                    },
                    function(error) {
                        console.error('❌ 定位失败:', error);
                        alert('❌ 定位失败，请检查浏览器位置权限设置');
                    }
                );
            } else {
                alert('❌ 您的浏览器不支持地理定位功能');
            }
        }
        
        function searchLocation() {
            const query = document.getElementById('location').value.trim();
            if (!query || query.length < 2) return;
            
            console.log('🔍 搜索位置:', query);
            
            // 首先尝试本地数据库匹配
            const localResults = searchLocalDatabase(query);
            
            if (localResults.length > 0) {
                displayLocationResults(localResults);
                return;
            }
            
            // 显示加载状态
            showLocationLoading();
            
            // 尝试多个地理编码服务（优先使用国内服务）
            const services = [
                {
                    name: '高德地理编码',
                    url: `https://restapi.amap.com/v3/geocode/geo?key=你的高德API密钥&address=${encodeURIComponent(query)}&output=json`,
                    timeout: 3000,
                    type: 'amap'
                },
                {
                    name: '百度地理编码',
                    url: `https://api.map.baidu.com/geocoding/v3/?address=${encodeURIComponent(query)}&output=json&ak=你的百度API密钥`,
                    timeout: 3000,
                    type: 'baidu'
                },
                {
                    name: 'Nominatim镜像',
                    url: `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&accept-language=zh-CN,zh,en&countrycodes=cn`,
                    timeout: 8000,
                    type: 'nominatim'
                }
            ];
            
            tryGeocodeServices(services, 0);
        }
        
        function searchLocalDatabase(query) {
            console.log('🔍 搜索本地数据库:', query);
            
            // 中国主要城市、建筑和景点数据库
            const localPlaces = [
                // 直辖市
                { name: '北京', lat: 39.9042, lon: 116.4074, type: '直辖市' },
                { name: '上海', lat: 31.2304, lon: 121.4737, type: '直辖市' },
                { name: '天津', lat: 39.3434, lon: 117.3616, type: '直辖市' },
                { name: '重庆', lat: 29.5630, lon: 106.5516, type: '直辖市' },
                
                // 省会城市
                { name: '广州', lat: 23.1291, lon: 113.2644, type: '广东省会' },
                { name: '深圳', lat: 22.5431, lon: 114.0579, type: '广东特区' },
                { name: '杭州', lat: 30.2741, lon: 120.1551, type: '浙江省会' },
                { name: '南京', lat: 32.0603, lon: 118.7969, type: '江苏省会' },
                { name: '武汉', lat: 30.5928, lon: 114.3055, type: '湖北省会' },
                { name: '成都', lat: 30.6624, lon: 104.0633, type: '四川省会' },
                { name: '西安', lat: 34.3416, lon: 108.9398, type: '陕西省会' },
                { name: '郑州', lat: 34.7466, lon: 113.6253, type: '河南省会' },
                { name: '济南', lat: 36.6512, lon: 117.1201, type: '山东省会' },
                { name: '青岛', lat: 36.0671, lon: 120.3826, type: '山东城市' },
                { name: '大连', lat: 38.9140, lon: 121.6147, type: '辽宁城市' },
                { name: '厦门', lat: 24.4798, lon: 118.0819, type: '福建城市' },
                { name: '昆明', lat: 25.0389, lon: 102.7183, type: '云南省会' },
                { name: '长沙', lat: 28.2282, lon: 112.9388, type: '湖南省会' },
                { name: '南昌', lat: 28.6820, lon: 115.8581, type: '江西省会' },
                { name: '合肥', lat: 31.8206, lon: 117.2272, type: '安徽省会' },
                { name: '石家庄', lat: 38.0428, lon: 114.5149, type: '河北省会' },
                { name: '太原', lat: 37.8706, lon: 112.5489, type: '山西省会' },
                { name: '沈阳', lat: 41.8057, lon: 123.4315, type: '辽宁省会' },
                { name: '长春', lat: 43.8171, lon: 125.3235, type: '吉林省会' },
                { name: '哈尔滨', lat: 45.8038, lon: 126.5346, type: '黑龙江省会' },
                { name: '福州', lat: 26.0745, lon: 119.2965, type: '福建省会' },
                { name: '海口', lat: 20.0444, lon: 110.1999, type: '海南省会' },
                { name: '三亚', lat: 18.2528, lon: 109.5007, type: '海南城市' },
                { name: '银川', lat: 38.4872, lon: 106.2309, type: '宁夏省会' },
                { name: '呼和浩特', lat: 40.8429, lon: 111.7517, type: '内蒙古省会' },
                { name: '乌鲁木齐', lat: 43.8256, lon: 87.6168, type: '新疆省会' },
                { name: '兰州', lat: 36.0611, lon: 103.8343, type: '甘肃省会' },
                { name: '西宁', lat: 36.6171, lon: 101.7782, type: '青海省会' },
                { name: '拉萨', lat: 29.6520, lon: 91.1722, type: '西藏省会' },
                { name: '贵阳', lat: 26.6470, lon: 106.6302, type: '贵州省会' },
                { name: '南宁', lat: 22.8167, lon: 108.3669, type: '广西省会' },
                
                // 太行山地区景点
                { name: '八路军太行纪念馆', lat: 36.8315, lon: 112.8547, type: '山西纪念馆', display_name: '八路军太行纪念馆，山西省长治市武乡县' },
                { name: '太行山', lat: 36.5, lon: 113.0, type: '山脉', display_name: '太行山脉' },
                { name: '武乡县', lat: 36.8392, lon: 112.8625, type: '山西县城', display_name: '武乡县，山西省长治市' },
                { name: '长治市', lat: 36.1951, lon: 113.1135, type: '山西城市', display_name: '长治市，山西省' },
                { name: '晋中市', lat: 37.6968, lon: 112.7533, type: '山西城市', display_name: '晋中市，山西省' },
                { name: '平遥古城', lat: 37.1987, lon: 112.1784, type: '山西古城', display_name: '平遥古城，山西省晋中市' },
                { name: '王家大院', lat: 37.1415, lon: 111.7600, type: '山西古建筑', display_name: '王家大院，山西省晋中市' },
                
                // 北京著名建筑
                { name: '万里长城', lat: 40.4319, lon: 116.5704, type: '北京古建筑' },
                { name: '故宫', lat: 39.9163, lon: 116.3972, type: '北京古建筑' },
                { name: '天安门', lat: 39.9055, lon: 116.3976, type: '北京地标' },
                { name: '颐和园', lat: 39.9998, lon: 116.2754, type: '北京园林' },
                { name: '天坛', lat: 39.8824, lon: 116.4066, type: '北京古建筑' },
                { name: '圆明园', lat: 40.0087, lon: 116.2973, type: '北京园林' },
                { name: '北海公园', lat: 39.9248, lon: 116.3883, type: '北京园林' },
                { name: '王府井', lat: 39.9097, lon: 116.4180, type: '北京商圈' },
                { name: '三里屯', lat: 39.9367, lon: 116.4556, type: '北京商圈' },
                { name: '国家体育场', lat: 39.9928, lon: 116.3906, type: '北京建筑' },
                { name: '鸟巢', lat: 39.9928, lon: 116.3906, type: '北京建筑' },
                { name: '水立方', lat: 39.9936, lon: 116.3894, type: '北京建筑' },
                { name: '国家大剧院', lat: 39.9038, lon: 116.3891, type: '北京建筑' },
                { name: '中央电视塔', lat: 39.9063, lon: 116.2950, type: '北京建筑' },
                { name: '北京大学', lat: 39.9990, lon: 116.3161, type: '北京高校' },
                { name: '清华大学', lat: 40.0003, lon: 116.3264, type: '北京高校' },
                
                // 上海著名建筑
                { name: '外滩', lat: 31.2396, lon: 121.4906, type: '上海地标' },
                { name: '东方明珠', lat: 31.2397, lon: 121.4999, type: '上海建筑' },
                { name: '上海中心大厦', lat: 31.2335, lon: 121.5056, type: '上海建筑' },
                { name: '金茂大厦', lat: 31.2346, lon: 121.5057, type: '上海建筑' },
                { name: '环球金融中心', lat: 31.2342, lon: 121.5062, type: '上海建筑' },
                { name: '豫园', lat: 31.2276, lon: 121.4917, type: '上海园林' },
                { name: '田子坊', lat: 31.2102, lon: 121.4752, type: '上海文创' },
                { name: '新天地', lat: 31.2195, lon: 121.4774, type: '上海商圈' },
                { name: '南京路', lat: 31.2340, lon: 121.4737, type: '上海商圈' },
                { name: '淮海路', lat: 31.2217, lon: 121.4594, type: '上海商圈' },
                { name: '上海迪士尼', lat: 31.1453, lon: 121.6669, type: '上海景点' },
                { name: '复旦大学', lat: 31.2989, lon: 121.5015, type: '上海高校' },
                { name: '上海交通大学', lat: 31.0206, lon: 121.4335, type: '上海高校' },
                
                // 广州著名建筑
                { name: '广州塔', lat: 23.1051, lon: 113.3240, type: '广州建筑' },
                { name: '小蛮腰', lat: 23.1051, lon: 113.3240, type: '广州建筑' },
                { name: '陈家祠', lat: 23.1258, lon: 113.2439, type: '广州古建筑' },
                { name: '沙面岛', lat: 23.1110, lon: 113.2364, type: '广州景点' },
                { name: '上下九步行街', lat: 23.1171, lon: 113.2467, type: '广州商圈' },
                { name: '北京路', lat: 23.1291, lon: 113.2644, type: '广州商圈' },
                { name: '珠江夜游', lat: 23.1088, lon: 113.2635, type: '广州景点' },
                
                // 深圳著名建筑
                { name: '平安金融中心', lat: 22.5376, lon: 114.0954, type: '深圳建筑' },
                { name: '京基100', lat: 22.5485, lon: 114.1094, type: '深圳建筑' },
                { name: '地王大厦', lat: 22.5485, lon: 114.1094, type: '深圳建筑' },
                { name: '深圳湾公园', lat: 22.4988, lon: 113.9412, type: '深圳公园' },
                { name: '华侨城', lat: 22.5351, lon: 113.9774, type: '深圳景点' },
                { name: '世界之窗', lat: 22.5351, lon: 113.9774, type: '深圳景点' },
                { name: '欢乐谷', lat: 22.5391, lon: 113.9823, type: '深圳景点' },
                
                // 杭州著名建筑
                { name: '西湖', lat: 30.2369, lon: 120.1488, type: '杭州景点' },
                { name: '雷峰塔', lat: 30.2316, lon: 120.1494, type: '杭州古建筑' },
                { name: '灵隐寺', lat: 30.2413, lon: 120.1011, type: '杭州古建筑' },
                { name: '六和塔', lat: 30.1989, lon: 120.1243, type: '杭州古建筑' },
                { name: '宋城', lat: 30.2123, lon: 120.0773, type: '杭州景点' },
                { name: '西溪湿地', lat: 30.2647, lon: 120.0534, type: '杭州自然景观' },
                
                // 南京著名建筑
                { name: '中山陵', lat: 32.0675, lon: 118.8484, type: '南京纪念建筑' },
                { name: '明孝陵', lat: 32.0571, lon: 118.8484, type: '南京古建筑' },
                { name: '夫子庙', lat: 32.0184, lon: 118.7934, type: '南京古建筑' },
                { name: '紫金山', lat: 32.0675, lon: 118.8484, type: '南京山岳' },
                { name: '玄武湖', lat: 32.0689, lon: 118.7969, type: '南京湖泊' },
                { name: '总统府', lat: 32.0426, lon: 118.7969, type: '南京历史建筑' },
                
                // 西安著名建筑
                { name: '兵马俑', lat: 34.3848, lon: 109.2734, type: '西安古迹' },
                { name: '大雁塔', lat: 34.2199, lon: 108.9641, type: '西安古建筑' },
                { name: '小雁塔', lat: 34.2421, lon: 108.9390, type: '西安古建筑' },
                { name: '古城墙', lat: 34.2658, lon: 108.9541, type: '西安古建筑' },
                { name: '钟楼', lat: 34.2658, lon: 108.9541, type: '西安古建筑' },
                { name: '鼓楼', lat: 34.2649, lon: 108.9517, type: '西安古建筑' },
                { name: '华清池', lat: 34.3622, lon: 109.2122, type: '西安景点' },
                { name: '大明宫', lat: 34.2997, lon: 108.9688, type: '西安古迹' },
                
                // 成都著名建筑
                { name: '宽窄巷子', lat: 30.6741, lon: 104.0633, type: '成都景点' },
                { name: '锦里', lat: 30.6500, lon: 104.0458, type: '成都景点' },
                { name: '武侯祠', lat: 30.6500, lon: 104.0458, type: '成都古建筑' },
                { name: '杜甫草堂', lat: 30.6591, lon: 104.0273, type: '成都古建筑' },
                { name: '青羊宫', lat: 30.6709, lon: 104.0438, type: '成都古建筑' },
                { name: '春熙路', lat: 30.6581, lon: 104.0810, type: '成都商圈' },
                { name: '天府广场', lat: 30.6624, lon: 104.0658, type: '成都地标' },
                { name: '大熊猫基地', lat: 30.7374, lon: 104.1469, type: '成都景点' },
                
                // 著名自然景观
                { name: '黄山', lat: 30.1347, lon: 118.1634, type: '安徽山岳' },
                { name: '泰山', lat: 36.2532, lon: 117.1011, type: '山东山岳' },
                { name: '华山', lat: 34.4883, lon: 110.0892, type: '陕西山岳' },
                { name: '峨眉山', lat: 29.6012, lon: 103.4845, type: '四川山岳' },
                { name: '九寨沟', lat: 33.2197, lon: 103.9244, type: '四川自然景观' },
                { name: '张家界', lat: 29.1174, lon: 110.4792, type: '湖南自然景观' },
                { name: '桂林', lat: 25.2736, lon: 110.2900, type: '广西山水' },
                { name: '丽江古城', lat: 26.8721, lon: 100.2240, type: '云南古城' },
                { name: '大理古城', lat: 25.6943, lon: 100.1674, type: '云南古城' },
                { name: '香格里拉', lat: 27.8269, lon: 99.7065, type: '云南景点' },
                { name: '千岛湖', lat: 29.6050, lon: 119.0364, type: '浙江湖泊' },
                { name: '鼓浪屿', lat: 24.4498, lon: 118.0642, type: '福建海岛' },
                { name: '武夷山', lat: 27.7563, lon: 117.9924, type: '福建山岳' },
                { name: '庐山', lat: 29.5733, lon: 115.9930, type: '江西山岳' },
                { name: '井冈山', lat: 26.7478, lon: 114.1593, type: '江西山岳' },
                { name: '黄果树瀑布', lat: 25.9779, lon: 105.6684, type: '贵州瀑布' },
                { name: '梵净山', lat: 27.9051, lon: 108.7009, type: '贵州山岳' },
                
                // 著名纪念馆和博物馆
                { name: '中国人民抗日战争纪念馆', lat: 39.8464, lon: 116.2365, type: '北京纪念馆' },
                { name: '国家博物馆', lat: 39.9034, lon: 116.3975, type: '北京博物馆' },
                { name: '首都博物馆', lat: 39.9063, lon: 116.3439, type: '北京博物馆' },
                { name: '上海博物馆', lat: 31.2276, lon: 121.4748, type: '上海博物馆' },
                { name: '中共一大会址', lat: 31.2207, lon: 121.4737, type: '上海纪念馆' },
                { name: '南京大屠杀纪念馆', lat: 32.0184, lon: 118.7625, type: '南京纪念馆' },
                { name: '陕西历史博物馆', lat: 34.2199, lon: 108.9641, type: '西安博物馆' },
                { name: '四川博物院', lat: 30.6741, lon: 104.0633, type: '成都博物馆' },
                { name: '湖南省博物馆', lat: 28.2282, lon: 112.9888, type: '长沙博物馆' },
                { name: '八路军总部旧址纪念馆', lat: 36.8392, lon: 112.8625, type: '山西纪念馆' },
                { name: '八路军太行纪念馆', lat: 36.8315, lon: 112.8547, type: '山西纪念馆' },
                
                // 著名机场和交通枢纽
                { name: '北京首都国际机场', lat: 40.0801, lon: 116.5846, type: '北京机场' },
                { name: '北京大兴国际机场', lat: 39.5090, lon: 116.4107, type: '北京机场' },
                { name: '上海浦东国际机场', lat: 31.1443, lon: 121.8083, type: '上海机场' },
                { name: '上海虹桥国际机场', lat: 31.1979, lon: 121.3364, type: '上海机场' },
                { name: '广州白云国际机场', lat: 23.3924, lon: 113.2988, type: '广州机场' },
                { name: '深圳宝安国际机场', lat: 22.6393, lon: 113.8107, type: '深圳机场' },
                { name: '成都双流国际机场', lat: 30.5785, lon: 103.9469, type: '成都机场' },
                { name: '西安咸阳国际机场', lat: 34.4471, lon: 108.7519, type: '西安机场' },
                { name: '杭州萧山国际机场', lat: 30.2295, lon: 120.4347, type: '杭州机场' },
                { name: '南京禄口国际机场', lat: 31.7420, lon: 118.8620, type: '南京机场' },
                
                // 高铁站
                { name: '北京南站', lat: 39.8651, lon: 116.3783, type: '北京高铁站' },
                { name: '上海虹桥站', lat: 31.1979, lon: 121.3200, type: '上海高铁站' },
                { name: '广州南站', lat: 22.9897, lon: 113.2733, type: '广州高铁站' },
                { name: '深圳北站', lat: 22.6083, lon: 114.0298, type: '深圳高铁站' },
                { name: '杭州东站', lat: 30.2906, lon: 120.2122, type: '杭州高铁站' },
                { name: '南京南站', lat: 31.9553, lon: 118.7134, type: '南京高铁站' },
                { name: '武汉站', lat: 30.6104, lon: 114.4260, type: '武汉高铁站' },
                { name: '成都东站', lat: 30.6984, lon: 104.1690, type: '成都高铁站' },
                { name: '西安北站', lat: 34.3708, lon: 108.8851, type: '西安高铁站' },
                
                // 著名购物中心和商圈
                { name: '王府井大街', lat: 39.9097, lon: 116.4180, type: '北京商圈' },
                { name: '西单', lat: 39.9056, lon: 116.3711, type: '北京商圈' },
                { name: '国贸', lat: 39.9070, lon: 116.4479, type: '北京商圈' },
                { name: '南京东路', lat: 31.2340, lon: 121.4737, type: '上海商圈' },
                { name: '徐家汇', lat: 31.1880, lon: 121.4366, type: '上海商圈' },
                { name: '陆家嘴', lat: 31.2397, lon: 121.4999, type: '上海商圈' },
                { name: '天河城', lat: 23.1291, lon: 113.3240, type: '广州商圈' },
                { name: '太古汇', lat: 23.1188, lon: 113.3240, type: '广州商圈' },
                { name: '万象城', lat: 22.5376, lon: 114.0954, type: '深圳商圈' },
                { name: '海岸城', lat: 22.4988, lon: 113.9412, type: '深圳商圈' },
                { name: '湖滨银泰', lat: 30.2521, lon: 120.1614, type: '杭州商圈' },
                { name: '德基广场', lat: 32.0426, lon: 118.7969, type: '南京商圈' },
                { name: 'IFS国际金融中心', lat: 30.6581, lon: 104.0810, type: '成都商圈' },
                { name: '小寨', lat: 34.2330, lon: 108.9540, type: '西安商圈' },
                
                // 著名酒店
                { name: '北京饭店', lat: 39.9097, lon: 116.4180, type: '北京酒店' },
                { name: '和平饭店', lat: 31.2396, lon: 121.4906, type: '上海酒店' },
                { name: '广州白天鹅宾馆', lat: 23.1110, lon: 113.2364, type: '广州酒店' },
                { name: '深圳香格里拉大酒店', lat: 22.5376, lon: 114.0954, type: '深圳酒店' },
                
                // 其他重要地标
                { name: '人民广场', lat: 31.2276, lon: 121.4748, type: '上海地标' },
                { name: '中山广场', lat: 38.9140, lon: 121.6147, type: '大连地标' },
                { name: '五四广场', lat: 36.0671, lon: 120.3826, type: '青岛地标' },
                { name: '解放碑', lat: 29.5630, lon: 106.5516, type: '重庆地标' },
                { name: '洪崖洞', lat: 29.5630, lon: 106.5516, type: '重庆景点' },
                { name: '磁器口', lat: 29.5630, lon: 106.5516, type: '重庆古镇' },
                { name: '九寨沟', lat: 33.2197, lon: 103.9249, type: '四川景点' },
                { name: '张家界', lat: 29.1174, lon: 110.4793, type: '湖南景点' },
                { name: '桂林', lat: 25.2342, lon: 110.1998, type: '广西山水' },
                { name: '阳朔', lat: 24.7697, lon: 110.4969, type: '广西山水' },
                { name: '丽江古城', lat: 26.8721, lon: 100.2240, type: '云南古城' },
                { name: '大理古城', lat: 25.6886, lon: 100.2417, type: '云南古城' },
                { name: '香格里拉', lat: 27.8269, lon: 99.7063, type: '云南景点' },
                
                // 现代建筑地标
                { name: '国际金融中心', lat: 31.2335, lon: 121.5056, type: '现代建筑' },
                { name: '环球贸易广场', lat: 22.3964, lon: 114.2095, type: '现代建筑' },
                { name: '台北101', lat: 25.0340, lon: 121.5645, type: '现代建筑' },
                { name: '东方之门', lat: 31.3076, lon: 120.6159, type: '现代建筑' },
                
                // 机场
                { name: '首都国际机场', lat: 40.0799, lon: 116.6031, type: '北京机场' },
                { name: '大兴国际机场', lat: 39.5098, lon: 116.4132, type: '北京机场' },
                { name: '浦东国际机场', lat: 31.1443, lon: 121.8083, type: '上海机场' },
                { name: '虹桥国际机场', lat: 31.1979, lon: 121.3364, type: '上海机场' },
                { name: '广州白云国际机场', lat: 23.3924, lon: 113.2988, type: '广州机场' },
                { name: '深圳宝安国际机场', lat: 22.6390, lon: 113.8106, type: '深圳机场' },
                
                // 高铁站
                { name: '北京南站', lat: 39.8649, lon: 116.3781, type: '北京高铁站' },
                { name: '上海虹桥站', lat: 31.1979, lon: 121.3171, type: '上海高铁站' },
                { name: '广州南站', lat: 22.9889, lon: 113.2741, type: '广州高铁站' },
                { name: '深圳北站', lat: 22.6089, lon: 114.0305, type: '深圳高铁站' }
            ];
            
            const results = localPlaces.filter(place => 
                place.name.toLowerCase().includes(query.toLowerCase()) ||
                query.toLowerCase().includes(place.name.toLowerCase()) ||
                place.type.toLowerCase().includes(query.toLowerCase())
            ).map(place => ({
                lat: place.lat,
                lon: place.lon,
                display_name: `${place.name}, ${place.type}`,
                importance: 1
            }));
            
            return results.slice(0, 8); // 增加返回结果数量
        }
        
        function tryGeocodeServices(services, index) {
            if (index >= services.length) {
                showLocationError('无法连接到地理编码服务，请检查网络连接或手动输入位置');
                return;
            }
            
            const service = services[index];
            console.log(`🌐 尝试服务: ${service.name}`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), service.timeout);
            
            fetch(service.url, { 
                signal: controller.signal,
                headers: {
                    'User-Agent': 'TravelDiary/1.0'
                }
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`✅ ${service.name} 搜索成功:`, data);
                
                // 处理不同服务的数据格式
                let results = [];
                
                if (service.type === 'amap') {
                    // 高德地图API响应格式
                    if (data.status === '1' && data.geocodes && data.geocodes.length > 0) {
                        results = data.geocodes.map(item => ({
                            lat: parseFloat(item.location.split(',')[1]),
                            lon: parseFloat(item.location.split(',')[0]),
                            display_name: `${item.formatted_address}, ${item.province} ${item.city} ${item.district}`,
                            importance: 0.8
                        }));
                    }
                } else if (service.type === 'baidu') {
                    // 百度地图API响应格式
                    if (data.status === 0 && data.result) {
                        results = [{
                            lat: data.result.location.lat,
                            lon: data.result.location.lng,
                            display_name: `${data.result.formatted_address}, ${data.result.addressComponent.province} ${data.result.addressComponent.city}`,
                            importance: 0.8
                        }];
                    }
                } else if (service.type === 'nominatim') {
                    // Nominatim API响应格式
                    results = Array.isArray(data) ? data : [];
                } else {
                    // 默认格式
                    results = Array.isArray(data) ? data : [];
                }
                
                if (results.length > 0) {
                    displayLocationResults(results);
                } else {
                    tryGeocodeServices(services, index + 1);
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.warn(`❌ ${service.name} 搜索失败:`, error.message);
                tryGeocodeServices(services, index + 1);
            });
        }
        
        function showLocationLoading() {
            const resultsDiv = document.getElementById('location-results');
            resultsDiv.innerHTML = `
                <div style="padding: 16px; text-align: center; color: #6b7280;">
                    <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #e5e7eb; border-top: 2px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite; margin-right: 8px;"></div>
                    正在搜索位置...
                </div>
                <style>
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                </style>
            `;
            resultsDiv.style.display = 'block';
        }
        
        function displayLocationResults(results) {
            const resultsDiv = document.getElementById('location-results');
            
            if (results.length === 0) {
                showLocationError('未找到相关位置');
                return;
            }
            
            const html = results.map(result => {
                const name = result.display_name;
                const shortName = name.split(',').slice(0, 3).join(', ');
                
                // 根据建筑类型选择图标
                const getIcon = (type) => {
                    if (type.includes('古建筑') || type.includes('古迹')) return '🏛️';
                    if (type.includes('现代建筑') || type.includes('大厦')) return '🏢';
                    if (type.includes('景点') || type.includes('公园')) return '🎯';
                    if (type.includes('高校') || type.includes('大学')) return '🎓';
                    if (type.includes('机场')) return '✈️';
                    if (type.includes('高铁站')) return '🚄';
                    if (type.includes('商圈')) return '🛍️';
                    if (type.includes('园林')) return '🌸';
                    if (type.includes('山岳') || type.includes('山水')) return '⛰️';
                    if (type.includes('湖泊')) return '🏞️';
                    if (type.includes('古城')) return '🏰';
                    if (type.includes('省会') || type.includes('直辖市')) return '🏙️';
                    return '📍';
                };
                
                const icon = getIcon(shortName);
                
                return `
                    <div style="padding: 12px; border-bottom: 1px solid #e5e7eb; cursor: pointer; transition: all 0.2s ease;" 
                         onmouseover="this.style.background='#f8fafc'; this.style.transform='translateX(4px)'" 
                         onmouseout="this.style.background='white'; this.style.transform='translateX(0px)'"
                         onclick="selectLocationFromResults('${result.lat}', '${result.lon}', \`${shortName.replace(/`/g, '\\`')}\`)">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 1.2rem;">${icon}</span>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: #374151; font-size: 0.95rem;">${escapeHtml(shortName.split(',')[0])}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">${escapeHtml(shortName.split(',').slice(1).join(', '))}</div>
                            </div>
                            <div style="color: #9ca3af; font-size: 0.75rem;">
                                ${parseFloat(result.lat).toFixed(4)}, ${parseFloat(result.lon).toFixed(4)}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        // 全局函数，供HTML onclick调用
        window.selectLocationFromResults = function(lat, lon, name) {
            console.log('📍 选择位置:', name, lat, lon);
            
            // 更新表单字段
            document.getElementById('location').value = name;
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            
            // 隐藏搜索结果
            document.getElementById('location-results').style.display = 'none';
            
            showSuccessMessage(`✅ 已选择位置: ${name}`);
        };
        
        function selectLocation(lat, lon, name) {
            return window.selectLocationFromResults(lat, lon, name);
        }
        
        function showLocationError(message) {
            const resultsDiv = document.getElementById('location-results');
            resultsDiv.innerHTML = `
                <div style="padding: 12px; color: #dc2626; text-align: center;">
                    ❌ ${message}
                </div>
                <div style="padding: 8px 12px; border-top: 1px solid #e5e7eb; text-align: center;">
                    <button onclick="document.getElementById('manual-location-btn').click()" 
                            style="background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.875rem;">
                        📝 改为手动添加位置
                    </button>
                </div>
            `;
            resultsDiv.style.display = 'block';
            
            setTimeout(() => {
                resultsDiv.style.display = 'none';
            }, 5000);
        }
        
        function toggleManualCoords() {
            const manualDiv = document.getElementById('manual-coords');
            const resultsDiv = document.getElementById('location-results');
            
            if (manualDiv.style.display === 'none' || !manualDiv.style.display) {
                manualDiv.style.display = 'block';
                resultsDiv.style.display = 'none';
                document.getElementById('manual-lat').focus();
            } else {
                manualDiv.style.display = 'none';
            }
        }
        
        function confirmManualCoords() {
            const lat = document.getElementById('manual-lat').value.trim();
            const lon = document.getElementById('manual-lon').value.trim();
            const location = document.getElementById('location').value.trim();
            
            if (!location) {
                alert('请先输入地点名称');
                document.getElementById('location').focus();
                return;
            }
            
            if (lat && lon) {
                const latNum = parseFloat(lat);
                const lonNum = parseFloat(lon);
                
                if (isNaN(latNum) || isNaN(lonNum)) {
                    alert('请输入有效的数字格式');
                    return;
                }
                
                if (latNum < -90 || latNum > 90) {
                    alert('纬度应该在 -90 到 90 之间');
                    return;
                }
                
                if (lonNum < -180 || lonNum > 180) {
                    alert('经度应该在 -180 到 180 之间');
                    return;
                }
                
                // 设置坐标
                document.getElementById('latitude').value = latNum;
                document.getElementById('longitude').value = lonNum;
                
                showSuccessMessage(`✅ 已设置位置: ${location} (${latNum}, ${lonNum})`);
            } else {
                // 只保存地点名称，不设置坐标
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                
                showSuccessMessage(`✅ 已设置位置: ${location} (无坐标)`);
            }
            
            // 隐藏手动输入框
            document.getElementById('manual-coords').style.display = 'none';
        }
        
        // 图片处理函数
        function handleImageUpload(files) {
            console.log('📷 处理图片上传:', files.length);
            
            const imagePreview = document.getElementById('image-preview');
            if (!imagePreview) return;
            
            Array.from(files).forEach(file => {
                // 检查文件类型
                if (!file.type.startsWith('image/')) {
                    alert('⚠️ 请选择图片文件');
                    return;
                }
                
                // 检查文件大小 (限制为5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('⚠️ 图片大小不能超过5MB');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const previewItem = document.createElement('div');
                    previewItem.className = 'image-preview-item';
                    previewItem.innerHTML = `
                        <img src="${e.target.result}" alt="预览图片">
                        <button class="image-remove-btn" onclick="removeImagePreview(this)">×</button>
                    `;
                    
                    imagePreview.appendChild(previewItem);
                    
                    // 添加进入动画
                    setTimeout(() => {
                        previewItem.style.opacity = '1';
                        previewItem.style.transform = 'scale(1)';
                    }, 10);
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        function removeImagePreview(button) {
            const previewItem = button.closest('.image-preview-item');
            previewItem.style.opacity = '0';
            previewItem.style.transform = 'scale(0.8)';
            
            setTimeout(() => {
                previewItem.remove();
            }, 200);
        }
        
        function openImageViewer(imageSrc) {
            const viewer = document.getElementById('image-viewer');
            const viewerImage = document.getElementById('viewer-image');
            
            if (viewer && viewerImage) {
                viewerImage.src = imageSrc;
                viewer.style.display = 'flex';
                
                // 添加淡入动画
                setTimeout(() => {
                    viewer.style.opacity = '1';
                }, 10);
            }
        }
        
        function closeImageViewer() {
            const viewer = document.getElementById('image-viewer');
            
            if (viewer) {
                viewer.style.opacity = '0';
                
                setTimeout(() => {
                    viewer.style.display = 'none';
                }, 300);
            }
        }
        
        // 为图片查看器添加键盘事件
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageViewer();
            }
        });
        
        // 点击查看器背景关闭
        document.addEventListener('click', function(e) {
            if (e.target.id === 'image-viewer') {
                closeImageViewer();
            }
        });
        
        // 删除功能相关变量
        let entryToDelete = null;
        let entryDeleteType = 'local'; // 'local' or 'cloud'
        
        // 确认删除日记
        // 确认删除云端日记
        async function confirmDeleteCloudEntry(entryId) {
            console.log('🗑️ 准备删除云端日记:', entryId);
            
            if (!window.supabaseClient) {
                alert('❌ 云端服务未连接');
                return;
            }
            
            try {
                // 获取云端日记详情
                const result = await window.supabaseClient.getDiary(entryId);
                
                if (!result.success) {
                    alert('❌ 获取日记详情失败: ' + result.error);
                    return;
                }
                
                const entry = result.data;
                
                // 检查是否是当前用户的日记
                const currentUser = window.supabaseClient.getCurrentUser();
                if (!currentUser || currentUser.id !== entry.user_id) {
                    alert('❌ 您只能删除自己的日记');
                    return;
                }
                
                // 保存要删除的条目ID和类型
                entryToDelete = entryId;
                entryDeleteType = 'cloud';
                
                // 更新确认对话框内容
                const message = document.getElementById('delete-message');
                message.innerHTML = `您确定要删除云端日记《<strong>${escapeHtml(entry.title)}</strong>》吗？<br>删除后将无法恢复。`;
                
                // 显示确认对话框
                const backdrop = document.getElementById('delete-backdrop');
                const confirmation = document.getElementById('delete-confirmation');
                
                backdrop.style.display = 'block';
                confirmation.style.display = 'block';
                
                // 添加淡入动画
                setTimeout(() => {
                    backdrop.style.opacity = '1';
                    confirmation.style.opacity = '1';
                    confirmation.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 10);
                
            } catch (error) {
                console.error('❌ 删除准备失败:', error);
                alert('❌ 删除操作失败: ' + error.message);
            }
        }

        async function confirmDeleteEntry(entryId) {
            console.log('🗑️ 准备删除日记:', entryId);
            
            try {
                let entries = [];
                
                // 从适当的存储系统获取数据
                if (useIndexedDB && db) {
                    try {
                        entries = await getFromIndexedDB('diaries');
                        console.log('📖 从大容量存储获取数据进行删除确认');
                    } catch (error) {
                        console.error('从IndexedDB获取数据失败:', error);
                        // 回退到localStorage
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 回退到传统存储获取数据');
                    }
                } else {
                    entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                    console.log('📖 从传统存储获取数据进行删除确认');
                }
                
                const entry = entries.find(e => e.id === entryId);
                
                if (!entry) {
                    alert('❌ 找不到要删除的日记');
                    return;
                }
                
                // 保存要删除的条目ID和类型
                entryToDelete = entryId;
                entryDeleteType = 'local';
                
                // 更新确认对话框内容
                const message = document.getElementById('delete-message');
                message.innerHTML = `您确定要删除日记《<strong>${escapeHtml(entry.title)}</strong>》吗？<br>删除后将无法恢复。`;
                
                // 显示确认对话框
                const backdrop = document.getElementById('delete-backdrop');
                const confirmation = document.getElementById('delete-confirmation');
                
                backdrop.style.display = 'block';
                confirmation.style.display = 'block';
                
                // 添加淡入动画
                setTimeout(() => {
                    backdrop.style.opacity = '1';
                    confirmation.style.opacity = '1';
                    confirmation.style.transform = 'translate(-50%, -50%) scale(1)';
                }, 10);
                
            } catch (error) {
                console.error('❌ 删除准备失败:', error);
                alert('❌ 删除操作失败');
            }
        }
        
        // 取消删除
        function cancelDeleteEntry() {
            console.log('❌ 取消删除操作');
            
            entryToDelete = null;
            entryDeleteType = 'local';
            hideDeleteConfirmation();
        }
        
        // 执行删除
        async function executeDeleteEntry() {
            if (!entryToDelete) {
                console.error('❌ 没有要删除的条目');
                return;
            }
            
            console.log('🗑️ 执行删除日记:', entryToDelete, '类型:', entryDeleteType);
            
            try {
                if (entryDeleteType === 'cloud') {
                    // 删除云端日记
                    if (!window.supabaseClient) {
                        alert('❌ 云端服务未连接');
                        return;
                    }
                    
                    const result = await window.supabaseClient.deleteDiary(entryToDelete);
                    
                    if (!result.success) {
                        alert('❌ 删除云端日记失败: ' + result.error);
                        return;
                    }
                    
                    // 隐藏确认对话框
                    hideDeleteConfirmation();
                    
                    // 显示成功消息
                    showSuccessMessage(`🗑️ 已删除云端日记`);
                    
                    // 添加删除动画效果
                    const entryCard = document.querySelector(`[data-entry-id="${entryToDelete}"]`);
                    if (entryCard) {
                        entryCard.style.transition = 'all 0.5s ease';
                        entryCard.style.transform = 'scale(0.8) rotateX(90deg)';
                        entryCard.style.opacity = '0';
                        
                        setTimeout(() => {
                            entryCard.remove();
                        }, 500);
                    }
                    
                    // 重新加载共享日记
                    setTimeout(() => {
                        loadSharedDiaries();
                    }, 600);
                    
                } else {
                    // 删除本地日记（支持大容量存储）
                    let entries = [];
                    let deletedEntry = null;
                    
                    // 从适当的存储系统获取数据
                    if (useIndexedDB && db) {
                        try {
                            entries = await getFromIndexedDB('diaries');
                            console.log('📖 从大容量存储获取数据进行删除');
                        } catch (error) {
                            console.error('从IndexedDB获取数据失败:', error);
                            // 回退到localStorage
                            entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                            console.log('📖 回退到传统存储获取数据');
                        }
                    } else {
                        entries = JSON.parse(localStorage.getItem('travelDiary') || '[]');
                        console.log('📖 从传统存储获取数据进行删除');
                    }
                    
                    const entryIndex = entries.findIndex(entry => entry.id === entryToDelete);
                    
                    if (entryIndex === -1) {
                        alert('❌ 找不到要删除的日记\n\n可能原因：\n• 数据正在同步中\n• 存储系统切换导致的临时问题\n\n建议：刷新页面后重试');
                        return;
                    }
                    
                    // 获取要删除的日记信息
                    deletedEntry = entries[entryIndex];
                    
                    // 从数组中删除
                    entries.splice(entryIndex, 1);
                    
                    // 保存到适当的存储系统
                    if (useIndexedDB && db) {
                        try {
                            // 删除IndexedDB中的特定条目
                            await deleteFromIndexedDB('diaries', entryToDelete);
                            console.log('✅ 从大容量存储删除成功');
                        } catch (error) {
                            console.error('从IndexedDB删除失败:', error);
                            alert('❌ 删除失败: ' + error.message);
                            return;
                        }
                    } else {
                        // 保存到localStorage
                        localStorage.setItem('travelDiary', JSON.stringify(entries));
                        console.log('✅ 从传统存储删除成功');
                    }
                    
                    // 隐藏确认对话框
                    hideDeleteConfirmation();
                    
                    // 显示成功消息
                    showSuccessMessage(`🗑️ 已删除日记《${deletedEntry.title}》`);
                    
                    // 添加删除动画效果
                    const entryCard = document.querySelector(`[data-entry-id="${entryToDelete}"]`);
                    if (entryCard) {
                        entryCard.style.transition = 'all 0.5s ease';
                        entryCard.style.transform = 'scale(0.8) rotateX(90deg)';
                        entryCard.style.opacity = '0';
                        
                        setTimeout(() => {
                            entryCard.remove();
                        }, 500);
                    }
                    
                    // 重新加载数据
                    setTimeout(() => {
                        loadEntries();
                        updateStats();
                        updateMapMarkers();
                        
                        // 如果当前在收藏视图，也要刷新收藏列表
                        if (currentView === 'favorites') {
                            loadFavorites();
                        }
                    }, 600);
                }
                
                // 清空待删除ID和类型
                entryToDelete = null;
                entryDeleteType = 'local';
                
                console.log('✅ 日记删除成功');
                
            } catch (error) {
                console.error('❌ 删除失败:', error);
                alert('❌ 删除失败: ' + error.message);
                
                // 清空待删除ID和类型
                entryToDelete = null;
                entryDeleteType = 'local';
            }
        }
        
        // 隐藏删除确认对话框
        function hideDeleteConfirmation() {
            const backdrop = document.getElementById('delete-backdrop');
            const confirmation = document.getElementById('delete-confirmation');
            
            if (backdrop && confirmation) {
                backdrop.style.opacity = '0';
                confirmation.style.opacity = '0';
                confirmation.style.transform = 'translate(-50%, -50%) scale(0.9)';
                
                setTimeout(() => {
                    backdrop.style.display = 'none';
                    confirmation.style.display = 'none';
                }, 300);
            }
        }
        
        // 为删除确认对话框添加键盘事件
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const deleteConfirmation = document.getElementById('delete-confirmation');
                if (deleteConfirmation && deleteConfirmation.style.display === 'block') {
                    cancelDeleteEntry();
                }
            }
        });
        
        // 点击背景关闭删除确认对话框
        document.addEventListener('click', function(e) {
            if (e.target.id === 'delete-backdrop') {
                cancelDeleteEntry();
            }
        });
        
        // 暴露函数到全局作用域以供地图弹出窗口使用
        window.editEntry = editEntry;
        window.editCloudEntry = editCloudEntry;
        window.toggleFavorite = toggleFavorite;
        window.confirmDeleteCloudEntry = confirmDeleteCloudEntry;
        
        console.log('📝 脚本加载完成');
    </script>
</body>
</html>
