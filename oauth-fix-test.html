<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth 修复验证</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .code {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>🔧 OAuth 登录修复验证</h1>
    
    <div class="info">
        <h3>📋 当前状态检查</h3>
        <p id="current-url"><strong>当前URL:</strong> <span id="url-display"></span></p>
        <p id="url-params"><strong>URL参数:</strong> <span id="params-display"></span></p>
        <p id="error-check"><strong>错误检测:</strong> <span id="error-display"></span></p>
    </div>

    <div class="warning">
        <h3>⚠️ 主要问题：GitHub OAuth配置错误</h3>
        <p>根据错误日志分析，主要问题是GitHub OAuth应用的回调URL配置错误。</p>
        
        <h4>需要修复的配置：</h4>
        <div class="code">
            <strong>GitHub OAuth应用设置位置：</strong><br>
            https://github.com/settings/applications/2803708
            <br><br>
            <strong>当前错误的 Authorization callback URL:</strong><br>
            ❌ https://leo-610.github.io/digital-travel-diary
            <br><br>
            <strong>应该修改为正确的回调URL:</strong><br>
            ✅ https://muawpgjdzoxhkpxghuvt.supabase.co/auth/v1/callback
        </div>
    </div>

    <div class="info">
        <h3>🔄 OAuth流程说明</h3>
        <ol>
            <li><strong>用户点击GitHub登录</strong> → 重定向到GitHub授权页面</li>
            <li><strong>用户授权</strong> → GitHub回调到Supabase端点处理授权码</li>
            <li><strong>Supabase处理</strong> → 创建用户会话并重定向回网站</li>
            <li><strong>登录完成</strong> → 用户在网站上看到登录状态</li>
        </ol>
        <p><strong>关键点：</strong>GitHub的回调URL必须指向Supabase的认证端点，不是用户网站！</p>
    </div>

    <div class="success">
        <h3>✅ 已实施的修复</h3>
        <ul>
            <li>添加了OAuth错误检测和用户友好的错误提示</li>
            <li>改进了GitHub登录方法的调试信息</li>
            <li>自动清理URL中的错误参数</li>
            <li>创建了详细的修复指南</li>
        </ul>
    </div>

    <div class="warning">
        <h3>🛠️ 立即行动步骤</h3>
        <ol>
            <li><button onclick="window.open('https://github.com/settings/applications/2803708', '_blank')">打开GitHub OAuth应用设置</button></li>
            <li>找到 "Authorization callback URL" 字段</li>
            <li>将URL从 <code>https://leo-610.github.io/digital-travel-diary</code> 修改为 <code>https://muawpgjdzoxhkpxghuvt.supabase.co/auth/v1/callback</code></li>
            <li>点击 "Update application" 保存</li>
            <li><button onclick="window.open('https://leo-610.github.io/digital-travel-diary', '_blank')">测试GitHub登录</button></li>
        </ol>
    </div>

    <script>
        // 显示当前URL信息
        document.getElementById('url-display').textContent = window.location.href;
        
        // 检查URL参数
        const urlParams = new URLSearchParams(window.location.search);
        const params = [];
        for (let [key, value] of urlParams) {
            params.push(`${key}=${value}`);
        }
        document.getElementById('params-display').textContent = params.length > 0 ? params.join(', ') : '无';
        
        // 检查是否有OAuth错误
        const error = urlParams.get('error');
        const errorDescription = urlParams.get('error_description');
        
        if (error) {
            document.getElementById('error-display').innerHTML = `
                <span style="color: #dc3545;">❌ 检测到错误</span><br>
                <strong>错误类型：</strong> ${error}<br>
                <strong>错误描述：</strong> ${errorDescription || '未知错误'}
            `;
            
            if (error === 'server_error' && errorDescription?.includes('Unable to exchange external code')) {
                document.getElementById('error-display').innerHTML += `
                    <br><br><strong style="color: #dc3545;">🎯 这正是GitHub OAuth回调URL配置错误导致的！</strong>
                `;
            }
        } else {
            document.getElementById('error-display').innerHTML = '<span style="color: #28a745;">✅ 无错误检测</span>';
        }
        
        // 如果有错误参数，显示清理按钮
        if (error) {
            const cleanBtn = document.createElement('button');
            cleanBtn.textContent = '清理URL参数';
            cleanBtn.onclick = function() {
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
                location.reload();
            };
            document.getElementById('error-check').appendChild(cleanBtn);
        }
    </script>
</body>
</html>
